<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Rice Yield System</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
        #map { height: 500px; width: 100%; border-radius: 8px; border: 2px solid #ddd; }
        .control-panel { margin-top: 20px; padding: 20px; background: #f9f9f9; border-radius: 8px; }
        button { padding: 10px 20px; cursor: pointer; background: #28a745; color: white; border: none; border-radius: 4px; }
        button:hover { background: #218838; }
        .result-box { margin-top: 15px; font-size: 1.2em; font-weight: bold; }
    </style>
</head>
<body>
    <h2>üåæ ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏Ç‡πâ‡∏≤‡∏ß‡∏à‡∏≤‡∏Å‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° (Sentinel-2)</h2>
    <p>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: {{ request.user.username }} | <a href="/admin/logout/">Logout</a></p>

    <div id="map"></div>

    <div class="control-panel">
        <h3>1. ‡∏ß‡∏≤‡∏î‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
        <input type="text" id="fieldName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏õ‡∏•‡∏á A)" style="padding: 8px; width: 200px;">
        <button onclick="saveField()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤</button>

        <hr>

        <h3>2. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï</h3>
        <p>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: <span id="areaDisplay">-</span> ‡πÑ‡∏£‡πà</p>
        <button onclick="calculateYield()" style="background: #007bff;">üõ∞Ô∏è ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï (NDVI)</button>
        
        <div class="result-box" id="resultDisplay"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        // 1. Setup Map
        var map = L.map('map').setView([19.0, 99.9], 10); // ‡∏û‡∏∞‡πÄ‡∏¢‡∏≤
        L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{
            maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3']
        }).addTo(map);

        // 2. Setup Draw Control
        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        var drawControl = new L.Control.Draw({
            draw: { polygon: true, marker: false, circle: false, rectangle: false, polyline: false },
            edit: { featureGroup: drawnItems }
        });
        map.addControl(drawControl);

        var currentLayer = null;
        var currentFieldId = null;

        map.on(L.Draw.Event.CREATED, function (e) {
            drawnItems.clearLayers();
            currentLayer = e.layer;
            drawnItems.addLayer(currentLayer);
        });

        // 3. Functions
        function saveField() {
            if (!currentLayer) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏î‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤‡∏Å‡πà‡∏≠‡∏ô!");
            var geojson = currentLayer.toGeoJSON();
            
            axios.post('/api/fields/', {
                name: document.getElementById('fieldName').value,
                geometry: geojson.geometry
            }, { headers: {'X-CSRFToken': '{{ csrf_token }}'} })
            .then(res => {
                currentFieldId = res.data.id;
                document.getElementById('areaDisplay').innerText = res.data.area;
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤‡πÅ‡∏•‡πâ‡∏ß! ID: " + currentFieldId);
            })
            .catch(err => alert("Error: " + err));
        }

        function calculateYield() {
            if (!currentFieldId) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì");
            document.getElementById('resultDisplay').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";
            
            axios.post(`/api/fields/${currentFieldId}/calculate/`, {}, 
                { headers: {'X-CSRFToken': '{{ csrf_token }}'} })
            .then(res => {
                document.getElementById('resultDisplay').innerHTML = `
                    <span style="color: green;">
                        NDVI: ${res.data.ndvi} <br>
                        ‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï: ${res.data.yield} ‡∏ï‡∏±‡∏ô
                    </span>
                `;
            })
            .catch(err => {
                document.getElementById('resultDisplay').innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + (err.response.data.error || err);
            });
        }
    </script>
</body>
</html>