{% extends 'base.html' %}
{% block content %}
<div class="flex flex-col gap-6 lg:h-[calc(100vh-100px)] h-auto pb-10 lg:pb-0">
    
    <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative z-20">
        <div>
            <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fa-solid fa-industry text-blue-600"></i> ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÇ‡∏£‡∏á‡∏™‡∏µ (‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡πâ‡∏≤‡∏ß)
            </h1>
            <p class="text-sm text-gray-500 mt-1">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</p>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="relative">
                <button onclick="toggleNotif()" class="p-2.5 rounded-full hover:bg-gray-100 transition relative focus:outline-none group">
                    <i class="fa-solid fa-bell text-gray-500 text-xl group-hover:text-blue-600 transition-colors"></i>
                    <span id="notif-badge" class="absolute top-0 right-0 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden border-2 border-white transform translate-x-1 -translate-y-1 shadow-sm animate-pulse">0</span>
                </button>

                <div id="notif-dropdown" class="hidden absolute right-0 mt-4 w-96 bg-white rounded-xl shadow-2xl border border-gray-100 overflow-hidden z-50 animate-fade-in-up origin-top-right">
                    <div class="bg-gradient-to-r from-blue-50 to-white px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                        <span class="text-sm font-bold text-gray-700">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span>
                        <span class="text-xs text-blue-500 cursor-pointer hover:text-blue-700" onclick="markAllRead()">‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                    </div>
                    <div id="notif-list-container" class="max-h-80 overflow-y-auto custom-scrollbar bg-white p-0">
                    </div>
                </div>
            </div>

            <div class="bg-blue-50 text-blue-700 px-4 py-2 rounded-lg border border-blue-100 shadow-sm flex items-center">
                <span class="text-sm font-bold mr-2">üõí ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠:</span>
                <span id="sale-count" class="text-xl font-bold">0</span> 
                <span class="text-xs ml-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 flex-grow lg:overflow-hidden h-auto">
        
        <div class="lg:col-span-4 bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col h-[500px] lg:h-full overflow-hidden relative z-10 order-2 lg:order-1">
            <div class="p-4 border-b border-gray-100 bg-gray-50/50 backdrop-blur flex justify-between items-center">
                <h3 class="font-bold text-gray-700 flex items-center">
                    <i class="fa-solid fa-bullhorn text-orange-500 mr-2"></i> ‡∏ï‡∏•‡∏≤‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏Ç‡πâ‡∏≤‡∏ß
                </h3>
                <div class="flex gap-2 text-[10px]">
                    <span class="bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full">‡∏£‡∏≠‡∏ã‡∏∑‡πâ‡∏≠</span>
                    <span class="bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full">‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>
                </div>
            </div>
            
            <div class="overflow-y-auto flex-grow p-4 space-y-3 custom-scrollbar relative" id="saleList">
                <div class="flex flex-col items-center justify-center h-40 text-gray-400 space-y-2">
                    <i class="fa-solid fa-circle-notch fa-spin text-2xl text-blue-200"></i>
                    <p class="text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                </div>
            </div>
            <div class="absolute bottom-0 left-0 w-full h-12 bg-gradient-to-t from-white to-transparent pointer-events-none"></div>
        </div>

        <div class="lg:col-span-8 bg-white rounded-2xl shadow-sm border border-gray-100 h-[400px] lg:h-full relative flex flex-col group overflow-hidden order-1 lg:order-2">
            <div class="absolute top-4 left-4 z-[400] bg-white/95 backdrop-blur px-4 py-2 rounded-xl shadow-md border border-gray-200 pointer-events-none">
                <h2 class="text-sm font-bold text-gray-800 flex items-center gap-2">
                    <i class="fa-solid fa-map-location-dot text-blue-600"></i> ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤
                </h2>
            </div>
            <div id="map" class="w-full h-full rounded-2xl z-0 bg-slate-100"></div>
        </div>
    </div>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f8fafc; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
    .animate-fade-in-up { animation: fadeInUp 0.2s cubic-bezier(0.16, 1, 0.3, 1); }

    .swal2-popup { border-radius: 16px !important; padding: 1.5rem !important; font-family: 'Sarabun', sans-serif; }
</style>
{% endblock %}

{% block scripts %}
<script>
    // ==========================================
    // 0. Global & Setup
    // ==========================================
    const currentUserId = {{ request.user.id }}; 
    
    var map = L.map('map', { center:[19.1667, 99.9000], zoom:13, zoomControl: false });
    L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{maxZoom:20,subdomains:['mt0','mt1','mt2','mt3']}).addTo(map);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    var markers = L.featureGroup().addTo(map);
    let lastReadTime = new Date(localStorage.getItem('millerLastRead') || 0);
    let allSalesData = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î

    window.addEventListener('resize', function() { setTimeout(function(){ map.invalidateSize(); }, 300); });

    // ==========================================
    // 1. Main Data Loop
    // ==========================================
    async function loadData() {
        try {
            const res = await fetch('/api/sales/');
            const sales = await res.json();
            allSalesData = sales; // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global
            
            const listDiv = document.getElementById('saleList');
            const countSpan = document.getElementById('sale-count');
            
            const openSales = sales.filter(s => s.status === 'OPEN').sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
            const myRequests = sales.filter(s => s.status === 'REQUESTED').sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
            const soldSales = sales.filter(s => s.status === 'SOLD').sort((a,b) => new Date(b.sold_at || b.created_at) - new Date(a.sold_at || a.created_at));

            const displayList = [...myRequests, ...openSales, ...soldSales];

            // Notification Logic
            const newOpenItems = openSales.filter(s => new Date(s.created_at) > lastReadTime);
            const newApprovedItems = soldSales.filter(s => s.sold_at && new Date(s.sold_at) > lastReadTime);
            updateNotificationUI(newOpenItems, newApprovedItems);

            listDiv.innerHTML = '';
            markers.clearLayers();
            countSpan.innerText = openSales.length; 

            if (displayList.length === 0) {
                listDiv.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-400 opacity-60 mt-10"><i class="fa-solid fa-basket-shopping text-5xl mb-3"></i><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</p></div>`;
                return;
            }

            displayList.forEach(s => {
                const isRequested = s.status === 'REQUESTED';
                const isSold = s.status === 'SOLD';
                const totalPrice = (s.quantity_ton * s.price_per_ton).toLocaleString();
                const pricePerTon = parseFloat(s.price_per_ton).toLocaleString();
                const datePost = new Date(s.created_at).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' });
                const fieldArea = s.field_area ? s.field_area : '-';

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Google Maps Link
                let mapsLink = '#';
                if (s.field_lat && s.field_lng) {
                    mapsLink = `https://www.google.com/maps/dir/?api=1&destination=${s.field_lat},${s.field_lng}`;
                }

                let borderClass = "border-l-4 border-l-orange-500";
                let badgeStatus = `<span class="bg-orange-100 text-orange-700 text-[10px] px-2 py-0.5 rounded-full font-bold animate-pulse">‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</span>`;
                let actionBtn = `
                    <div class="grid grid-cols-5 gap-2">
                        <button onclick="viewFullDetails(${s.id})" class="col-span-1 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg flex items-center justify-center" title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"><i class="fa-solid fa-eye"></i></button>
                        <button onclick="confirmBuy(event, ${s.id})" class="col-span-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg shadow transition-colors flex items-center justify-center gap-2"><i class="fa-solid fa-handshake"></i> ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠</button>
                    </div>`;
                let mapColor = '#f97316'; 
                let mapOpacity = 0.6;

                if (isRequested) {
                    borderClass = "border-l-4 border-l-yellow-400 bg-yellow-50/30";
                    badgeStatus = `<span class="bg-yellow-100 text-yellow-700 text-[10px] px-2 py-0.5 rounded-full font-bold"><i class="fa-solid fa-clock"></i> ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>`;
                    actionBtn = `
                        <div class="grid grid-cols-5 gap-2">
                            <button onclick="viewFullDetails(${s.id})" class="col-span-1 bg-white hover:bg-gray-100 text-gray-600 border border-gray-200 rounded-lg flex items-center justify-center"><i class="fa-solid fa-eye"></i></button>
                            <button class="col-span-4 bg-yellow-100 text-yellow-600 font-bold py-2 rounded-lg cursor-not-allowed border border-yellow-200" disabled><i class="fa-solid fa-hourglass-half"></i> ‡∏£‡∏≠‡∏ä‡∏≤‡∏ß‡∏ô‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô...</button>
                        </div>`;
                    mapColor = '#eab308';
                } 
                else if (isSold) {
                    borderClass = "border-gray-300 opacity-70 grayscale-[50%]";
                    badgeStatus = `<span class="bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded-full font-bold"><i class="fa-solid fa-check"></i> ‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>`;
                    actionBtn = `<button onclick="viewFullDetails(${s.id})" class="w-full bg-gray-100 text-gray-500 font-bold py-2 rounded-lg hover:bg-gray-200 hover:text-gray-700 transition"><i class="fa-solid fa-file-invoice"></i> ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</button>`;
                    mapColor = '#22c55e';
                    mapOpacity = 0.4;
                }

                const isNew = !isSold && !isRequested && new Date(s.created_at) > lastReadTime;
                const newBadge = isNew ? `<span class="ml-2 bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded font-bold animate-bounce shadow-sm">NEW</span>` : '';

                listDiv.innerHTML += `
                    <div class="bg-white border border-gray-200 p-4 rounded-xl shadow-sm hover:shadow-md transition-all cursor-pointer group relative overflow-hidden ${borderClass} mb-3" onclick="focusMap(${s.id})">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                                    <i class="fa-solid fa-user-circle text-gray-400"></i> ${s.farmer_name} ${newBadge}
                                </h4>
                                <p class="text-xs text-gray-500 flex items-center gap-1"><i class="fa-solid fa-clock"></i> ${datePost} ${badgeStatus}</p>
                            </div>
                            <span class="bg-green-50 text-green-700 border border-green-100 text-xs font-bold px-2 py-1 rounded-lg">${s.quantity_ton} ‡∏ï‡∏±‡∏ô</span>
                        </div>
                        <div class="bg-white p-3 rounded-lg border border-dashed border-gray-200 text-sm space-y-1 mb-3">
                            <div class="flex justify-between"><span class="text-gray-500">‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Ç‡πâ‡∏≤‡∏ß:</span><span class="font-semibold text-blue-600">${s.variety_display}</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà:</span><span class="font-semibold text-gray-700">${fieldArea} ‡πÑ‡∏£‡πà</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ï‡∏±‡∏ô:</span><span class="font-semibold">${pricePerTon} ‡∏ö.</span></div>
                            <div class="flex justify-between border-t border-gray-100 pt-1 mt-1"><span class="text-gray-700 font-bold">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°:</span><span class="font-bold text-green-600 text-lg">${totalPrice} ‡∏ö.</span></div>
                        </div>
                        ${actionBtn}
                    </div>
                `;

                if(s.field_location) {
                    try {
                        const geoJson = JSON.parse(s.field_location);
                        const layer = L.geoJSON(geoJson, { style:{color: mapColor, fillOpacity: mapOpacity, weight: 2} })
                            .bindPopup(`
                                <div class="text-center min-w-[160px] p-1 font-sans">
                                    <b class="text-base text-gray-900 block mb-1">${s.farmer_name}</b>
                                    <span class="font-black text-lg block mb-1" style="color:${mapColor}">
                                        ${s.status === 'SOLD' ? '‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : (s.status === 'REQUESTED' ? '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : s.quantity_ton + ' ‡∏ï‡∏±‡∏ô')}
                                    </span>
                                    <span class="text-xs text-gray-500 block mb-3">${s.variety_display} (${fieldArea} ‡πÑ‡∏£‡πà)</span>
                                    
                                    <div class="flex gap-2 mt-1">
                                        <button onclick="viewFullDetails(${s.id})" 
                                            class="flex-1 bg-gray-800 hover:bg-gray-900 text-white text-xs font-bold py-2 rounded-lg shadow transition-colors">
                                            ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                        </button>
                                        
                                        <a href="${mapsLink}" target="_blank" 
                                            class="flex-1 bg-blue-600 hover:bg-blue-700 !text-white text-xs font-bold py-2 rounded-lg shadow flex items-center justify-center gap-1 transition-transform hover:scale-105">
                                            <i class="fa-solid fa-location-arrow"></i> ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á
                                        </a>
                                    </div>
                                </div>
                            `);
                        layer.saleId = s.id;
                        markers.addLayer(layer);
                    } catch(e){}
                }
            });

        } catch(e) { console.error("Load Data Error:", e); }
    }

    // ==========================================
    // 2. View Full Details (Modal)
    // ==========================================
    window.viewFullDetails = function(saleId) {
        event.stopPropagation();
        const s = allSalesData.find(item => item.id === saleId);
        if(!s) return;

        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
        const farmerPhone = s.farmer_phone || '-';
        const farmerLine = s.farmer_line || '-';
        const farmerAddress = s.farmer_address || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà';
        const farmerBio = s.farmer_bio || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏±‡∏ß';
        
        // Google Maps Link
        let mapsLink = '#';
        let mapsBtnClass = 'bg-gray-300 text-gray-500 cursor-not-allowed';
        if (s.field_lat && s.field_lng) {
            mapsLink = `https://www.google.com/maps/dir/?api=1&destination=${s.field_lat},${s.field_lng}`;
            mapsBtnClass = 'bg-blue-600 hover:bg-blue-700 text-white shadow-lg shadow-blue-200';
        }
        
        Swal.fire({
            title: '',
            html: `
                <div class="text-left">
                    <div class="flex items-center gap-4 border-b pb-4 mb-4">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center text-3xl text-gray-400">
                            <i class="fa-solid fa-user"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">${s.farmer_name}</h2>
                            <span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-lg border border-green-200 font-bold">‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="flex border-b border-gray-200">
                            <button id="tab-profile" class="flex-1 py-2 text-sm font-bold text-blue-600 border-b-2 border-blue-600 transition-colors">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</button>
                            <button id="tab-field" class="flex-1 py-2 text-sm font-bold text-gray-400 hover:text-gray-600 transition-colors">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤</button>
                        </div>
                    </div>

                    <div id="content-profile" class="space-y-3 text-sm animate-fade-in-up">
                        <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                            <p class="text-xs text-blue-500 font-bold mb-1 uppercase">‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</p>
                            <p class="text-gray-700">${farmerBio}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <p class="text-xs text-gray-400">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</p>
                                <p class="font-bold text-gray-800"><i class="fa-solid fa-phone text-green-500"></i> <a href="tel:${farmerPhone}">${farmerPhone}</a></p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <p class="text-xs text-gray-400">Line ID</p>
                                <p class="font-bold text-gray-800"><i class="fa-brands fa-line text-green-500"></i> ${farmerLine}</p>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-400">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà / ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏ü‡∏≤‡∏£‡πå‡∏°</p>
                            <p class="font-bold text-gray-800"><i class="fa-solid fa-location-dot text-red-500"></i> ${farmerAddress}</p>
                        </div>
                    </div>

                    <div id="content-field" class="hidden space-y-3 text-sm animate-fade-in-up">
                        <div class="bg-orange-50 p-3 rounded-lg border border-orange-100 mb-2">
                             <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-xs text-orange-500 font-bold uppercase">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤</p>
                                    <p class="font-bold text-gray-800 text-lg">${s.field_name}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-gray-500">‡∏Ç‡∏ô‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</p>
                                    <p class="font-bold text-gray-800">${s.field_area} ‡πÑ‡∏£‡πà</p>
                                </div>
                             </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-white border p-3 rounded-lg text-center">
                                <p class="text-xs text-gray-400">‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Ç‡πâ‡∏≤‡∏ß</p>
                                <p class="font-bold text-blue-600">${s.variety_display}</p>
                            </div>
                            <div class="bg-white border p-3 rounded-lg text-center">
                                <p class="text-xs text-gray-400">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Ç‡∏≤‡∏¢</p>
                                <p class="font-bold text-green-600">${s.quantity_ton} ‡∏ï‡∏±‡∏ô</p>
                            </div>
                        </div>
                        
                        <a href="${mapsLink}" target="_blank" class="block w-full py-3 rounded-xl font-bold text-center transition ${mapsBtnClass} flex items-center justify-center gap-2">
                            <i class="fa-solid fa-location-arrow"></i> ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤ (Google Maps)
                        </a>
                        <p class="text-[10px] text-gray-400 text-center mt-1">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤</p>
                    </div>
                </div>
            `,
            showCloseButton: true,
            showConfirmButton: false,
            didOpen: () => {
                const tabProfile = Swal.getHtmlContainer().querySelector('#tab-profile');
                const tabField = Swal.getHtmlContainer().querySelector('#tab-field');
                const contentProfile = Swal.getHtmlContainer().querySelector('#content-profile');
                const contentField = Swal.getHtmlContainer().querySelector('#content-field');

                tabProfile.onclick = () => {
                    tabProfile.classList.add('text-blue-600', 'border-blue-600'); tabProfile.classList.remove('text-gray-400');
                    tabField.classList.remove('text-blue-600', 'border-blue-600'); tabField.classList.add('text-gray-400');
                    contentProfile.classList.remove('hidden'); contentField.classList.add('hidden');
                };
                tabField.onclick = () => {
                    tabField.classList.add('text-blue-600', 'border-blue-600'); tabField.classList.remove('text-gray-400');
                    tabProfile.classList.remove('text-blue-600', 'border-blue-600'); tabProfile.classList.add('text-gray-400');
                    contentField.classList.remove('hidden'); contentProfile.classList.add('hidden');
                };
            }
        });
    }

    // ==========================================
    // 3. Confirm Buy Action
    // ==========================================
    window.confirmBuy = async function(e, saleId) {
        if(e) e.stopPropagation();
        const s = allSalesData.find(item => item.id === saleId);
        if(!s) return;

        const totalPrice = (s.quantity_ton * s.price_per_ton).toLocaleString();
        let defaultPrice = s.price_per_ton;

        const { isConfirmed, value: formValues } = await Swal.fire({
            html: `
            <div class="bg-white p-4 rounded-xl text-sm space-y-4">
                <h2 class="text-lg font-bold text-gray-800 mb-2 flex items-center gap-2">
                    <i class="fa-solid fa-hand-holding-dollar text-green-600"></i> ‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠
                </h2>

                <div class="bg-blue-50 border border-blue-100 rounded-xl p-3 space-y-2 text-left">
                    <div class="flex justify-between"><span class="text-gray-500">‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£:</span><span class="font-bold">${s.farmer_name}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</span><span class="font-bold text-blue-600">${s.variety_display} (${s.quantity_ton} ‡∏ï‡∏±‡∏ô)</span></div>
                </div>

                <div class="space-y-3 text-left">
                    <div>
                        <label class="block text-gray-700 font-bold text-xs mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏™‡∏ô‡∏≠‡∏ã‡∏∑‡πâ‡∏≠ (‡∏ö‡∏≤‡∏ó/‡∏ï‡∏±‡∏ô)</label>
                        <input id="swal-price" type="number" class="swal2-input !m-0 w-full text-center font-bold text-lg text-green-700" 
                            value="${defaultPrice}" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏Ñ‡∏≤">
                        <p class="text-[10px] text-gray-400 mt-1">*‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏î‡πâ</p>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-bold text-xs mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö</label>
                        <input id="swal-contact" class="swal2-input !m-0 w-full text-sm" 
                            placeholder="08x-xxx-xxxx" value="{{ request.user.phone }}">
                    </div>
                </div>
            </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'üöÄ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠',
            confirmButtonColor: '#16a34a',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            focusConfirm: false,
            preConfirm: () => {
                const price = document.getElementById('swal-price').value;
                const contact = document.getElementById('swal-contact').value;
                if (!price || !contact) {
                    Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
                }
                return { price, contact };
            }
        });

        if (!isConfirmed) return;

        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', didOpen: () => Swal.showLoading() });

        try {
            const res = await fetch(`/api/sales/${saleId}/request_buy/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ 
                    contact: formValues.contact,
                    negotiated_price: formValues.price 
                })
            });

            if (res.ok) {
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏™‡∏ô‡∏≠‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß', 'success');
                loadData();
            } else {
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ', 'error');
            }
        } catch {
            Swal.fire('Error', '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error');
        }
    };

    window.focusMap = function(saleId) {
        markers.eachLayer(function(layer) {
            if (layer.saleId === saleId) {
                map.flyToBounds(layer.getBounds().pad(1.5), { duration: 1 });
                layer.openPopup();
            }
        });
    }

    window.toggleNotif = function() { document.getElementById('notif-dropdown').classList.toggle('hidden'); }
    window.markAllRead = function() { lastReadTime = new Date(); localStorage.setItem('millerLastRead', lastReadTime); loadData(); document.getElementById('notif-dropdown').classList.add('hidden'); }
    document.addEventListener('click', function(e) { const dd = document.getElementById('notif-dropdown'); if (!dd.contains(e.target) && !e.target.closest('button[onclick="toggleNotif()"]')) dd.classList.add('hidden'); });

    // Shared Functions
    function updateNotificationUI(newOpenItems, newApprovedItems) {
        const badge = document.getElementById('notif-badge');
        const listContainer = document.getElementById('notif-list-container');
        const totalNotif = newOpenItems.length + newApprovedItems.length;

        if (totalNotif > 0) { badge.innerText = totalNotif; badge.classList.remove('hidden'); } 
        else { badge.classList.add('hidden'); }

        if (totalNotif === 0) {
            listContainer.innerHTML = `<div class="p-8 text-center text-gray-400 text-sm"><i class="fa-regular fa-bell-slash text-2xl mb-2 opacity-50"></i><br>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</div>`;
        } else {
            listContainer.innerHTML = '';
            newApprovedItems.forEach(s => {
                listContainer.innerHTML += `<div class="p-3 border-b border-gray-50 bg-green-50 hover:bg-green-100 cursor-pointer transition-colors" onclick="focusMap(${s.id})"><div class="flex items-start gap-3"><div class="bg-green-500 text-white p-2 rounded-full h-8 w-8 flex items-center justify-center shrink-0"><i class="fa-solid fa-check"></i></div><div><p class="text-sm font-bold text-gray-800">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ</p><p class="text-xs text-gray-600">‡∏ä‡∏≤‡∏ß‡∏ô‡∏≤ <b>${s.farmer_name}</b> ‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß</p></div></div></div>`;
            });
            newOpenItems.forEach(s => {
                listContainer.innerHTML += `<div class="p-3 border-b border-gray-50 hover:bg-blue-50 cursor-pointer transition-colors" onclick="focusMap(${s.id})"><div class="flex items-start gap-3"><div class="bg-blue-100 text-blue-600 p-2 rounded-full h-8 w-8 flex items-center justify-center font-bold text-xs shrink-0">NEW</div><div><p class="text-sm font-bold text-gray-800">‡∏°‡∏µ‡∏Ç‡πâ‡∏≤‡∏ß‡∏Ç‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà üåæ</p><p class="text-xs text-gray-600">${s.quantity_ton} ‡∏ï‡∏±‡∏ô ‚Ä¢ ${s.variety_display}</p><p class="text-[10px] text-gray-400 mt-1">‡πÇ‡∏î‡∏¢ ${s.farmer_name}</p></div></div></div>`;
            });
        }
    }

    loadData();
    setInterval(loadData, 5000); 
</script>
{% endblock %}