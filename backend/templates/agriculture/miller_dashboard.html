{% extends 'base.html' %}
{% block content %}
<div class="flex flex-col gap-6 lg:h-[calc(100vh-100px)] h-auto pb-10 lg:pb-0">
    
    <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative z-20">
        <div>
            <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fa-solid fa-industry text-blue-600"></i> ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÇ‡∏£‡∏á‡∏™‡∏µ (‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡πâ‡∏≤‡∏ß)
            </h1>
            <p class="text-sm text-gray-500 mt-1">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</p>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="relative">
                <button onclick="toggleNotif()" class="p-2.5 rounded-full hover:bg-gray-100 transition relative focus:outline-none group">
                    <i class="fa-solid fa-bell text-gray-500 text-xl group-hover:text-blue-600 transition-colors"></i>
                    <span id="notif-badge" class="absolute top-0 right-0 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden border-2 border-white transform translate-x-1 -translate-y-1 shadow-sm animate-pulse">0</span>
                </button>

                <div id="notif-dropdown" class="hidden absolute right-0 mt-4 w-96 bg-white rounded-xl shadow-2xl border border-gray-100 overflow-hidden z-50 animate-fade-in-up origin-top-right">
                    <div class="bg-gradient-to-r from-blue-50 to-white px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                        <span class="text-sm font-bold text-gray-700">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span>
                        <span class="text-xs text-blue-500 cursor-pointer hover:text-blue-700" onclick="markAllRead()">‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                    </div>
                    <div id="notif-list-container" class="max-h-80 overflow-y-auto custom-scrollbar bg-white p-0">
                    </div>
                </div>
            </div>

            <div class="bg-blue-50 text-blue-700 px-4 py-2 rounded-lg border border-blue-100 shadow-sm flex items-center">
                <span class="text-sm font-bold mr-2">üõí ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠:</span>
                <span id="sale-count" class="text-xl font-bold">0</span> 
                <span class="text-xs ml-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 flex-grow lg:overflow-hidden h-auto">
        
        <div class="lg:col-span-4 bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col h-[500px] lg:h-full overflow-hidden relative z-10 order-2 lg:order-1">
            <div class="p-4 border-b border-gray-100 bg-gray-50/50 backdrop-blur flex justify-between items-center">
                <h3 class="font-bold text-gray-700 flex items-center">
                    <i class="fa-solid fa-bullhorn text-orange-500 mr-2"></i> ‡∏ï‡∏•‡∏≤‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏Ç‡πâ‡∏≤‡∏ß
                </h3>
                <div class="flex gap-2 text-[10px]">
                    <span class="bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full">‡∏£‡∏≠‡∏ã‡∏∑‡πâ‡∏≠</span>
                    <span class="bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full">‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>
                </div>
            </div>
            
            <div class="overflow-y-auto flex-grow p-4 space-y-3 custom-scrollbar relative" id="saleList">
                <div class="flex flex-col items-center justify-center h-40 text-gray-400 space-y-2">
                    <i class="fa-solid fa-circle-notch fa-spin text-2xl text-blue-200"></i>
                    <p class="text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                </div>
            </div>
            <div class="absolute bottom-0 left-0 w-full h-12 bg-gradient-to-t from-white to-transparent pointer-events-none"></div>
        </div>

        <div class="lg:col-span-8 bg-white rounded-2xl shadow-sm border border-gray-100 h-[400px] lg:h-full relative flex flex-col group overflow-hidden order-1 lg:order-2">
            <div class="absolute top-4 left-4 z-[400] bg-white/95 backdrop-blur px-4 py-2 rounded-xl shadow-md border border-gray-200 pointer-events-none">
                <h2 class="text-sm font-bold text-gray-800 flex items-center gap-2">
                    <i class="fa-solid fa-map-location-dot text-blue-600"></i> ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤
                </h2>
            </div>
            <div id="map" class="w-full h-full rounded-2xl z-0 bg-slate-100"></div>
        </div>
    </div>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f8fafc; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
    .animate-fade-in-up { animation: fadeInUp 0.2s cubic-bezier(0.16, 1, 0.3, 1); }

    .swal2-popup {
    border-radius: 16px !important;
    padding: 1.5rem !important;
}

    @media (max-width: 640px) {
        .swal2-popup {
            width: 92% !important;
            margin: 0 auto !important;
            font-size: 14px !important;
        }

        .swal2-title {
            font-size: 1.2rem !important;
        }

        .swal2-html-container {
            padding: 0 !important;
        }

        .swal2-confirm,
        .swal2-cancel {
            width: 100% !important;
            margin: 0.25rem 0 !important;
            font-size: 1rem !important;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // ==========================================
    // 0. Global & Setup
    // ==========================================
    const currentUserId = {{ request.user.id }}; // ‡∏£‡∏±‡∏ö ID ‡∏Ç‡∏≠‡∏á User ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    
    var map = L.map('map', { center:[19.1667, 99.9000], zoom:11, zoomControl: false });
    L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{maxZoom:20,subdomains:['mt0','mt1','mt2','mt3']}).addTo(map);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    var markers = L.featureGroup().addTo(map);
    let lastReadTime = new Date(localStorage.getItem('millerLastRead') || 0);

    // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç 5: ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏°‡∏û‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠/‡∏Ç‡∏¢‡∏≤‡∏¢‡∏à‡∏≠
    window.addEventListener('resize', function() {
        setTimeout(function(){ map.invalidateSize(); }, 300);
    });

    // ==========================================
    // 1. Main Data Loop
    // ==========================================
    async function loadData() {
        try {
            const res = await fetch('/api/sales/');
            const sales = await res.json();
            
            const listDiv = document.getElementById('saleList');
            const countSpan = document.getElementById('sale-count');
            
            // --- 1.1 ‡πÅ‡∏¢‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Status Handling) ---
            // üõí OPEN: ‡∏£‡∏≠‡∏Ç‡∏≤‡∏¢ (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô)
            const openSales = sales.filter(s => s.status === 'OPEN').sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
            
            // ‚è≥ REQUESTED: ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏Å‡∏î‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏õ (‡∏£‡∏≠‡∏ä‡∏≤‡∏ß‡∏ô‡∏≤‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)
            const myRequests = sales.filter(s => s.status === 'REQUESTED').sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
            
            // ‚úÖ SOLD: ‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å CLOSED ‡πÄ‡∏õ‡πá‡∏ô SOLD ‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô)
            const soldSales = sales.filter(s => s.status === 'SOLD').sort((a,b) => new Date(b.sold_at || b.created_at) - new Date(a.sold_at || a.created_at));

            // ‡∏£‡∏ß‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡πÄ‡∏≠‡∏≤ "‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô" ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô -> ‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢ "‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢" -> "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß")
            const displayList = [...myRequests, ...openSales, ...soldSales];

            // --- 1.2 ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (Notification Logic) ---
            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô 2 ‡∏Å‡∏£‡∏ì‡∏µ:
            // 1. ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà (New Open)
            // 2. ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approved) -> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å sold_at ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            const newOpenItems = openSales.filter(s => new Date(s.created_at) > lastReadTime);
            const newApprovedItems = soldSales.filter(s => s.sold_at && new Date(s.sold_at) > lastReadTime);
            
            updateNotificationUI(newOpenItems, newApprovedItems);

            // --- 1.3 Render ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ---
            listDiv.innerHTML = '';
            markers.clearLayers();
            countSpan.innerText = openSales.length; 

            if (displayList.length === 0) {
                listDiv.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-400 opacity-60 mt-10"><i class="fa-solid fa-basket-shopping text-5xl mb-3"></i><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</p></div>`;
                return;
            }

            displayList.forEach(s => {
                // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                const isRequested = s.status === 'REQUESTED';
                const isSold = s.status === 'SOLD';
                
                const totalPrice = (s.quantity_ton * s.price_per_ton).toLocaleString();
                const pricePerTon = s.price_per_ton.toLocaleString();
                const datePost = new Date(s.created_at).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' });
                const fieldArea = s.field_area ? s.field_area : '-';

                // --- UI Condition ---
                let borderClass = "border-l-4 border-l-orange-500";
                let badgeStatus = `<span class="bg-orange-100 text-orange-700 text-[10px] px-2 py-0.5 rounded-full font-bold animate-pulse">‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</span>`;
                let actionBtn = `<button onclick="confirmBuy(event, ${s.id}, '${s.farmer_name}', '${totalPrice}', ${s.quantity_ton}, '${s.variety_display}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg shadow transition-colors flex items-center justify-center gap-2"><i class="fa-solid fa-handshake"></i> ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠</button>`;
                let mapColor = '#f97316'; // ‡∏™‡πâ‡∏°
                let mapOpacity = 0.6;

                if (isRequested) {
                    // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                    borderClass = "border-l-4 border-l-yellow-400 bg-yellow-50/30";
                    badgeStatus = `<span class="bg-yellow-100 text-yellow-700 text-[10px] px-2 py-0.5 rounded-full font-bold"><i class="fa-solid fa-clock"></i> ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>`;
                    actionBtn = `<button class="w-full bg-yellow-100 text-yellow-600 font-bold py-2 rounded-lg cursor-not-allowed border border-yellow-200" disabled><i class="fa-solid fa-hourglass-half"></i> ‡∏£‡∏≠‡∏ä‡∏≤‡∏ß‡∏ô‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô...</button>`;
                    mapColor = '#eab308'; // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
                } 
                else if (isSold) {
                    // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                    borderClass = "border-gray-300 opacity-70 grayscale-[50%]";
                    badgeStatus = `<span class="bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded-full font-bold"><i class="fa-solid fa-check"></i> ‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>`;
                    actionBtn = `<button class="w-full bg-gray-100 text-gray-400 font-bold py-2 rounded-lg cursor-not-allowed" disabled><i class="fa-solid fa-check-double"></i> ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</button>`;
                    mapColor = '#22c55e'; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                    mapOpacity = 0.4;
                }

                // Badge NEW (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Sold)
                const isNew = !isSold && !isRequested && new Date(s.created_at) > lastReadTime;
                const newBadge = isNew ? `<span class="ml-2 bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded font-bold animate-bounce shadow-sm">NEW</span>` : '';

                // HTML Card
                listDiv.innerHTML += `
                    <div class="bg-white border border-gray-200 p-4 rounded-xl shadow-sm hover:shadow-md transition-all cursor-pointer group relative overflow-hidden ${borderClass} mb-3" onclick="focusMap(${s.id})">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                                    <i class="fa-solid fa-user-circle text-gray-400"></i> ${s.farmer_name} ${newBadge}
                                </h4>
                                <p class="text-xs text-gray-500 flex items-center gap-1"><i class="fa-solid fa-clock"></i> ${datePost} ${badgeStatus}</p>
                            </div>
                            <span class="bg-green-50 text-green-700 border border-green-100 text-xs font-bold px-2 py-1 rounded-lg">${s.quantity_ton} ‡∏ï‡∏±‡∏ô</span>
                        </div>
                        <div class="bg-white p-3 rounded-lg border border-dashed border-gray-200 text-sm space-y-1 mb-3">
                            <div class="flex justify-between"><span class="text-gray-500">‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Ç‡πâ‡∏≤‡∏ß:</span><span class="font-semibold text-blue-600">${s.variety_display}</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà:</span><span class="font-semibold text-gray-700">${fieldArea} ‡πÑ‡∏£‡πà</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ï‡∏±‡∏ô:</span><span class="font-semibold">${pricePerTon} ‡∏ö.</span></div>
                            <div class="flex justify-between border-t border-gray-100 pt-1 mt-1"><span class="text-gray-700 font-bold">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°:</span><span class="font-bold text-green-600 text-lg">${totalPrice} ‡∏ö.</span></div>
                        </div>
                        ${actionBtn}
                    </div>
                `;

                // Map Marker
                if(s.field_location) {
                    try {
                        const geoJson = JSON.parse(s.field_location);
                        const layer = L.geoJSON(geoJson, { style:{color: mapColor, fillOpacity: mapOpacity, weight: 2} })
                            .bindPopup(`
                                <div class="text-center min-w-[150px]">
                                    <b class="text-lg text-gray-800">${s.farmer_name}</b><br>
                                    <span class="font-bold text-lg" style="color:${mapColor}">${s.status === 'SOLD' ? '‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : (s.status === 'REQUESTED' ? '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : s.quantity_ton + ' ‡∏ï‡∏±‡∏ô')}</span><br>
                                    <span class="text-xs text-gray-400">${s.variety_display} (${fieldArea} ‡πÑ‡∏£‡πà)</span>
                                </div>
                            `);
                        layer.saleId = s.id;
                        markers.addLayer(layer);
                    } catch(e){}
                }
            });

        } catch(e) { console.error("Load Data Error:", e); }
    }

    // ==========================================
    // 2. Notification UI (Updated)
    // ==========================================
    function updateNotificationUI(newOpenItems, newApprovedItems) {
        const badge = document.getElementById('notif-badge');
        const listContainer = document.getElementById('notif-list-container');
        const totalNotif = newOpenItems.length + newApprovedItems.length;

        // Badge Count
        if (totalNotif > 0) {
            badge.innerText = totalNotif;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }

        // Notification List Content
        if (totalNotif === 0) {
            listContainer.innerHTML = `<div class="p-8 text-center text-gray-400 text-sm"><i class="fa-regular fa-bell-slash text-2xl mb-2 opacity-50"></i><br>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</div>`;
        } else {
            listContainer.innerHTML = '';
            
            // 1. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß" (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å)
            newApprovedItems.forEach(s => {
                listContainer.innerHTML += `
                    <div class="p-3 border-b border-gray-50 bg-green-50 hover:bg-green-100 cursor-pointer transition-colors" onclick="focusMap(${s.id})">
                        <div class="flex items-start gap-3">
                            <div class="bg-green-500 text-white p-2 rounded-full h-8 w-8 flex items-center justify-center shrink-0"><i class="fa-solid fa-check"></i></div>
                            <div>
                                <p class="text-sm font-bold text-gray-800">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ</p>
                                <p class="text-xs text-gray-600">‡∏ä‡∏≤‡∏ß‡∏ô‡∏≤ <b>${s.farmer_name}</b> ‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß</p>
                                <p class="text-[10px] text-gray-400 mt-1">${new Date(s.sold_at).toLocaleTimeString('th-TH')} ‡∏ô.</p>
                            </div>
                        </div>
                    </div>
                `;
            });

            // 2. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ "‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà"
            newOpenItems.forEach(s => {
                listContainer.innerHTML += `
                    <div class="p-3 border-b border-gray-50 hover:bg-blue-50 cursor-pointer transition-colors" onclick="focusMap(${s.id})">
                        <div class="flex items-start gap-3">
                            <div class="bg-blue-100 text-blue-600 p-2 rounded-full h-8 w-8 flex items-center justify-center font-bold text-xs shrink-0">NEW</div>
                            <div>
                                <p class="text-sm font-bold text-gray-800">‡∏°‡∏µ‡∏Ç‡πâ‡∏≤‡∏ß‡∏Ç‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà üåæ</p>
                                <p class="text-xs text-gray-600">${s.quantity_ton} ‡∏ï‡∏±‡∏ô ‚Ä¢ ${s.variety_display}</p>
                                <p class="text-[10px] text-gray-400 mt-1">‡πÇ‡∏î‡∏¢ ${s.farmer_name}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
    }

    // ==========================================
    // 3. Actions
    // ==========================================
    window.confirmBuy = async function(e, saleId, farmerName, totalPrice, qty, variety) {
        e.stopPropagation();

        const { isConfirmed, value: contact } = await Swal.fire({
            html: `
            <div class="bg-white p-6 rounded-2xl shadow-lg max-w-md mx-auto text-sm space-y-4">
                <h2 class="text-lg font-bold text-gray-800 mb-2 flex items-center gap-2">
                    <i class="fa-solid fa-handshake text-blue-600"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠
                </h2>

                <div class="border border-gray-200 rounded-xl p-4 space-y-2 bg-gray-50">
                    <div class="flex justify-between">
                        <span class="text-gray-500">‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</span>
                        <span class="font-semibold text-gray-800">${farmerName}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
                        <span class="font-semibold text-blue-600">${variety}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</span>
                        <span class="font-semibold">${qty} ‡∏ï‡∏±‡∏ô</span>
                    </div>
                    <div class="flex justify-between border-t border-gray-200 pt-2">
                        <span class="font-bold text-gray-700">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</span>
                        <span class="font-bold text-green-600 text-lg">${totalPrice} ‡∏ö‡∏≤‡∏ó</span>
                    </div>
                </div>

                <div class="flex flex-col space-y-1">
                    <label class="text-gray-500 text-xs font-bold ">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
                    <input id="swal-contact" class="swal2-input !mt-2 text-sm border border-gray-300 rounded-lg p-2" 
                        placeholder="‡πÄ‡∏ä‡πà‡∏ô 081-234-5678" value="{{ request.user.phone }}">
                    <p class="text-gray-400 text-[11px]">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡πâ‡∏ä‡∏≤‡∏ß‡∏ô‡∏≤‡πÉ‡∏ä‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö</p>
                </div>
            </div>
            `,
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'üöÄ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            reverseButtons: true,
            focusConfirm: false,
            customClass: {
                confirmButton: 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg',
                cancelButton: 'bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg'
            },
            preConfirm: () => {
                const val = document.getElementById('swal-contact').value;
                if (!val) {
                    Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå');
                }
                return val;
            }
        });

        if (!isConfirmed) return;

        Swal.fire({
            title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        try {
            const res = await fetch(`/api/sales/${saleId}/request_buy/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ contact })
            });

            const data = await res.json();

            if (res.ok) {
                Swal.fire({
                    icon: 'success',
                    title: '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üéâ',
                    text: '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡∏≤‡∏ß‡∏ô‡∏≤‡πÅ‡∏•‡πâ‡∏ß',
                    timer: 3000,
                    showConfirmButton: false
                });
                loadData();
            } else {
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', data.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ', 'error');
            }
        } catch {
            Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå', 'error');
        }
    };
    window.focusMap = function(saleId) {
        markers.eachLayer(function(layer) {
            if (layer.saleId === saleId) {
                map.flyToBounds(layer.getBounds().pad(1.5), { duration: 1 });
                layer.openPopup();
            }
        });
    }

    window.toggleNotif = function() {
        document.getElementById('notif-dropdown').classList.toggle('hidden');
    }
    
    window.markAllRead = function() {
        lastReadTime = new Date();
        localStorage.setItem('millerLastRead', lastReadTime);
        loadData(); 
        document.getElementById('notif-dropdown').classList.add('hidden');
    }

    // ‡∏õ‡∏¥‡∏î Dropdown ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('notif-dropdown');
        const button = event.target.closest('button');
        const isToggleBtn = button && button.getAttribute('onclick')?.includes('toggleNotif');
        const isInsideDropdown = event.target.closest('#notif-dropdown');
        
        if (!isToggleBtn && !isInsideDropdown && dropdown && !dropdown.classList.contains('hidden')) {
            dropdown.classList.add('hidden');
        }
    });

    loadData();
    setInterval(loadData, 5000); 
</script>
{% endblock %}