{% extends 'base.html' %}
{% block content %}
<div class="flex flex-col h-screen bg-gray-50 overflow-hidden relative">
    
    <!-- Header Bar -->
    <div class="flex-none bg-white px-4 py-3 shadow-sm border-b border-gray-100 z-30 flex justify-between items-center h-16">
        <div>
            <h1 class="text-lg lg:text-2xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fa-solid fa-industry text-blue-600"></i> 
                <span class="hidden sm:inline">‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÇ‡∏£‡∏á‡∏™‡∏µ</span>
                <span class="sm:hidden">‡πÇ‡∏£‡∏á‡∏™‡∏µ (‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠)</span>
            </h1>
        </div>
        <div class="bg-blue-50 text-blue-700 px-3 py-1.5 rounded-full border border-blue-100 flex items-center shadow-sm">
            <span class="text-xs font-bold mr-1">üõí</span>
            <span id="sale-count" class="text-base font-bold">0</span> 
            <span class="text-xs ml-1 hidden sm:inline">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        </div>
    </div>

    <!-- Main Content: List + Map -->
    <div class="flex-1 min-h-0 relative lg:grid lg:grid-cols-12 lg:gap-0">
        
        <!-- LEFT PANEL: Sales List (Desktop: Always visible, Mobile: Toggle) -->
        <div id="view-list" 
            class="lg:col-span-4 
                h-[calc(100vh-64px-64px)]
                lg:h-[calc(100vh-64px)]
                flex flex-col bg-white border-r border-gray-200 
                transition-opacity duration-200">
            
            <!-- List Header -->
            <div class="flex-none p-3 bg-gradient-to-r from-blue-50 to-white backdrop-blur border-b border-gray-200 sticky top-0 z-20">
                <div class="flex justify-between items-center">
                    <span class="text-xs font-bold text-gray-500 uppercase tracking-wide flex items-center gap-2">
                        <i class="fa-solid fa-basket-shopping"></i> 
                        ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢
                    </span>
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-orange-500 animate-pulse"></span>
                        <span class="text-[10px] text-gray-400">Live</span>
                    </div>
                </div>
            </div>

            <!-- Scrollable List Container -->
            <div id="saleList" 
                class="flex-1 min-h-0 overflow-y-auto custom-scrollbar p-3 space-y-3 pb-24 lg:pb-4 bg-slate-50">
                <!-- Loading State -->
                <div class="flex flex-col items-center justify-center h-64 text-gray-400 opacity-60">
                    <i class="fa-solid fa-circle-notch fa-spin text-3xl mb-2"></i>
                    <p class="text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                </div>
            </div>
        </div>

        <!-- RIGHT PANEL: Map (Desktop: Always visible, Mobile: Toggle) -->
        <div id="view-map" 
            class="hidden lg:block lg:col-span-8 
                h-[calc(100vh-64px-64px)]
                lg:h-[calc(100vh-64px)]
                bg-slate-100 relative">
                
            <div id="map" class="w-full h-full z-0"></div>
            
            <!-- Mobile Hint (Only on Mobile) -->
            <div class="absolute top-4 left-0 right-0 z-[400] flex justify-center lg:hidden pointer-events-none">
                <div class="bg-white/90 backdrop-blur px-4 py-1.5 rounded-full shadow-lg border border-gray-200">
                    <span class="text-xs font-bold text-gray-600 flex items-center gap-2">
                        <i class="fa-solid fa-map-location-dot text-blue-500"></i> 
                        ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </span>
                </div>
            </div>

            <!-- Desktop Legend (Only on Desktop) -->
            <div class="hidden lg:block absolute bottom-4 left-4 z-[400] bg-white/95 backdrop-blur rounded-lg shadow-lg border border-gray-200 p-3">
                <h4 class="text-xs font-bold text-gray-700 mb-2">‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå</h4>
                <div class="space-y-1.5 text-xs">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded bg-orange-500"></div>
                        <span>‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded bg-yellow-400"></div>
                        <span>‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded bg-green-500"></div>
                        <span>‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß</span>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Mobile Bottom Navigation -->
    <div class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-[0_-5px_10px_rgba(0,0,0,0.02)] z-50 pb-[env(safe-area-inset-bottom)]">
        <div class="grid grid-cols-2 h-16 relative">
            
            <button onclick="switchTab('list')" 
                class="group flex flex-col items-center justify-center gap-1 transition-all relative overflow-hidden">
                <div id="nav-icon-list" 
                    class="bg-blue-50 text-blue-600 w-12 h-8 rounded-full flex items-center justify-center transition-all duration-300 scale-100">
                    <i class="fa-solid fa-list-ul text-lg"></i>
                </div>
                <span id="nav-text-list" class="text-[10px] font-bold text-blue-600 transition-colors">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
            </button>

            <button onclick="switchTab('map')" 
                class="group flex flex-col items-center justify-center gap-1 transition-all relative overflow-hidden">
                <div id="nav-icon-map" 
                    class="bg-transparent text-gray-400 w-12 h-8 rounded-full flex items-center justify-center transition-all duration-300 scale-90">
                    <i class="fa-solid fa-map text-lg"></i>
                </div>
                <span id="nav-text-map" class="text-[10px] font-bold text-gray-400 transition-colors">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</span>
            </button>

        </div>
    </div>

</div>

<style>
    /* Scrollbar ‡∏™‡∏ß‡∏¢‡πÜ */
    .custom-scrollbar::-webkit-scrollbar { 
        width: 6px; 
        height: 6px; 
    }
    .custom-scrollbar::-webkit-scrollbar-track { 
        background: #f1f5f9; 
        border-radius: 10px; 
    }
    .custom-scrollbar::-webkit-scrollbar-thumb { 
        background: #cbd5e1; 
        border-radius: 10px; 
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { 
        background: #94a3b8; 
    }
    
    /* Animation ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô */
    .animate-fade-in-up { 
        animation: fadeInUp 0.3s ease-out forwards; 
    }
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á SweetAlert */
    .swal2-popup { 
        border-radius: 20px !important; 
        padding: 1.5rem !important; 
        font-family: 'Sarabun', sans-serif; 
    }
    .swal2-actions { 
        width: 100%; 
        margin: 1rem 0 0 0 !important; 
    }

    /* Desktop: Force both panels to show */
    @media (min-width: 1024px) {
        #view-list, #view-map {
            display: flex !important; /* Override hidden class */
        }
        #view-map {
            display: block !important;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // ==========================================
    // 0. Global & Setup
    // ==========================================
    const currentUserId = {{ request.user.id }}; 
    
    var map = L.map('map', { 
        center: [19.1667, 99.9000], 
        zoom: 13, 
        zoomControl: false 
    });
    
    L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
        maxZoom: 20,
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
    }).addTo(map);
    
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    var markers = L.featureGroup().addTo(map);
    let lastReadTime = new Date(localStorage.getItem('globalLastRead') || 0);
    let allSalesData = []; 

    // Handle window resize for map
    window.addEventListener('resize', function() { 
        setTimeout(function() { 
            map.invalidateSize(); 
        }, 300); 
    });

    // ==========================================
    // Mobile Tab Switching (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß)
    // ==========================================
    function switchTab(mode) {
        const viewList = document.getElementById('view-list');
        const viewMap = document.getElementById('view-map');
        
        const iconList = document.getElementById('nav-icon-list');
        const textList = document.getElementById('nav-text-list');
        const iconMap = document.getElementById('nav-icon-map');
        const textMap = document.getElementById('nav-text-map');

        // Check if mobile
        const isMobile = window.innerWidth < 1024;

        if (!isMobile) {
            // Desktop: Always show both panels
            viewList.classList.remove('hidden');
            viewMap.classList.remove('hidden');
            return;
        }

        // Mobile: Toggle views
        if (mode === 'list') {
            viewList.classList.remove('hidden');
            viewMap.classList.add('hidden');
            
            // Update Nav Styles (List Active)
            iconList.classList.remove('bg-transparent', 'text-gray-400', 'scale-90');
            iconList.classList.add('bg-blue-50', 'text-blue-600', 'scale-100');
            textList.classList.remove('text-gray-400');
            textList.classList.add('text-blue-600');

            iconMap.classList.add('bg-transparent', 'text-gray-400', 'scale-90');
            iconMap.classList.remove('bg-blue-50', 'text-blue-600', 'scale-100');
            textMap.classList.add('text-gray-400');
            textMap.classList.remove('text-blue-600');
            
        } else {
            viewMap.classList.remove('hidden');
            viewList.classList.add('hidden');

            iconMap.classList.remove('bg-transparent', 'text-gray-400', 'scale-90');
            iconMap.classList.add('bg-blue-50', 'text-blue-600', 'scale-100');
            textMap.classList.remove('text-gray-400');
            textMap.classList.add('text-blue-600');

            iconList.classList.add('bg-transparent', 'text-gray-400', 'scale-90');
            iconList.classList.remove('bg-blue-50', 'text-blue-600', 'scale-100');
            textList.classList.add('text-gray-400');
            textList.classList.remove('text-blue-600');

            // Refresh Map
            setTimeout(() => { 
                map.invalidateSize(); 
            }, 100);
        }
    }

    // ==========================================
    // 1. Main Data Loop (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß)
    // ==========================================
    async function loadData() {
        try {
            const res = await fetch('/api/sales/');
            const sales = await res.json();
            allSalesData = sales;
            
            const listDiv = document.getElementById('saleList');
            const countSpan = document.getElementById('sale-count');
            
            // Sort sales
            const openSales = sales.filter(s => s.status === 'OPEN')
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            const myRequests = sales.filter(s => s.status === 'REQUESTED')
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            const soldSales = sales.filter(s => s.status === 'SOLD')
                .sort((a, b) => new Date(b.sold_at || b.created_at) - new Date(a.sold_at || a.created_at));

            const displayList = [...myRequests, ...openSales, ...soldSales];

            listDiv.innerHTML = '';
            markers.clearLayers();
            countSpan.innerText = openSales.length; 

            if (displayList.length === 0) {
                listDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-400 opacity-60 mt-10">
                        <i class="fa-solid fa-basket-shopping text-5xl mb-3"></i>
                        <p class="font-semibold">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</p>
                        <p class="text-xs mt-2">‡∏£‡∏≠‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢‡∏Ç‡πâ‡∏≤‡∏ß</p>
                    </div>`;
                return;
            }

            displayList.forEach(s => {
                const isRequested = s.status === 'REQUESTED';
                const isSold = s.status === 'SOLD';
                const totalPrice = (s.quantity_ton * s.price_per_ton).toLocaleString();
                const pricePerTon = parseFloat(s.price_per_ton).toLocaleString();
                const datePost = new Date(s.created_at).toLocaleDateString('th-TH', { 
                    day: 'numeric', 
                    month: 'short', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                const fieldArea = s.field_area ? s.field_area : '-';

                let mapsLink = '#';
                if (s.field_lat && s.field_lng) {
                    mapsLink = `https://www.google.com/maps/dir/?api=1&destination=${s.field_lat},${s.field_lng}`;
                }

                let borderClass = "border-l-4 border-l-orange-500";
                let badgeStatus = `<span class="bg-orange-100 text-orange-700 text-[10px] px-2 py-0.5 rounded-full font-bold animate-pulse">‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</span>`;
                let actionBtn = `
                    <div class="grid grid-cols-5 gap-2">
                        <button onclick="viewFullDetails(${s.id})" 
                            class="col-span-1 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg flex items-center justify-center py-2" 
                            title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                        <button onclick="confirmBuy(event, ${s.id})" 
                            class="col-span-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg shadow transition-colors flex items-center justify-center gap-2">
                            <i class="fa-solid fa-handshake"></i> ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠
                        </button>
                    </div>`;
                let mapColor = '#f97316'; 
                let mapOpacity = 0.6;

                if (isRequested) {
                    borderClass = "border-l-4 border-l-yellow-400 bg-yellow-50/30";
                    badgeStatus = `<span class="bg-yellow-100 text-yellow-700 text-[10px] px-2 py-0.5 rounded-full font-bold"><i class="fa-solid fa-clock"></i> ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>`;
                    actionBtn = `
                        <div class="grid grid-cols-5 gap-2">
                            <button onclick="viewFullDetails(${s.id})" 
                                class="col-span-1 bg-white hover:bg-gray-100 text-gray-600 border border-gray-200 rounded-lg flex items-center justify-center py-2">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                            <button class="col-span-4 bg-yellow-100 text-yellow-600 font-bold py-2 rounded-lg cursor-not-allowed border border-yellow-200" disabled>
                                <i class="fa-solid fa-hourglass-half"></i> ‡∏£‡∏≠‡∏ä‡∏≤‡∏ß‡∏ô‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô...
                            </button>
                        </div>`;
                    mapColor = '#eab308';
                } else if (isSold) {
                    borderClass = "border-l-4 border-l-gray-300 opacity-70 grayscale-[50%]";
                    badgeStatus = `<span class="bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded-full font-bold"><i class="fa-solid fa-check"></i> ‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>`;
                    actionBtn = `
                        <button onclick="viewFullDetails(${s.id})" 
                            class="w-full bg-gray-100 text-gray-500 font-bold py-2 rounded-lg hover:bg-gray-200 hover:text-gray-700 transition">
                            <i class="fa-solid fa-file-invoice"></i> ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢
                        </button>`;
                    mapColor = '#22c55e';
                    mapOpacity = 0.4;
                }

                const isNew = !isSold && !isRequested && new Date(s.created_at) > lastReadTime;
                const newBadge = isNew ? `<span class="ml-2 bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded font-bold animate-bounce shadow-sm">NEW</span>` : '';

                listDiv.innerHTML += `
                    <div class="bg-white border border-gray-200 p-4 rounded-xl shadow-sm hover:shadow-md transition-all cursor-pointer group relative overflow-hidden ${borderClass}" 
                         onclick="focusMap(${s.id})">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-800 text-base flex items-center gap-2 mb-1">
                                    <i class="fa-solid fa-user-circle text-gray-400"></i> 
                                    ${s.farmer_name} 
                                    ${newBadge}
                                </h4>
                                <p class="text-xs text-gray-500 flex items-center gap-2">
                                    <i class="fa-solid fa-clock"></i> ${datePost}
                                </p>
                            </div>
                            <div class="flex flex-col items-end gap-1">
                                ${badgeStatus}
                                <span class="bg-green-50 text-green-700 border border-green-100 text-xs font-bold px-2 py-1 rounded-lg">
                                    ${s.quantity_ton} ‡∏ï‡∏±‡∏ô
                                </span>
                            </div>
                        </div>
                        
                        <div class="bg-white p-3 rounded-lg border border-dashed border-gray-200 text-sm space-y-1 mb-3">
                            <div class="flex justify-between">
                                <span class="text-gray-500">‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Ç‡πâ‡∏≤‡∏ß:</span>
                                <span class="font-semibold text-blue-600">${s.variety_display}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà:</span>
                                <span class="font-semibold text-gray-700">${fieldArea} ‡πÑ‡∏£‡πà</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ï‡∏±‡∏ô:</span>
                                <span class="font-semibold">${pricePerTon} ‡∏ö.</span>
                            </div>
                            <div class="flex justify-between border-t border-gray-100 pt-1 mt-1">
                                <span class="text-gray-700 font-bold">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°:</span>
                                <span class="font-bold text-green-600 text-lg">${totalPrice} ‡∏ö.</span>
                            </div>
                        </div>
                        
                        ${actionBtn}
                    </div>
                `;

                // Add to map
                if (s.field_location) {
                    try {
                        const geoJson = JSON.parse(s.field_location);
                        const layer = L.geoJSON(geoJson, { 
                            style: {
                                color: mapColor, 
                                fillOpacity: mapOpacity, 
                                weight: 2
                            } 
                        }).bindPopup(`
                            <div class="text-center min-w-[180px] p-2 font-sans">
                                <b class="text-base text-gray-900 block mb-1">${s.farmer_name}</b>
                                <span class="font-black text-lg block mb-1" style="color:${mapColor}">
                                    ${s.status === 'SOLD' ? '‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : (s.status === 'REQUESTED' ? '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : s.quantity_ton + ' ‡∏ï‡∏±‡∏ô')}
                                </span>
                                <span class="text-xs text-gray-500 block mb-3">${s.variety_display} (${fieldArea} ‡πÑ‡∏£‡πà)</span>
                                
                                <div class="flex gap-2 mt-2">
                                    <button onclick="viewFullDetails(${s.id})" 
                                        class="flex-1 bg-gray-800 hover:bg-gray-900 text-white text-xs font-bold py-2 rounded-lg shadow transition-colors">
                                        ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                    </button>
                                    
                                    <a href="${mapsLink}" target="_blank" 
                                        class="flex-1 bg-blue-600 hover:bg-blue-700 !text-white text-xs font-bold py-2 rounded-lg shadow flex items-center justify-center gap-1 transition-transform hover:scale-105">
                                        <i class="fa-solid fa-location-arrow"></i> ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á
                                    </a>
                                </div>
                            </div>
                        `);
                        layer.saleId = s.id;
                        markers.addLayer(layer);
                    } catch (e) {
                        console.warn('Failed to parse field location:', e);
                    }
                }
            });

        } catch (e) { 
            console.error("Load Data Error:", e); 
            document.getElementById('saleList').innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-red-400 mt-10">
                    <i class="fa-solid fa-exclamation-triangle text-4xl mb-2"></i>
                    <p class="font-semibold">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                    <button onclick="loadData()" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                    </button>
                </div>`;
        }
    }

    // ==========================================
    // 2. View Full Details (Modal)
    // ==========================================
    window.viewFullDetails = function(saleId) {
        event.stopPropagation();
        const s = allSalesData.find(item => item.id === saleId);
        if (!s) return;

        const farmerPhone = s.farmer_phone || '-';
        const farmerLine = s.farmer_line || '-';
        const farmerAddress = s.farmer_address || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà';
        const farmerBio = s.farmer_bio || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏±‡∏ß';
        
        let mapsLink = '#';
        let mapsBtnClass = 'bg-gray-100 text-gray-400 cursor-not-allowed';
        let btnText = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤';
        
        if (s.field_lat && s.field_lng) {
            mapsLink = `https://www.google.com/maps/dir/?api=1&destination=${s.field_lat},${s.field_lng}`;
            mapsBtnClass = 'bg-blue-600 hover:bg-blue-700 text-white shadow-lg shadow-blue-200 hover:shadow-blue-300 transform active:scale-95';
            btnText = '‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤ (Google Maps)';
        }
        
        Swal.fire({
            title: '',
            html: `
                <div class="text-left">
                    <div class="flex items-center gap-4 border-b pb-4 mb-4">
                        <div class="w-14 h-14 bg-gradient-to-br from-blue-100 to-blue-50 rounded-full flex items-center justify-center text-2xl text-blue-600 shadow-inner">
                            <i class="fa-solid fa-user"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-800 leading-tight">${s.farmer_name}</h2>
                            <span class="bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded-md border border-green-200 font-bold">‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</span>
                        </div>
                    </div>

                    <div class="mb-5 bg-gray-100 p-1 rounded-xl flex">
                        <button id="tab-profile" class="flex-1 py-2 rounded-lg text-sm font-bold bg-white text-blue-600 shadow-sm transition-all">
                            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
                        </button>
                        <button id="tab-field" class="flex-1 py-2 rounded-lg text-sm font-bold text-gray-500 hover:text-gray-700 transition-all">
                            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤
                        </button>
                    </div>

                    <div id="content-profile" class="space-y-4 text-sm animate-fade-in-up">
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 relative">
                            <i class="fa-solid fa-quote-left absolute top-2 left-2 text-blue-200 text-4xl -z-0"></i>
                            <p class="text-gray-700 relative z-10 italic">"${farmerBio}"</p>
                        </div>
                        
                        <div class="space-y-3">
                            <a href="tel:${farmerPhone}" 
                                class="flex items-center justify-between bg-white border border-gray-200 p-3 rounded-xl active:bg-gray-50 transition">
                                <span class="text-gray-500 text-xs">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</span>
                                <span class="font-bold text-gray-800 flex items-center gap-2">
                                    <i class="fa-solid fa-phone text-green-500"></i> ${farmerPhone}
                                </span>
                            </a>
                            <div class="flex items-center justify-between bg-white border border-gray-200 p-3 rounded-xl">
                                <span class="text-gray-500 text-xs">Line ID</span>
                                <span class="font-bold text-gray-800 flex items-center gap-2">
                                    <i class="fa-brands fa-line text-green-500"></i> ${farmerLine}
                                </span>
                            </div>
                            <div class="bg-white border border-gray-200 p-3 rounded-xl">
                                <span class="text-gray-500 text-xs block mb-1">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</span>
                                <span class="font-bold text-gray-800 flex items-start gap-2 text-xs leading-relaxed">
                                    <i class="fa-solid fa-location-dot text-red-500 mt-0.5"></i> ${farmerAddress}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div id="content-field" class="hidden space-y-4 text-sm animate-fade-in-up">
                        <div class="bg-white border border-gray-200 p-4 rounded-xl shadow-sm">
                            <div class="flex justify-between items-start mb-2 border-b border-gray-100 pb-2">
                                <span class="text-gray-400 text-xs">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤</span>
                                <span class="font-bold text-gray-800 text-lg">${s.field_name}</span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div>
                                    <span class="text-xs text-gray-400 block">‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Ç‡πâ‡∏≤‡∏ß</span>
                                    <span class="text-blue-600 font-bold">${s.variety_display}</span>
                                </div>
                                <div class="border-l border-gray-100">
                                    <span class="text-xs text-gray-400 block">‡∏Ç‡∏ô‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</span>
                                    <span class="text-gray-800 font-bold">${s.field_area} ‡πÑ‡∏£‡πà</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-green-50 border border-green-100 p-4 rounded-xl flex justify-between items-center">
                            <span class="font-bold text-green-800">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÄ‡∏™‡∏ô‡∏≠‡∏Ç‡∏≤‡∏¢</span>
                            <span class="text-2xl font-bold text-green-600">
                                ${s.quantity_ton} <span class="text-sm text-gray-500">‡∏ï‡∏±‡∏ô</span>
                            </span>
                        </div>
                        
                        <a href="${mapsLink}" target="_blank" 
                            class="block w-full py-4 rounded-xl font-bold text-center transition ${mapsBtnClass} flex items-center justify-center gap-2">
                            <i class="fa-solid fa-location-arrow text-lg"></i> ${btnText}
                        </a>
                    </div>
                </div>
            `,
            showCloseButton: true,
            showConfirmButton: false,
            customClass: {
                popup: 'rounded-2xl w-11/12 max-w-sm p-6'
            },
            didOpen: () => {
                const tabProfile = Swal.getHtmlContainer().querySelector('#tab-profile');
                const tabField = Swal.getHtmlContainer().querySelector('#tab-field');
                const contentProfile = Swal.getHtmlContainer().querySelector('#content-profile');
                const contentField = Swal.getHtmlContainer().querySelector('#content-field');

                const activeClass = ['bg-white', 'text-blue-600', 'shadow-sm'];
                const inactiveClass = ['text-gray-500', 'hover:text-gray-700'];

                tabProfile.onclick = () => {
                    tabProfile.classList.add(...activeClass);
                    tabProfile.classList.remove(...inactiveClass);
                    tabField.classList.remove(...activeClass);
                    tabField.classList.add(...inactiveClass);
                    contentProfile.classList.remove('hidden');
                    contentField.classList.add('hidden');
                };
                
                tabField.onclick = () => {
                    tabField.classList.add(...activeClass);
                    tabField.classList.remove(...inactiveClass);
                    tabProfile.classList.remove(...activeClass);
                    tabProfile.classList.add(...inactiveClass);
                    contentField.classList.remove('hidden');
                    contentProfile.classList.add('hidden');
                };
            }
        });
    }

    // ==========================================
    // 3. Confirm Buy Action
    // ==========================================
    window.confirmBuy = async function(e, saleId) {
        if (e) e.stopPropagation();
        const s = allSalesData.find(item => item.id === saleId);
        if (!s) return;

        const totalPrice = (s.quantity_ton * s.price_per_ton).toLocaleString();
        let defaultPrice = s.price_per_ton;

        const { isConfirmed, value: formValues } = await Swal.fire({
            title: '<span class="text-xl font-bold text-gray-800">ü§ù ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠</span>',
            html: `
                <div class="text-left space-y-4 px-1 pt-2">
                    <div class="bg-blue-50 border border-blue-100 rounded-xl p-4 space-y-2 text-sm">
                        <div class="flex justify-between items-center border-b border-blue-200 pb-2 mb-2">
                            <span class="text-gray-500">‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</span>
                            <span class="font-bold text-gray-800 text-base">${s.farmer_name}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
                            <span class="font-bold text-blue-700">${s.variety_display}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</span>
                            <span class="font-bold text-gray-800">${s.quantity_ton} ‡∏ï‡∏±‡∏ô</span>
                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-bold text-sm mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏™‡∏ô‡∏≠‡∏ã‡∏∑‡πâ‡∏≠ (‡∏ö‡∏≤‡∏ó/‡∏ï‡∏±‡∏ô)</label>
                        <div class="relative">
                            <input id="swal-price" type="number" inputmode="decimal" 
                                class="w-full pl-4 pr-12 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 outline-none text-xl font-bold text-green-700 text-right shadow-sm" 
                                value="${defaultPrice}" placeholder="0">
                            <span class="absolute right-4 top-3.5 text-gray-400 font-bold text-sm">‡∏ö‡∏≤‡∏ó</span>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-1 text-right">*‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏î‡πâ</p>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-bold text-sm mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö (‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)</label>
                        <div class="relative">
                            <div class="absolute left-4 top-3.5 text-gray-400">
                                <i class="fa-solid fa-phone"></i>
                            </div>
                            <input id="swal-contact" type="tel" inputmode="tel" 
                                class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 outline-none text-lg text-gray-800 shadow-sm" 
                                placeholder="08x-xxx-xxxx" 
                                value="{{ request.user.phone|default:'' }}">
                        </div>
                    </div>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            confirmButtonColor: '#16a34a',
            cancelButtonColor: '#64748b',
            reverseButtons: true,
            focusConfirm: false,
            customClass: {
                popup: 'rounded-2xl w-11/12 max-w-sm',
                confirmButton: 'w-full py-3 rounded-xl text-lg font-bold shadow-md mb-2',
                cancelButton: 'w-full py-3 rounded-xl text-lg font-bold bg-slate-200 text-slate-700 hover:bg-slate-300 border border-transparent shadow-sm'
            },
            preConfirm: () => {
                const price = document.getElementById('swal-price').value;
                const contact = document.getElementById('swal-contact').value;
                
                if (!price || !contact) {
                    Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                }
                return { price, contact };
            }
        });

        if (!isConfirmed) return;

        Swal.fire({ 
            title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 
            text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading() 
        });

        try {
            const res = await fetch(`/api/sales/${saleId}/request_buy/`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json', 
                    'X-CSRFToken': '{{ csrf_token }}' 
                },
                body: JSON.stringify({ 
                    contact: formValues.contact,
                    negotiated_price: formValues.price 
                })
            });

            if (res.ok) {
                Swal.fire({
                    icon: 'success',
                    title: '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
                    text: '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÅ‡∏•‡πâ‡∏ß',
                    timer: 2000,
                    showConfirmButton: false
                });
                loadData();
            } else {
                const data = await res.json();
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', data.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ', 'error');
            }
        } catch {
            Swal.fire('Error', '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á', 'error');
        }
    };

    // ==========================================
    // 4. Focus Map Function
    // ==========================================
    window.focusMap = function(saleId) {
        // Auto-switch to map on mobile
        if (window.innerWidth < 1024) {
            switchTab('map');
        }
        
        markers.eachLayer(function(layer) {
            if (layer.saleId === saleId) {
                map.flyToBounds(layer.getBounds().pad(1.5), { duration: 1 });
                setTimeout(() => {
                    layer.openPopup();
                }, 1000);
            }
        });
    }

    // ==========================================
    // 5. Initialize
    // ==========================================
    // Set initial tab for mobile
    if (window.innerWidth < 1024) {
        switchTab('list');
    }

    // Load initial data
    loadData();
    
    // Auto-refresh every 5 seconds
    setInterval(loadData, 5000); 
</script>
{% endblock %}