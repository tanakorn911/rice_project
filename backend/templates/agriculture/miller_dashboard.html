{% extends 'base.html' %}
{% block content %}
<div class="h-[calc(100vh-100px)] flex flex-col gap-6">
    
    <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative z-20">
        <div>
            <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fa-solid fa-industry text-blue-600"></i> ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÇ‡∏£‡∏á‡∏™‡∏µ (‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡πâ‡∏≤‡∏ß)
            </h1>
            <p class="text-sm text-gray-500 mt-1">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</p>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="relative">
                <button onclick="toggleNotif()" class="p-2.5 rounded-full hover:bg-gray-100 transition relative focus:outline-none group">
                    <i class="fa-solid fa-bell text-gray-500 text-xl group-hover:text-blue-600 transition-colors"></i>
                    <span id="notif-badge" class="absolute top-0 right-0 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden border-2 border-white transform translate-x-1 -translate-y-1 shadow-sm animate-pulse">0</span>
                </button>

                <div id="notif-dropdown" class="hidden absolute right-0 mt-4 w-96 bg-white rounded-xl shadow-2xl border border-gray-100 overflow-hidden z-50 animate-fade-in-up origin-top-right">
                    <div class="bg-gradient-to-r from-blue-50 to-white px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                        <span class="text-sm font-bold text-gray-700">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span>
                        <span class="text-xs text-blue-500 cursor-pointer hover:text-blue-700" onclick="markAllRead()">‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                    </div>
                    <div id="notif-list-container" class="max-h-80 overflow-y-auto custom-scrollbar bg-white p-0">
                        </div>
                </div>
            </div>

            <div class="bg-blue-50 text-blue-700 px-4 py-2 rounded-lg border border-blue-100 shadow-sm flex items-center">
                <span class="text-sm font-bold mr-2">üõí ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠:</span>
                <span id="sale-count" class="text-xl font-bold">0</span> 
                <span class="text-xs ml-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 flex-grow overflow-hidden">
        <div class="lg:col-span-4 bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col h-full overflow-hidden relative z-10">
            <div class="p-4 border-b border-gray-100 bg-gray-50/50 backdrop-blur flex justify-between items-center">
                <h3 class="font-bold text-gray-700 flex items-center">
                    <i class="fa-solid fa-bullhorn text-orange-500 mr-2"></i> ‡∏ï‡∏•‡∏≤‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏Ç‡πâ‡∏≤‡∏ß
                </h3>
                <div class="flex gap-2 text-[10px]">
                    <span class="bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full">‡∏£‡∏≠‡∏ã‡∏∑‡πâ‡∏≠</span>
                    <span class="bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full">‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>
                </div>
            </div>
            
            <div class="overflow-y-auto flex-grow p-4 space-y-3 custom-scrollbar relative" id="saleList">
                <div class="flex flex-col items-center justify-center h-40 text-gray-400 space-y-2">
                    <i class="fa-solid fa-circle-notch fa-spin text-2xl text-blue-200"></i>
                    <p class="text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                </div>
            </div>
            <div class="absolute bottom-0 left-0 w-full h-12 bg-gradient-to-t from-white to-transparent pointer-events-none"></div>
        </div>

        <div class="lg:col-span-8 bg-white rounded-2xl shadow-sm border border-gray-100 h-full relative flex flex-col group overflow-hidden">
            <div class="absolute top-4 left-4 z-[400] bg-white/95 backdrop-blur px-4 py-2 rounded-xl shadow-md border border-gray-200 pointer-events-none">
                <h2 class="text-sm font-bold text-gray-800 flex items-center gap-2">
                    <i class="fa-solid fa-map-location-dot text-blue-600"></i> ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤
                </h2>
            </div>
            <div id="map" class="w-full h-full rounded-2xl z-0 bg-slate-100"></div>
        </div>
    </div>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f8fafc; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
    .animate-fade-in-up { animation: fadeInUp 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
</style>
{% endblock %}

{% block scripts %}
<script>
    // ==========================================
    // 1. Map Setup
    // ==========================================
    var map = L.map('map', { center:[19.1667, 99.9000], zoom:11, zoomControl: false });
    L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{maxZoom:20,subdomains:['mt0','mt1','mt2','mt3']}).addTo(map);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    var markers = L.featureGroup().addTo(map);
    let lastReadTime = new Date(localStorage.getItem('millerLastRead') || 0);

    // ==========================================
    // 2. Main Data Loop
    // ==========================================
    async function loadData() {
        try {
            const res = await fetch('/api/sales/');
            const sales = await res.json();
            
            const listDiv = document.getElementById('saleList');
            const countSpan = document.getElementById('sale-count');
            
            // --- 2.1 ‡πÅ‡∏¢‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Sorting Logic) ---
            const openSales = sales.filter(s => s.status === 'OPEN').sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
            const closedSales = sales.filter(s => s.status === 'CLOSED').sort((a,b) => new Date(b.created_at) - new Date(a.created_at));

            // ‡∏£‡∏ß‡∏°‡∏Å‡∏•‡∏±‡∏ö ‡πÇ‡∏î‡∏¢‡πÄ‡∏≠‡∏≤ OPEN ‡πÑ‡∏ß‡πâ‡∏ö‡∏ô‡∏™‡∏∏‡∏î
            const sortedSales = [...openSales, ...closedSales];

            // --- 2.2 ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Notification ---
            const newOffers = openSales.filter(s => new Date(s.created_at) > lastReadTime);
            updateNotificationUI(newOffers);

            // --- 2.3 Render ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ---
            listDiv.innerHTML = '';
            markers.clearLayers();
            countSpan.innerText = openSales.length; 

            if (sortedSales.length === 0) {
                listDiv.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-400 opacity-60 mt-10"><i class="fa-solid fa-basket-shopping text-5xl mb-3"></i><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p></div>`;
                return;
            }

            sortedSales.forEach(s => {
                const isClosed = s.status === 'CLOSED';
                const totalPrice = (s.quantity_ton * s.price_per_ton).toLocaleString();
                const pricePerTon = s.price_per_ton.toLocaleString();
                const datePost = new Date(s.created_at).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' });
                
                // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á - )
                const fieldArea = s.field_area ? s.field_area : '-';

                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Style ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                let borderClass = isClosed ? "border-gray-300 opacity-60 grayscale-[50%]" : "border-l-4 border-l-orange-500";
                let badgeStatus = isClosed 
                    ? `<span class="bg-gray-200 text-gray-600 text-[10px] px-2 py-0.5 rounded-full font-bold">‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>`
                    : `<span class="bg-orange-100 text-orange-700 text-[10px] px-2 py-0.5 rounded-full font-bold animate-pulse">‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</span>`;
                
                let actionBtn = isClosed 
                    ? `<button class="w-full bg-gray-100 text-gray-400 font-bold py-2 rounded-lg cursor-not-allowed" disabled><i class="fa-solid fa-check"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</button>`
                    : `<button onclick="confirmBuy(event, ${s.id}, '${s.farmer_name}', '${totalPrice}', ${s.quantity_ton}, '${s.variety_display}', '${s.field_name}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg shadow transition-colors flex items-center justify-center gap-2"><i class="fa-solid fa-handshake"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</button>`;

                const isNew = !isClosed && new Date(s.created_at) > lastReadTime;
                const newBadge = isNew ? `<span class="ml-2 bg-red-100 text-red-600 text-[10px] px-1.5 py-0.5 rounded font-bold animate-bounce">NEW</span>` : '';

                listDiv.innerHTML += `
                    <div class="bg-white border border-gray-200 p-4 rounded-xl shadow-sm hover:shadow-md transition-all cursor-pointer group relative overflow-hidden ${borderClass} mb-3" onclick="focusMap(${s.id})">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                                    <i class="fa-solid fa-user-circle text-gray-400"></i> ${s.farmer_name} ${newBadge}
                                </h4>
                                <p class="text-xs text-gray-500 flex items-center gap-1"><i class="fa-solid fa-clock"></i> ${datePost} ${badgeStatus}</p>
                            </div>
                            <span class="bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded-lg">${s.quantity_ton} ‡∏ï‡∏±‡∏ô</span>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg border border-dashed border-gray-200 text-sm space-y-1 mb-3">
                            <div class="flex justify-between"><span class="text-gray-500">‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Ç‡πâ‡∏≤‡∏ß:</span><span class="font-semibold text-blue-600">${s.variety_display}</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà:</span><span class="font-semibold text-gray-700">${fieldArea} ‡πÑ‡∏£‡πà</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ï‡∏±‡∏ô:</span><span class="font-semibold">${pricePerTon} ‡∏ö.</span></div>
                            <div class="flex justify-between border-t border-gray-200 pt-1 mt-1"><span class="text-gray-700 font-bold">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°:</span><span class="font-bold text-green-600 text-lg">${totalPrice} ‡∏ö.</span></div>
                            <div class="flex justify-between items-center mt-2 pt-2 border-t border-dashed border-gray-300"><span class="text-gray-500"><i class="fa-solid fa-phone"></i> ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:</span><a href="tel:${s.phone}" class="font-bold text-gray-700 hover:text-blue-600">${s.phone}</a></div>
                        </div>
                        ${actionBtn}
                    </div>
                `;

                if(s.field_location) {
                    try {
                        const geoJson = JSON.parse(s.field_location);
                        const color = isClosed ? '#9ca3af' : '#f97316';
                        const opacity = isClosed ? 0.3 : 0.6;
                        const layer = L.geoJSON(geoJson, { style:{color: color, fillOpacity: opacity, weight: 2} })
                            .bindPopup(`<div class="text-center min-w-[150px]"><b class="text-lg text-gray-800">${s.farmer_name}</b><br><span class="text-${isClosed?'gray':'green'}-600 font-bold text-xl">${isClosed ? '‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : s.quantity_ton + ' ‡∏ï‡∏±‡∏ô'}</span><br><span class="text-xs text-gray-400">${s.variety_display} (${fieldArea} ‡πÑ‡∏£‡πà)</span></div>`);
                        layer.saleId = s.id;
                        markers.addLayer(layer);
                    } catch(e){}
                }
            });

        } catch(e) { console.error("Load Data Error:", e); }
    }

    // ==========================================
    // 3. Notification UI
    // ==========================================
    function updateNotificationUI(newOffers) {
        const badge = document.getElementById('notif-badge');
        const listContainer = document.getElementById('notif-list-container');
        
        if (newOffers.length > 0) {
            badge.innerText = newOffers.length;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }

        if (newOffers.length === 0) {
            listContainer.innerHTML = `<div class="p-8 text-center text-gray-400 text-sm"><i class="fa-regular fa-bell-slash text-2xl mb-2 opacity-50"></i><br>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</div>`;
        } else {
            listContainer.innerHTML = '';
            newOffers.forEach(s => {
                const time = new Date(s.created_at).toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
                listContainer.innerHTML += `
                    <div class="p-3 border-b border-gray-50 hover:bg-blue-50 cursor-pointer transition-colors" onclick="focusMap(${s.id})">
                        <div class="flex items-start gap-3">
                            <div class="bg-blue-100 text-blue-600 p-2 rounded-full h-8 w-8 flex items-center justify-center font-bold text-xs shrink-0">NEW</div>
                            <div>
                                <p class="text-sm font-bold text-gray-800 line-clamp-1">${s.farmer_name}</p>
                                <p class="text-xs text-gray-600">${s.quantity_ton} ‡∏ï‡∏±‡∏ô ‚Ä¢ ${s.variety_display}</p>
                                <p class="text-[10px] text-gray-400 mt-1">${time} ‡∏ô.</p>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
    }

    // ==========================================
    // 4. Actions
    // ==========================================
    window.focusMap = function(saleId) {
        markers.eachLayer(function(layer) {
            if(layer.saleId === saleId) {
                map.flyToBounds(layer.getBounds(), {padding:[100,100], maxZoom:15, duration:1.5});
                layer.openPopup();
            }
        });
        document.getElementById('notif-dropdown').classList.add('hidden');
    }

    window.confirmBuy = async function(e, saleId, farmerName, totalPrice, qty, variety, fieldName) {
        e.stopPropagation(); 
        Swal.fire({
            title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠?',
            html: `<div class="text-left bg-blue-50 p-4 rounded-lg border border-blue-100"><p><b>‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢:</b> ${farmerName}</p><p><b>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</b> ${variety} (${qty} ‡∏ï‡∏±‡∏ô)</p><p><b>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</b> <span class="text-green-600 text-xl font-bold">${totalPrice}</span> ‡∏ö‡∏≤‡∏ó</p></div>`,
            icon: 'question', showCancelButton: true, confirmButtonColor: '#16a34a', cancelButtonColor: '#d33', confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    const res = await fetch(`/api/sales/${saleId}/`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                        body: JSON.stringify({ status: 'CLOSED' })
                    });
                    if (res.ok) {
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                        loadData(); 
                    } else { Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error'); }
                } catch (error) { Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error'); }
            }
        });
    }

    window.toggleNotif = function() {
        document.getElementById('notif-dropdown').classList.toggle('hidden');
    }
    
    window.markAllRead = function() {
        lastReadTime = new Date();
        localStorage.setItem('millerLastRead', lastReadTime);
        loadData(); 
        document.getElementById('notif-dropdown').classList.add('hidden');
    }

    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('notif-dropdown');
        const button = event.target.closest('button');
        const isToggleBtn = button && button.getAttribute('onclick')?.includes('toggleNotif');
        const isInsideDropdown = event.target.closest('#notif-dropdown');
        if (!isToggleBtn && !isInsideDropdown && !dropdown.classList.contains('hidden')) {
            dropdown.classList.add('hidden');
        }
    });

    loadData();
    setInterval(loadData, 5000); 
</script>
{% endblock %}