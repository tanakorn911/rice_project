{% extends 'base.html' %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-100px)]">
    
    <div class="lg:col-span-4 flex flex-col gap-4 h-full">
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center relative z-20">
            <div>
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <span class="bg-green-100 text-green-700 p-2 rounded-lg"><i class="fa-solid fa-list-ul"></i></span>
                    ‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                </h2>
                <p class="text-xs text-gray-400 mt-1 pl-11">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï</p>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="relative">
                    <button onclick="toggleNotif()" class="p-2 rounded-full hover:bg-gray-100 transition relative focus:outline-none">
                        <i class="fa-solid fa-bell text-gray-500 text-xl transition-colors hover:text-green-600"></i>
                        <span id="notif-badge" class="absolute top-0 right-0 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden border-2 border-white transform translate-x-1 -translate-y-1 shadow-sm">0</span>
                    </button>

                    <div id="notif-dropdown" class="hidden absolute right-0 mt-3 w-80 bg-white rounded-xl shadow-xl border border-gray-100 overflow-hidden z-50 animate-fade-in-down">
                        <div class="bg-gray-50 px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                            <span class="text-sm font-bold text-gray-700"><i class="fa-solid fa-clock-rotate-left"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</span>
                            <span class="text-xs text-blue-500 cursor-pointer hover:text-blue-700 hover:underline" onclick="markAllRead()">‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span>
                        </div>
                        <div id="notif-list" class="max-h-72 overflow-y-auto custom-scrollbar bg-white">
                            <div class="p-6 text-center text-gray-400 text-sm flex flex-col items-center">
                                <i class="fa-regular fa-bell-slash text-2xl mb-2 opacity-50"></i>
                                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-right border-l pl-3 ml-2">
                    <span id="field-count" class="text-2xl font-bold text-green-600">0</span>
                    <span class="text-xs text-gray-400 block">‡πÅ‡∏õ‡∏•‡∏á</span>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 flex-grow overflow-hidden relative z-10">
            <div id="fieldList" class="absolute inset-0 p-4 space-y-3 overflow-y-auto custom-scrollbar pb-20">
                <div class="flex flex-col items-center justify-center h-full text-gray-400 space-y-3 animate-pulse">
                    <i class="fa-solid fa-circle-notch fa-spin text-3xl text-green-200"></i>
                    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                </div>
            </div>
            <div class="absolute bottom-0 left-0 w-full h-10 bg-gradient-to-t from-white to-transparent pointer-events-none"></div>
        </div>
    </div>

    <div class="lg:col-span-8 h-full">
        <div class="bg-white p-1 rounded-2xl shadow-lg border border-gray-100 h-full flex flex-col relative overflow-hidden group">
            <div class="absolute top-4 left-14 z-[400] bg-white/95 backdrop-blur-md px-4 py-2 rounded-xl shadow-md border border-gray-200 pointer-events-none transition-opacity group-hover:opacity-100">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i class="fa-solid fa-map-location-dot text-blue-600"></i> ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏Å‡∏©‡∏ï‡∏£
                </h2>
                <div class="flex items-center gap-2 mt-1">
                    <span class="text-[10px] bg-green-500 text-white px-2 py-0.5 rounded-full shadow-sm flex items-center gap-1"><i class="fa-solid fa-wifi text-[8px]"></i> Online</span>
                    <span class="text-[10px] bg-blue-500 text-white px-2 py-0.5 rounded-full shadow-sm">üìç ‡∏à.‡∏û‡∏∞‡πÄ‡∏¢‡∏≤</span>
                </div>
            </div>
            <div id="map" class="w-full h-full rounded-xl z-0 bg-gray-100"></div>
        </div>
    </div>
</div>

<style>
    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f8fafc; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    /* Animation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dropdown */
    @keyframes fadeInDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-down { animation: fadeInDown 0.2s ease-out; }

    /* SweetAlert Tweaks */
    .swal2-input, .swal2-select { 
        border: 1px solid #e2e8f0 !important; border-radius: 12px !important; 
        height: 45px !important; margin: 10px auto !important; box-shadow: none !important;
    }
    .swal2-input:focus, .swal2-select:focus { border-color: #22c55e !important; ring: 2px solid #bbf7d0 !important; }
    .swal2-popup { border-radius: 20px !important; padding: 2rem !important; font-family: 'Kanit', sans-serif; }
</style>
{% endblock %}

{% block scripts %}
<script>
    // ==========================================
    // 1. Map Initialization & Configuration
    // ==========================================
    var googleHybrid = L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: 'Google Hybrid' });
    var googleSat = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: 'Google Satellite' });
    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'OpenStreetMap' });

    var map = L.map('map', { 
        center: [19.1667, 99.9000], zoom: 12, 
        layers: [googleHybrid], zoomControl: false 
    });

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°
    L.control.layers({ "‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° (‡∏ú‡∏™‡∏°)": googleHybrid, "‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° (‡∏•‡πâ‡∏ß‡∏ô)": googleSat, "‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏ô‡∏ô": osm }, null, {position: 'topright'}).addTo(map);
    L.control.scale({ imperial: false, metric: true, position: 'bottomleft' }).addTo(map);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    var drawnItems = new L.FeatureGroup().addTo(map);
    var fieldLayers = {}; 
    var lastStatusMap = {}; // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô)

    // ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏≤‡∏î‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤
    map.addControl(new L.Control.Draw({
        position: 'topright',
        draw: { polygon: true, rectangle: true, marker: false, circle: false, polyline: false },
        edit: { featureGroup: drawnItems, remove: false } 
    }));

    // ‡∏õ‡∏∏‡πà‡∏° Locate Me
    var LocateControl = L.Control.extend({
        options: { position: 'bottomright' },
        onAdd: function (map) {
            var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
            container.innerHTML = '<a href="#" class="bg-white hover:bg-gray-50 text-blue-600 w-8 h-8 flex items-center justify-center rounded shadow-sm transition-colors"><i class="fa-solid fa-crosshairs"></i></a>';
            container.onclick = function(e) { e.preventDefault(); map.locate({setView: true, maxZoom: 18}); };
            return container;
        }
    });
    map.addControl(new LocateControl());
    
    map.on('locationfound', function(e) {
        if (window.currentPosMarker) map.removeLayer(window.currentPosMarker);
        window.currentPosMarker = L.marker(e.latlng).addTo(map).bindPopup("‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà").openPopup();
    });

    // ==========================================
    // 2. Event Handlers (Drawing)
    // ==========================================
    map.on(L.Draw.Event.CREATED, function (e) {
        var layer = e.layer;
        var center = layer.getBounds().getCenter();
        
        // Simple Geofence Check (Phayao)
        if (center.lng < 99.80 || center.lng > 100.10 || center.lat < 19.00 || center.lat > 19.35) {
            Swal.fire({ icon: 'error', title: '‡∏ô‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà!', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏î‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à.‡∏û‡∏∞‡πÄ‡∏¢‡∏≤ ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô' });
            return;
        }

        Swal.fire({
            title: 'üå± ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà',
            html: `
                <div class="text-left space-y-3">
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤</label><input id="swal-name" class="swal2-input w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà 1"></div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Ç‡πâ‡∏≤‡∏ß</label>
                        <select id="swal-variety" class="swal2-select w-full">
                            <option value="KDML105">üçö ‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥ 105</option>
                            <option value="RD6">üçô ‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß ‡∏Å‡∏Ç 6</option>
                            <option value="RD15">üçö ‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥ ‡∏Å‡∏Ç 15</option>
                            <option value="PATHUM1">üåæ ‡∏Ç‡πâ‡∏≤‡∏ß‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ 1</option>
                            <option value="OTHER">üå± ‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
                        </select>
                    </div>
                </div>
            `,
            showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', confirmButtonColor: '#16a34a', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            preConfirm: () => {
                const name = document.getElementById('swal-name').value;
                if(!name) Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤');
                return { name, variety: document.getElementById('swal-variety').value }
            }
        }).then((result) => {
            if (result.isConfirmed) saveField(result.value.name, layer.toGeoJSON().geometry, result.value.variety);
        });
    });

    async function saveField(name, geom, variety) {
        try {
            const res = await fetch('/api/rice-fields/', {
                method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
                body: JSON.stringify({name, geometry: geom, variety})
            });
            if(res.ok) { 
                Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1500, showConfirmButton: false });
                loadFields(); 
            }
        } catch(e) { Swal.fire('Error', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); }
    }

    // ==========================================
    // 3. Core Logic: Load Data & Real-time Update
    // ==========================================
    async function loadFields() {
        try {
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 2 API ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
            const [fieldRes, saleRes] = await Promise.all([fetch('/api/rice-fields/'), fetch('/api/sales/')]);
            const fields = await fieldRes.json();
            const sales = await saleRes.json();
            
            // Map ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (Key = FieldID) ‡πÅ‡∏•‡∏∞‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß
            const saleMap = {};
            const soldList = []; 
            sales.forEach(s => { 
                // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á
                if (!saleMap[s.rice_field]) { saleMap[s.rice_field] = s; }
                // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡πâ‡∏≤ Notification List
                if (s.status === 'CLOSED') { soldList.push(s); }
            });

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            updateNotifications(soldList);

            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå UI ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤
            const listContainer = document.getElementById('fieldList');
            document.getElementById('field-count').innerText = fields.length;
            listContainer.innerHTML = '';
            drawnItems.clearLayers();
            fieldLayers = {};

            if (fields.length === 0) {
                listContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-gray-400 opacity-60"><i class="fa-solid fa-vector-square text-5xl mb-3"></i><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤</p><p class="text-xs">‡∏ß‡∏≤‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p></div>`;
                return;
            }

            fields.forEach(f => {
                const activeSale = saleMap[f.id];
                const status = activeSale ? activeSale.status : 'NONE';

                // --- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Popup ---
                if (lastStatusMap[f.id] === 'OPEN' && status === 'CLOSED') {
                    Swal.fire({
                        title: 'üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                        html: `‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤ <b>"${f.name}"</b><br>‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
                        icon: 'success', timer: 5000, timerProgressBar: true
                    });
                }
                lastStatusMap[f.id] = status; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î

                // --- ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Style ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ---
                let borderClass = "border-l-green-500", bgHover = "hover:bg-green-50";
                let statusBadge = "", actionButtons = "";
                let polyColor = "#22c55e", dashArray = '5, 5';

                if (status === 'OPEN') { // ‡∏£‡∏≠‡∏Ç‡∏≤‡∏¢
                    borderClass = "border-l-orange-500"; bgHover = "hover:bg-orange-50";
                    polyColor = "#f97316"; dashArray = null;
                    statusBadge = `<span class="absolute top-2 right-10 text-[10px] bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full font-bold border border-orange-200 shadow-sm animate-pulse"><i class="fa-solid fa-clock"></i> ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</span>`;
                    actionButtons = `<div class="col-span-2"><button onclick="cancelSale(${activeSale.id}, '${f.name}')" class="w-full flex items-center justify-center gap-2 bg-red-50 hover:bg-red-100 text-red-600 text-xs font-bold py-2.5 rounded-lg transition-all border border-red-100"><i class="fa-solid fa-xmark"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button></div>`;
                
                } else if (status === 'CLOSED') { // ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß
                    borderClass = "border-l-yellow-500"; bgHover = "hover:bg-yellow-50";
                    polyColor = "#eab308"; dashArray = null;
                    statusBadge = `<span class="absolute top-2 right-10 text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-bold border border-green-200 shadow-sm"><i class="fa-solid fa-check-circle"></i> ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>`;
                    actionButtons = `<div class="col-span-2"><div class="text-center text-xs text-gray-500 py-2 bg-gray-50 rounded-lg border border-gray-100 flex items-center justify-center gap-2"><i class="fa-solid fa-handshake text-green-500"></i> ‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</div></div>`;
                
                } else { // ‡∏õ‡∏Å‡∏ï‡∏¥
                    // Logic ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà
                    let calcBtnText = '<i class="fa-solid fa-satellite-dish"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå';
                    let calcBtnColor = 'bg-gradient-to-r from-orange-400 to-orange-500 hover:from-orange-500 hover:to-orange-600';
                    if (f.latest_yield) {
                        calcBtnText = '<i class="fa-solid fa-rotate"></i> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà';
                        calcBtnColor = 'bg-gradient-to-r from-blue-400 to-blue-500 hover:from-blue-500 hover:to-blue-600';
                    }
                    actionButtons = `
                        <button onclick="calcYield(${f.id})" class="flex items-center justify-center gap-2 ${calcBtnColor} text-white text-xs font-bold py-2.5 rounded-lg shadow-sm active:scale-95 transition-all">${calcBtnText}</button>
                        <button onclick="notifySale(${f.id}, '${f.name}')" class="flex items-center justify-center gap-2 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white text-xs font-bold py-2.5 rounded-lg shadow-sm active:scale-95 transition-all"><i class="fa-solid fa-bullhorn"></i> ‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡∏≤‡∏¢</button>
                    `;
                }

                // --- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Yield ---
                let yieldContent = f.latest_yield ? 
                    `<div class="grid grid-cols-2 gap-4 text-center divide-x divide-green-200">
                        <div><p class="text-[10px] text-gray-500 uppercase">‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏û‡∏∑‡∏ä‡∏û‡∏£‡∏£‡∏ì (NDVI)</p><p class="text-lg font-bold text-green-700">${f.latest_yield.ndvi.toFixed(3)}</p></div>
                        <div><p class="text-[10px] text-gray-500 uppercase">‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï</p><p class="text-lg font-bold text-orange-600">${f.latest_yield.yield.toFixed(2)} <span class="text-xs text-gray-400 font-normal">‡∏ï‡∏±‡∏ô</span></p></div>
                    </div>` : '<p class="text-xs opacity-60">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
                let yieldClass = f.latest_yield ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-dashed border-gray-200 text-gray-400';

                // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏Å‡∏≤‡∏£‡πå‡∏î ---
                const card = document.createElement('div');
                card.className = `bg-white border border-gray-100 p-4 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 relative group overflow-hidden border-l-4 ${borderClass} mb-2`;
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="pr-2 overflow-hidden cursor-pointer ${bgHover} rounded p-1 transition-colors w-full" onclick="focusField(${f.id})">
                            <h3 class="font-bold text-gray-800 text-lg truncate flex items-center gap-2" title="${f.name}">${f.name} <i class="fa-solid fa-magnifying-glass-location text-gray-300 text-xs opacity-50"></i></h3>
                            ${statusBadge}
                            <div class="flex flex-wrap items-center gap-2 mt-1">
                                <span class="text-[10px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded-md flex items-center"><i class="fa-solid fa-seedling text-green-500 mr-1"></i> ${f.variety_display || f.variety}</span>
                                <span class="text-[10px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded-md flex items-center"><i class="fa-solid fa-chart-area text-blue-500 mr-1"></i> ${f.area_rai} ‡πÑ‡∏£‡πà</span>
                            </div>
                        </div>
                        <button onclick="deleteField(${f.id}, '${f.name}')" class="flex-shrink-0 text-gray-300 hover:text-red-500 bg-white rounded-full p-1.5 hover:bg-red-50 ml-2 z-10 transition-colors"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                    <div id="yield-info-${f.id}" class="my-3 p-3 rounded-lg border ${yieldClass} text-center transition-all duration-500">${yieldContent}</div>
                    <div class="grid grid-cols-2 gap-2 mt-2">${actionButtons}</div>
                `;
                listContainer.appendChild(card);

                // --- ‡∏ß‡∏≤‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ---
                if(f.boundary) {
                    try {
                        const geoJsonData = (typeof f.boundary === 'string') ? JSON.parse(f.boundary) : f.boundary;
                        const layer = L.geoJSON(geoJsonData, {
                            style: { color: polyColor, weight: 2, fillOpacity: 0.3, dashArray: dashArray }
                        }).bindPopup(`<div class="text-center"><b class="text-gray-800">${f.name}</b><br><span class="text-xs text-gray-500">${f.area_rai} ‡πÑ‡∏£‡πà</span></div>`).addTo(map).addTo(drawnItems);
                        fieldLayers[f.id] = layer;
                    } catch(e) {}
                }
            });
        } catch (error) { console.error(error); }
    }

    // ==========================================
    // 4. Notification System
    // ==========================================
    function updateNotifications(soldList) {
        const listDiv = document.getElementById('notif-list');
        const badge = document.getElementById('notif-badge');
        
        // Logic ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö localStorage)
        const totalSold = soldList.length;
        const seenCount = parseInt(localStorage.getItem('seenNotif') || '0');
        const unread = Math.max(0, totalSold - seenCount);

        if (unread > 0) {
            badge.innerText = unread > 9 ? '9+' : unread;
            badge.classList.remove('hidden');
            badge.classList.add('animate-bounce'); // ‡πÄ‡∏û‡∏¥‡πà‡∏° Animation ‡πÄ‡∏î‡πâ‡∏á‡∏î‡∏∂‡πã‡∏á
        } else {
            badge.classList.add('hidden');
            badge.classList.remove('animate-bounce');
        }

        if (soldList.length === 0) {
            listDiv.innerHTML = `<div class="p-8 text-center text-gray-400 text-sm flex flex-col items-center"><i class="fa-regular fa-bell-slash text-2xl mb-2 opacity-50"></i>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>`;
            return;
        }

        listDiv.innerHTML = '';
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î
        soldList.sort((a,b) => b.id - a.id).forEach(s => {
            const total = (s.quantity_ton * s.price_per_ton).toLocaleString();
            const date = new Date(s.created_at).toLocaleDateString('th-TH', {day:'numeric', month:'short'});
            
            listDiv.innerHTML += `
                <div class="p-3 border-b border-gray-50 hover:bg-green-50 cursor-pointer transition-colors" onclick="focusField(${s.rice_field})">
                    <div class="flex items-start gap-3">
                        <div class="bg-green-100 text-green-600 p-2 rounded-full shadow-sm"><i class="fa-solid fa-hand-holding-dollar"></i></div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <p class="text-sm font-bold text-gray-800">‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</p>
                                <span class="text-[10px] text-gray-400">${date}</span>
                            </div>
                            <p class="text-xs text-gray-500">‡πÅ‡∏õ‡∏•‡∏á: ${s.field_name}</p>
                            <p class="text-xs text-green-600 font-bold mt-1">üí∞ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô: ${total} ‡∏ö‡∏≤‡∏ó</p>
                        </div>
                    </div>
                </div>
            `;
        });
    }

    window.toggleNotif = function() {
        const dropdown = document.getElementById('notif-dropdown');
        dropdown.classList.toggle('hidden');
        
        if (!dropdown.classList.contains('hidden')) {
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πâ‡∏≤‡∏á List)
            const itemsCount = document.querySelectorAll('#notif-list > div').length;
            const hasEmptyMsg = document.getElementById('notif-list').innerText.includes('‡πÑ‡∏°‡πà‡∏°‡∏µ');
            const realCount = hasEmptyMsg ? 0 : itemsCount;
            
            // ‡∏ã‡πà‡∏≠‡∏ô Badge ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠ UX ‡∏ó‡∏µ‡πà‡∏î‡∏µ
            document.getElementById('notif-badge').classList.add('hidden');
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß
            localStorage.setItem('seenNotif', realCount);
        }
    }

    window.markAllRead = function() {
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏ã‡πà‡∏≠‡∏ô Badge ‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏à‡∏à‡∏∞ Clear list ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
        document.getElementById('notif-badge').classList.add('hidden');
        // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á List ‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API Delete (‡πÅ‡∏ï‡πà‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÅ‡∏Ñ‡πà Mark as read)
        Swal.fire({ icon: 'success', title: '‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß', toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
    }

    // ==========================================
    // 5. Action Functions
    // ==========================================
    window.focusField = function(id) {
        if (fieldLayers[id]) {
            map.flyToBounds(fieldLayers[id].getBounds(), { padding: [100, 100], maxZoom: 18, duration: 1.5 });
            fieldLayers[id].openPopup();
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô Notification ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î Dropdown ‡∏î‡πâ‡∏ß‡∏¢
            document.getElementById('notif-dropdown').classList.add('hidden');
        }
    }

    window.deleteField = function(id, name) {
        Swal.fire({
            title: '‡∏•‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤?', text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${name}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, icon: 'warning',
            showCancelButton: true, confirmButtonColor: '#ef4444', confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
        }).then(async (result) => {
            if (result.isConfirmed) { await fetch(`/api/rice-fields/${id}/`, { method: 'DELETE', headers: {'X-CSRFToken': csrftoken} }); loadFields(); }
        });
    }

    window.notifySale = function(fieldId, fieldName) {
        Swal.fire({
            title: 'üì¢ ‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡∏≤‡∏¢‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï',
            html: `
                <div class="text-left bg-green-50 p-3 rounded-lg border border-green-100 mb-4"><p class="text-green-800 text-sm font-bold"><i class="fa-solid fa-location-dot mr-1"></i> ${fieldName}</p></div>
                <div class="space-y-3">
                    <input id="sale-qty" type="number" class="swal2-input w-full" placeholder="‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì (‡∏ï‡∏±‡∏ô)">
                    <input id="sale-price" type="number" class="swal2-input w-full" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏™‡∏ô‡∏≠‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó/‡∏ï‡∏±‡∏ô)">
                    <input id="sale-phone" type="tel" class="swal2-input w-full" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö">
                </div>
            `,
            showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢', confirmButtonColor: '#16a34a', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            preConfirm: () => {
                const q = document.getElementById('sale-qty').value, p = document.getElementById('sale-price').value, ph = document.getElementById('sale-phone').value;
                if(!q || !p || !ph) Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
                return { rice_field: fieldId, quantity_ton: q, price_per_ton: p, phone: ph }
            }
        }).then(async (result) => {
            if(result.isConfirmed) {
                const res = await fetch('/api/sales/', { method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken}, body: JSON.stringify(result.value) });
                if(res.ok) { Swal.fire({ icon:'success', title: '‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1500, showConfirmButton: false }); loadFields(); }
            }
        });
    }

    window.cancelSale = function(saleId, fieldName) {
        Swal.fire({ title: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢?', text: `‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á "${fieldName}"?`, icon: 'question', showCancelButton: true, confirmButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®', confirmButtonColor: '#ef4444' }).then(async (result) => {
            if (result.isConfirmed) { await fetch(`/api/sales/${saleId}/`, { method: 'DELETE', headers: {'X-CSRFToken': csrftoken} }); loadFields(); }
        });
    }

    window.calcYield = async function(id) {
        const div = document.getElementById(`yield-info-${id}`);
        div.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin text-orange-500"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°...`;
        
        try {
            const res = await fetch(`/api/rice-fields/${id}/calculate_yield/`, { method: 'POST', headers: {'X-CSRFToken': csrftoken} });
            const data = await res.json();
            
            if(res.ok) {
                loadFields(); // ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
                Toast.fire({ icon: 'success', title: '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });
            } else {
                div.innerHTML = `<span class="text-red-500 text-xs"><i class="fa-solid fa-triangle-exclamation"></i> ${data.error}</span>`;
            }
        } catch(e) { div.innerHTML = `<span class="text-red-500 text-xs">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</span>`; }
    }

    // Start App & Real-time Update (5 Sec)
    loadFields();
    setInterval(loadFields, 5000); 

    // ‡∏õ‡∏¥‡∏î Dropdown ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('notif-dropdown');
        const button = event.target.closest('button');
        if (!dropdown.contains(event.target) && (!button || !button.getAttribute('onclick')?.includes('toggleNotif'))) {
            dropdown.classList.add('hidden');
        }
    });
</script>
{% endblock %}