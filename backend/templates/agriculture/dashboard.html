{% extends 'base.html' %}

{% block content %}
<div class="h-[calc(100vh-80px)] flex flex-col lg:grid lg:grid-cols-12 lg:gap-6 relative">
    
    <div id="view-list" class="flex-grow lg:col-span-4 flex flex-col gap-3 h-full overflow-hidden transition-all duration-300">
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center shrink-0">
            <div>
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i class="fa-solid fa-seedling text-green-600"></i> ‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì {{ request.user.first_name|default:request.user.username }}
                </h2>
                
            </div>
            <div class="flex items-center gap-2">
                <button onclick="openTrash()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 hover:text-red-500 flex items-center justify-center transition"><i class="fa-solid fa-trash-can"></i></button>
                <div class="bg-green-50 text-green-700 px-3 py-1 rounded-lg text-xs font-bold border border-green-100"><span id="field-count">0</span> ‡πÅ‡∏õ‡∏•‡∏á</div>
            </div>
        </div>

        <div class="flex-grow overflow-y-auto custom-scrollbar pb-20 lg:pb-0 relative bg-white/50 rounded-2xl border border-gray-100/50">
            <div id="fieldList" class="p-3 space-y-3 absolute inset-0">
                <div class="flex flex-col items-center justify-center h-full text-gray-400 opacity-60"><i class="fa-solid fa-circle-notch fa-spin text-3xl mb-2"></i><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>
            </div>
        </div>
    </div>
    
    <div id="view-map" class="hidden lg:block lg:col-span-8 h-full bg-white rounded-2xl shadow-lg border border-gray-100 relative overflow-hidden group">
        <div id="map" class="w-full h-full z-0 bg-slate-100"></div>
        <div class="absolute top-4 left-4 z-[500] lg:hidden bg-white/90 backdrop-blur px-3 py-1.5 rounded-lg shadow-md border border-gray-200">
            <span class="text-xs font-bold text-gray-600 flex items-center gap-1"><i class="fa-solid fa-location-dot text-blue-500"></i> ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-[1002] lg:hidden flex justify-around items-center h-16 pb-safe">
        <button onclick="switchTab('list')" id="btn-tab-list" class="flex flex-col items-center justify-center w-1/2 h-full text-green-600 border-t-2 border-green-600 bg-green-50/50">
            <i class="fa-solid fa-list-ul text-xl mb-1"></i>
            <span class="text-[10px] font-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        </button>
        <button onclick="switchTab('map')" id="btn-tab-map" class="flex flex-col items-center justify-center w-1/2 h-full text-gray-400 border-t-2 border-transparent hover:bg-gray-50">
            <i class="fa-solid fa-map-location-dot text-xl mb-1"></i>
            <span class="text-[10px] font-bold">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</span>
        </button>
    </div>

</div>

<div id="saleModal" class="fixed inset-0 z-[999] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm transition-opacity">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 relative transform transition-transform scale-95 opacity-0" id="saleModalContent">
        <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
        <div class="text-center">
            <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-4"><i class="fa-solid fa-handshake"></i></div>
            <h3 class="text-xl font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h3>
            <span class="bg-green-50 text-green-700 px-3 py-1 rounded-full text-xs font-bold mt-1 inline-block border border-green-100">‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>
            <div class="mt-6 space-y-4 text-left">
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <h4 class="text-xs font-bold text-blue-500 uppercase mb-2">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠ (Buyer)</h4>
                    <div class="flex items-center gap-3 mb-2"><div class="w-8 h-8 bg-white rounded-full flex items-center justify-center text-blue-500 shadow-sm"><i class="fa-solid fa-industry"></i></div><div><p class="text-xs text-gray-400">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡∏™‡∏µ/‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠</p><p class="font-bold text-gray-700" id="modal-buyer-name">-</p></div></div>
                    <div class="flex items-center gap-3"><div class="w-8 h-8 bg-white rounded-full flex items-center justify-center text-blue-500 shadow-sm"><i class="fa-solid fa-phone"></i></div><div><p class="text-xs text-gray-400">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</p><a href="#" id="modal-buyer-phone-link" class="font-bold text-gray-700 hover:text-blue-600 transition">-</a></div></div>
                </div>
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 space-y-2 text-sm">
                    <div class="flex justify-between"><span class="text-gray-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢</span><span class="font-bold text-gray-800" id="modal-sold-at">-</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</span><span class="font-bold text-gray-800"><span id="modal-qty">0</span> ‡∏ï‡∏±‡∏ô</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ï‡∏±‡∏ô</span><span class="font-bold text-gray-800"><span id="modal-price">0</span> ‡∏ö.</span></div>
                    <div class="border-t pt-2 flex justify-between items-center mt-2"><span class="font-bold text-gray-700">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span><span class="font-bold text-green-600 text-xl"><span id="modal-total">0</span> ‡∏ö.</span></div>
                </div>
            </div>
            <button onclick="closeModal()" class="mt-5 w-full bg-gray-800 hover:bg-gray-900 text-white py-2.5 rounded-xl font-bold text-sm transition shadow-lg shadow-gray-200">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
    </div>
</div>

<div id="trashModal" class="fixed inset-0 z-[2000] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="bg-white rounded-2xl w-full max-w-md p-5 relative shadow-2xl flex flex-col max-h-[80vh]" id="trashModalContent">
        <button onclick="closeTrash()" class="absolute top-3 right-3 text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
        <h3 class="text-lg font-bold mb-3 text-gray-800 flex items-center gap-2"><i class="fa-solid fa-trash-arrow-up text-red-500"></i> ‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞</h3>
        <div id="trash-list" class="overflow-y-auto flex-grow custom-scrollbar pr-2 space-y-2"></div>
    </div>
</div>

<div id="loading-overlay" class="fixed inset-0 z-[3000] hidden bg-black/60 backdrop-blur-sm flex items-center justify-center flex-col text-white">
    <i class="fa-solid fa-circle-notch fa-spin text-4xl mb-3"></i><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
</div>

{% endblock %}

{% block scripts %}
<script>
    // === Mobile Tab Logic ===
    function switchTab(tab) {
        const listBtn = document.getElementById('btn-tab-list');
        const mapBtn = document.getElementById('btn-tab-map');
        const listView = document.getElementById('view-list');
        const mapView = document.getElementById('view-map');

        if (tab === 'list') {
            listView.classList.remove('hidden'); mapView.classList.add('hidden');
            listBtn.className = "flex flex-col items-center justify-center w-1/2 h-full text-green-600 border-t-2 border-green-600 bg-green-50/50 transition-all";
            mapBtn.className = "flex flex-col items-center justify-center w-1/2 h-full text-gray-400 border-t-2 border-transparent transition-all";
        } else {
            listView.classList.add('hidden'); mapView.classList.remove('hidden');
            mapBtn.className = "flex flex-col items-center justify-center w-1/2 h-full text-blue-600 border-t-2 border-blue-600 bg-blue-50/50 transition-all";
            listBtn.className = "flex flex-col items-center justify-center w-1/2 h-full text-gray-400 border-t-2 border-transparent transition-all";
            setTimeout(() => { map.invalidateSize(); }, 200);
        }
    }

    // === Map & Data Logic (Full) ===
    var phayaoBounds = [[18.90, 99.70], [19.80, 100.65]];
    var googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{ maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: 'Google Streets' });
    var googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{ maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: 'Google Satellite' });
    var googleHybrid = L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: 'Google Hybrid' });
    var baseMaps = { "‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏ô‡∏ô": googleStreets, "‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡∏•‡πâ‡∏ß‡∏ô": googleSat, "‡∏ú‡∏™‡∏° (Hybrid)": googleHybrid };
    var overlayMaps = {}; 

    var map = L.map('map', { center: [19.1667, 99.9000], zoom: 13, layers: [googleHybrid], zoomControl: false, maxBounds: phayaoBounds, maxBoundsViscosity: 1.0, minZoom: 10 });
    var layerControl = L.control.layers(baseMaps, overlayMaps).addTo(map);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    var drawnItems = new L.FeatureGroup().addTo(map);
    var fieldLayers = {}; 
    var satelliteLayer = null; 
    var allFieldsData = []; 
    var saleMapData = {};   

    map.addControl(new L.Control.Draw({ position: 'topright', draw: { polygon: true, rectangle: true, marker: false, circle: false, polyline: false }, edit: { featureGroup: drawnItems, remove: false } }));

    var LocateControl = L.Control.extend({
        options: { position: 'bottomright' },
        onAdd: function (map) {
            var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
            container.innerHTML = '<a href="#" class="bg-white hover:bg-gray-50 text-blue-600 w-8 h-8 flex items-center justify-center rounded shadow-sm transition-colors" title="‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô"><i class="fa-solid fa-crosshairs"></i></a>';
            container.onclick = function(e) { e.preventDefault(); map.locate({ setView: false, enableHighAccuracy: true }); Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î...', didOpen: () => Swal.showLoading(), timer: 5000, showConfirmButton: false, background: 'transparent', color: '#fff' }); };
            return container;
        }
    });
    map.addControl(new LocateControl());

    map.on('locationfound', function(e) { 
        Swal.close();
        if (!map.getBounds().contains(e.latlng)) { Swal.fire({ icon: 'warning', title: '‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà', text: '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏û‡∏∞‡πÄ‡∏¢‡∏≤' }); return; }
        map.flyTo(e.latlng, 17, { duration: 1.5 });
        L.circle(e.latlng, { radius: e.accuracy / 2, color: '#3b82f6', fillOpacity: 0, weight: 1 }).addTo(map);
        L.popup().setLatLng(e.latlng).setContent('<div class="text-center"><b>‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</b><br><span class="text-xs text-gray-400">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥: ' + Math.round(e.accuracy) + ' ‡∏°.</span></div>').openOn(map);
    });
    
    map.on('locationerror', function(e) { Swal.fire({ icon: 'error', title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', timer: 5000, showConfirmButton: false }); });
    L.rectangle(phayaoBounds, { color: "#ff9800", weight: 3, fillOpacity: 0, dashArray: '10, 10', interactive: false }).addTo(map);
    L.marker([19.80, 100.65], { icon: L.divIcon({ className: 'text-label', html: '<span class="bg-orange-500 text-white px-2 py-1 rounded text-xs shadow-md whitespace-nowrap font-bold">‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏û‡∏∞‡πÄ‡∏¢‡∏≤</span>', iconSize: [250, 20], iconAnchor: [135, -5] }) }).addTo(map);

    // Draw Event
    map.on(L.Draw.Event.CREATED, async function (e) {
        var layer = e.layer;
        var center = layer.getBounds().getCenter();
        if (center.lng < 99.70 || center.lng > 100.65 || center.lat < 18.90 || center.lat > 19.80) { Swal.fire({ icon: 'error', title: '‡∏ô‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà!', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏î‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏û‡∏∞‡πÄ‡∏¢‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', timer: 3000, showConfirmButton: false }); return; }
        const { value: formValues } = await Swal.fire({
            title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà',
            html: `<div class="text-left space-y-3"><div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤</label><input id="swal-name" class="swal2-input w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà 1"></div><div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Ç‡πâ‡∏≤‡∏ß</label><select id="swal-variety" class="swal2-select w-full"><option value="KDML105">üçö ‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥ 105</option><option value="RD6">üçô ‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß ‡∏Å‡∏Ç 6</option><option value="RD15">üçö ‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥ ‡∏Å‡∏Ç 15</option><option value="PATHUM1">üåæ ‡∏Ç‡πâ‡∏≤‡∏ß‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ</option><option value="OTHER">üå± ‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option></select></div></div>`,
            showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', confirmButtonColor: '#16a34a',
            preConfirm: () => { const name = document.getElementById('swal-name').value; if(!name) Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤'); return { name, variety: document.getElementById('swal-variety').value } }
        });
        if (formValues) { saveField(formValues.name, layer.toGeoJSON().geometry, formValues.variety); }
    });

    async function saveField(name, geom, variety) {
        try {
            const res = await fetch('/api/rice-fields/', { method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'}, body: JSON.stringify({name, geometry: geom, variety}) });
            const data = await res.json(); 
            if(res.ok) { Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1500, showConfirmButton: false }); loadFields(); } 
            else { Swal.fire({ icon: 'error', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: data.error || '‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤‡∏≠‡∏≤‡∏à‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' }); }
        } catch(e) { Swal.fire({ icon: 'error', title: 'Error', text: '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß' }); }
    }

    // Main Data Loop
    async function loadFields() {
        try {
            const [fieldRes, saleRes] = await Promise.all([fetch('/api/rice-fields/'), fetch('/api/sales/')]);
            const fields = await fieldRes.json();
            const sales = await saleRes.json();
            
            allFieldsData = fields;
            saleMapData = {};
            sales.forEach(s => { if (!saleMapData[s.rice_field]) saleMapData[s.rice_field] = s; });

            const listContainer = document.getElementById('fieldList');
            document.getElementById('field-count').innerText = fields.length;
            listContainer.innerHTML = '';
            
            drawnItems.clearLayers();
            fieldLayers = {};

            if (fields.length === 0) { listContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-gray-400 opacity-60"><i class="fa-solid fa-vector-square text-5xl mb-3"></i><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤</p></div>`; return; }

            fields.forEach(f => {
                const activeSale = saleMapData[f.id];
                const status = activeSale ? activeSale.status : 'NONE';
                let borderClass = "border-l-gray-400", polyColor = "#94a3b8", bgHover = "hover:bg-gray-50", statusBadge = "", popupStatus = "";

                if (status === 'OPEN') {
                    borderClass = "border-l-orange-500"; polyColor = "#f97316"; bgHover = "hover:bg-orange-50";
                    statusBadge = `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-orange-100 text-orange-700 border border-orange-200"><i class="fa-solid fa-store"></i> ‡∏£‡∏≠‡∏Ç‡∏≤‡∏¢</span>`;
                    popupStatus = `<span class="text-orange-500 font-bold text-xs"><i class="fa-solid fa-clock"></i> ‡∏£‡∏≠‡∏Ç‡∏≤‡∏¢</span>`;
                } else if (status === 'REQUESTED') {
                    borderClass = "border-l-yellow-500"; polyColor = "#eab308"; bgHover = "hover:bg-yellow-50";
                    statusBadge = `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-yellow-100 text-yellow-800 border border-yellow-200"><i class="fa-solid fa-bell animate-pulse"></i> ‡∏°‡∏µ‡∏Ñ‡∏ô‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠</span>`;
                    popupStatus = `<span class="text-yellow-600 font-bold text-xs"><i class="fa-solid fa-bell"></i> ‡∏°‡∏µ‡∏Ñ‡∏ô‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠</span>`;
                } else if (status === 'SOLD') {
                    borderClass = "border-l-green-600 opacity-75"; polyColor = "#16a34a"; bgHover = "hover:bg-green-50";
                    statusBadge = `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-700 border border-green-200"><i class="fa-solid fa-check-circle"></i> ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>`;
                    popupStatus = `<span class="text-green-600 font-bold text-xs"><i class="fa-solid fa-check"></i> ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>`;
                } else {
                    if (f.latest_yield && parseFloat(f.latest_yield.yield) > 0) {
                        borderClass = "border-l-blue-500"; polyColor = "#3b82f6"; bgHover = "hover:bg-blue-50";
                        statusBadge = `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-blue-50 text-blue-600 border border-blue-100"><i class="fa-solid fa-chart-pie"></i> ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢</span>`;
                        popupStatus = `<span class="text-blue-500 font-bold text-xs">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢</span>`;
                    } else if (f.latest_yield) {
                        borderClass = "border-l-red-500"; polyColor = "#ef4444"; bgHover = "hover:bg-red-50";
                        statusBadge = `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-600 border border-red-200"><i class="fa-solid fa-triangle-exclamation"></i> ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</span>`;
                        popupStatus = `<span class="text-red-500 font-bold text-xs">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</span>`;
                    } else {
                        statusBadge = `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-gray-100 text-gray-500 border border-gray-200"><i class="fa-solid fa-hourglass"></i> ‡∏£‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</span>`;
                        popupStatus = `<span class="text-gray-400 font-bold text-xs">‡∏£‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</span>`;
                    }
                }

                let yieldInfo = '<div class="text-center py-4 text-gray-400 text-xs bg-gray-50 rounded-lg border border-dashed border-gray-200">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</div>';
                let popupYield = ``; 
                if (f.latest_yield) {
                    const rev = f.latest_yield.yield * 12000;
                    yieldInfo = `<div class="bg-gradient-to-br from-green-50 to-white border border-green-100 rounded-lg p-2 grid grid-cols-2 gap-2 text-center"><div><p class="text-[10px] text-gray-500">‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï (‡∏ï‡∏±‡∏ô)</p><p class="text-base font-bold text-green-700">${parseFloat(f.latest_yield.yield).toFixed(2)}</p></div><div><p class="text-[10px] text-gray-500">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå</p><p class="text-base font-bold text-orange-600">${rev.toLocaleString('en-US', {maximumFractionDigits: 0})}</p></div><div class="col-span-2 border-t border-green-100 pt-1 mt-1 flex justify-between items-center px-1"><span class="text-[10px] text-gray-500 font-bold">NDVI: <span class="text-blue-600 text-xl">${parseFloat(f.latest_yield.ndvi).toFixed(3)}</span></span><span class="text-[9px] text-gray-400"><i class="fa-regular fa-clock"></i> ${new Date(f.latest_yield.created_at).toLocaleDateString('th-TH')}</span></div></div>`;
                    if (parseFloat(f.latest_yield.yield) > 0) { popupYield = `<div class="mt-2 pt-2 border-t border-gray-100 flex justify-between items-center bg-green-50 p-2 rounded-lg"><span class="text-xs text-gray-600 font-bold">‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï:</span><span class="text-sm font-bold text-green-700">${parseFloat(f.latest_yield.yield).toFixed(2)} ‡∏ï‡∏±‡∏ô</span></div>`; } 
                    else { popupYield = `<div class="mt-2 pt-2 border-t border-gray-100 text-center bg-red-50 p-2 rounded-lg"><span class="text-xs text-red-500 font-bold">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏Ç‡πâ‡∏≤‡∏ß</span></div>`; }
                }

                let actionBtns = '';
                if(status === 'OPEN') { actionBtns = `<button onclick="cancelSale(${activeSale.id})" class="w-full mt-2 py-1.5 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 text-xs font-bold border border-red-100">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ç‡∏≤‡∏¢</button>`; } 
                else if(status === 'REQUESTED') {
                    const buyerName = activeSale.buyer_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    let priceInfoHTML = '';
                    const originalPrice = parseFloat(activeSale.price_per_ton);
                    const offerPrice = activeSale.negotiated_price ? parseFloat(activeSale.negotiated_price) : originalPrice;
                    if (activeSale.negotiated_price && offerPrice !== originalPrice) {
                        const diff = offerPrice - originalPrice;
                        priceInfoHTML = `<div class="bg-white p-2 rounded border border-orange-200 mb-2 text-left"><p class="text-[10px] text-gray-500">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏î‡∏¥‡∏°: <span class="line-through">${originalPrice.toLocaleString()}</span> ‡∏ö.</p><p class="font-bold text-sm text-gray-800">‡πÄ‡∏™‡∏ô‡∏≠‡∏°‡∏≤: <span class="text-blue-600 text-lg">${offerPrice.toLocaleString()}</span> ‡∏ö.</p><p class="text-[10px] ${diff < 0 ? 'text-red-500' : 'text-green-500'} font-bold"><i class="fa-solid ${diff < 0 ? 'fa-arrow-down' : 'fa-arrow-up'}"></i> ${diff > 0 ? '+' : ''}${diff.toLocaleString()} ‡∏ö.</p></div>`;
                    } else { priceInfoHTML = `<p class="text-xs text-gray-600 mb-2 bg-white px-2 py-1 rounded border border-gray-100">‡πÄ‡∏™‡∏ô‡∏≠‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏î‡∏¥‡∏°: <b>${originalPrice.toLocaleString()}</b> ‡∏ö./‡∏ï‡∏±‡∏ô</p>`; }
                    actionBtns = `<div class="mt-2 bg-yellow-50 p-3 rounded-lg border border-yellow-200 text-center shadow-sm"><div class="flex items-center gap-2 justify-center mb-2 text-yellow-800 font-bold text-xs"><i class="fa-solid fa-user-tag"></i> ‡∏Ñ‡∏∏‡∏ì ${buyerName} ‡∏™‡∏ô‡πÉ‡∏à‡∏ã‡∏∑‡πâ‡∏≠!</div>${priceInfoHTML}<div class="grid grid-cols-2 gap-2 mt-2"><button onclick="respondSale(${activeSale.id}, 'approve')" class="py-2 rounded-lg bg-green-600 text-white text-xs font-bold shadow hover:bg-green-700 transition">‚úÖ ‡∏ï‡∏Å‡∏•‡∏á‡∏Ç‡∏≤‡∏¢</button><button onclick="respondSale(${activeSale.id}, 'reject')" class="py-2 rounded-lg bg-red-500 text-white text-xs font-bold shadow hover:bg-red-600 transition">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button></div></div>`;
                }
                else if (status !== 'SOLD') {
                    let canSell = f.latest_yield && parseFloat(f.latest_yield.yield) > 0;
                    actionBtns = `<div class="grid grid-cols-2 gap-2 mt-2"><button onclick="calcYield(${f.id}, this)" class="py-1.5 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 text-xs font-bold border border-blue-100">${f.latest_yield ? '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏´‡∏°‡πà' : '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï'}</button><button onclick="notifySale(${f.id})" class="py-1.5 rounded-lg ${canSell ? 'bg-green-600 text-white hover:bg-green-700 shadow-sm' : 'bg-gray-100 text-gray-400 cursor-not-allowed'} text-xs font-bold" ${canSell?'':'disabled'}>‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢</button></div>`;
                }

                const cardDiv = document.createElement('div');
                cardDiv.className = `bg-white border border-gray-100 p-4 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 border-l-4 ${borderClass}`;
                cardDiv.innerHTML = `<div class="flex justify-between items-start mb-3"><div class="pr-2 overflow-hidden cursor-pointer ${bgHover} rounded p-1 transition-colors w-full" onclick="focusField(${f.id})"><h3 class="font-bold text-gray-800 truncate text-base mb-1">${f.name}</h3><div class="flex items-center gap-2">${statusBadge}<span class="text-[10px] text-gray-500 bg-gray-100 px-2 py-0.5 rounded border border-gray-200 font-medium">${f.area_rai} ‡πÑ‡∏£‡πà</span></div></div><div class="flex items-center gap-1"><button onclick="viewFieldDetails(${f.id})" class="text-gray-300 hover:text-blue-500 w-8 h-8 flex items-center justify-center rounded-full hover:bg-blue-50 transition" title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"><i class="fa-solid fa-circle-info text-xl"></i></button><button onclick="deleteField(${f.id}, '${f.name}')" class="text-gray-300 hover:text-red-500 w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50 transition" title="‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞"><i class="fa-solid fa-trash text-lg"></i></button></div></div>${yieldInfo}${actionBtns}`;
                listContainer.appendChild(cardDiv);

                if(f.boundary) {
                    try {
                        const geoJsonData = (typeof f.boundary === 'string') ? JSON.parse(f.boundary) : f.boundary;
                        const popupContent = `<div class="font-sans min-w-[200px]"><div class="flex justify-between items-start mb-2"><h4 class="font-bold text-gray-800 text-base m-0 leading-tight">${f.name}</h4>${popupStatus}</div><div class="flex flex-wrap gap-1 mb-2"><span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-[10px] border border-gray-200"><i class="fa-solid fa-seedling"></i> ${f.variety_display || f.variety}</span><span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded text-[10px] border border-blue-100 font-bold">${f.area_rai} ‡πÑ‡∏£‡πà</span></div>${popupYield}<button onclick="viewFieldDetails(${f.id})" class="mt-2 w-full bg-gray-800 hover:bg-gray-900 text-white text-xs py-2 rounded-lg transition shadow-sm flex items-center justify-center gap-2"><i class="fa-solid fa-eye"></i> ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏∂‡∏Å</button></div>`;
                        const layer = L.geoJSON(geoJsonData, { style: { color: polyColor, weight: 2, fillOpacity: 0.4, fill: true } }).bindPopup(popupContent).addTo(drawnItems);
                        fieldLayers[f.id] = layer;
                    } catch(e) {}
                }
            });
        } catch (error) { console.error(error); }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Focus Field (Auto switch Tab on Mobile)
    window.focusField = function(id) {
        if (window.innerWidth < 1024) switchTab('map'); // Switch to map tab automatically
        if (fieldLayers[id]) { 
            map.flyToBounds(fieldLayers[id].getBounds(), { padding: [100, 100], maxZoom: 18, duration: 1 }); 
            fieldLayers[id].openPopup(); 
        } 
    }

    // View Details Modal
    window.viewFieldDetails = function(id) {
        const field = allFieldsData.find(f => f.id === id); if(!field) return;
        const activeSale = saleMapData[id];
        let yieldDetails = `<div class="p-8 text-center text-gray-400 text-sm bg-gray-50 rounded-lg"><i class="fa-solid fa-satellite-dish text-2xl mb-2 opacity-30"></i><br>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï</div>`;
        if (field.latest_yield) {
            const ndviVal = parseFloat(field.latest_yield.ndvi).toFixed(3);
            const yieldVal = parseFloat(field.latest_yield.yield).toFixed(2);
            yieldDetails = `<div class="grid grid-cols-2 gap-4 mb-4"><div class="bg-green-50 p-4 rounded-xl border border-green-100 text-center shadow-sm"><p class="text-xs text-gray-500 uppercase font-bold">‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå</p><p class="text-3xl font-bold text-green-700 mt-1">${yieldVal}</p><span class="text-xs text-green-600">‡∏ï‡∏±‡∏ô</span></div><div class="bg-blue-50 p-4 rounded-xl border border-blue-100 text-center shadow-sm"><p class="text-xs text-gray-500 uppercase font-bold">‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏û‡∏∑‡∏ä (NDVI)</p><p class="text-3xl font-bold text-blue-700 mt-1">${ndviVal}</p><span class="text-xs text-blue-600">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</span></div></div>`;
        }
        let saleInfoHTML = `<div class="p-8 text-center text-gray-400 text-sm bg-gray-50 rounded-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢</div>`;
        if (activeSale) {
            let buyerSection = '';
            if (activeSale.buyer) {
                buyerSection = `<div class="mt-4 border-t pt-4 animate-fade-in-down"><h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2"><i class="fa-solid fa-user-tie text-blue-500"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</h4><div class="bg-blue-50 p-4 rounded-xl border border-blue-100 space-y-3"><div class="flex items-center gap-3 border-b border-blue-200 pb-3"><div class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-blue-600 shadow-sm text-xl border border-blue-100"><i class="fa-solid fa-industry"></i></div><div><p class="font-bold text-gray-800 text-base">${activeSale.buyer_name}</p><p class="text-xs text-gray-500">${activeSale.buyer_bio || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏±‡∏ß'}</p></div></div><div class="grid grid-cols-2 gap-3 text-xs"><div><span class="text-gray-500 block mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</span><a href="tel:${activeSale.buyer_phone}" class="font-bold text-gray-800 hover:text-blue-600 text-sm flex items-center gap-1"><i class="fa-solid fa-phone"></i> ${activeSale.buyer_phone || '-'}</a></div><div><span class="text-gray-500 block mb-1">Line ID</span><span class="font-bold text-green-600 text-sm flex items-center gap-1"><i class="fa-brands fa-line"></i> ${activeSale.buyer_line || '-'}</span></div><div class="col-span-2"><span class="text-gray-500 block mb-1">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</span><span class="font-bold text-gray-800 block bg-white p-2 rounded border border-blue-100"><i class="fa-solid fa-location-dot text-red-500 mr-1"></i> ${activeSale.buyer_address || '-'}</span></div></div></div></div>`;
            }
            let statusText = activeSale.status === 'OPEN' ? '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠' : (activeSale.status === 'REQUESTED' ? '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : '‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
            let statusColor = activeSale.status === 'OPEN' ? 'text-orange-600' : (activeSale.status === 'REQUESTED' ? 'text-yellow-600' : 'text-green-600');
            saleInfoHTML = `<div class="space-y-3 text-sm"><div class="bg-gray-50 border border-gray-200 rounded-xl p-4"><div class="flex justify-between border-b border-gray-200 pb-2 mb-2"><span class="text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span><span class="font-bold ${statusColor} text-base">${statusText}</span></div><div class="flex justify-between mb-1"><span class="text-gray-500">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏™‡∏ô‡∏≠‡∏Ç‡∏≤‡∏¢</span><span class="font-bold">${(activeSale.price_per_ton || 0).toLocaleString()} ‡∏ö./‡∏ï‡∏±‡∏ô</span></div><div class="flex justify-between"><span class="text-gray-500">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</span><span class="font-bold">${activeSale.quantity_ton || 0} ‡∏ï‡∏±‡∏ô</span></div></div>${buyerSection}</div>`;
        }
        Swal.fire({
            title: `<span class="text-xl font-bold text-gray-800 flex items-center justify-center gap-2"><i class="fa-solid fa-seedling text-green-500"></i> ${field.name}</span>`,
            html: `<div class="text-left"><div class="flex gap-2 mb-4 justify-center"><span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-bold">${field.variety_display || field.variety}</span><span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-xs font-bold">${field.area_rai} ‡πÑ‡∏£‡πà</span></div><div class="flex border-b border-gray-200 mb-4"><button id="tab-yield" class="flex-1 py-2 text-sm font-bold text-green-600 border-b-2 border-green-600 transition-colors">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button><button id="tab-sale" class="flex-1 py-2 text-sm font-bold text-gray-400 hover:text-gray-600 transition-colors">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button></div><div id="content-yield" class="block animate-fade-in-down">${yieldDetails}</div><div id="content-sale" class="hidden animate-fade-in-down">${saleInfoHTML}</div></div>`,
            showConfirmButton: true, confirmButtonText: '‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á', confirmButtonColor: '#334155', width: '500px', allowOutsideClick: false, showCloseButton: true,
            didOpen: () => {
                const tabYield = Swal.getHtmlContainer().querySelector('#tab-yield'), tabSale = Swal.getHtmlContainer().querySelector('#tab-sale'), contentYield = Swal.getHtmlContainer().querySelector('#content-yield'), contentSale = Swal.getHtmlContainer().querySelector('#content-sale');
                tabYield.addEventListener('click', () => { tabYield.classList.add('text-green-600', 'border-green-600'); tabYield.classList.remove('text-gray-400'); tabSale.classList.remove('text-green-600', 'border-green-600'); tabSale.classList.add('text-gray-400'); contentYield.classList.remove('hidden'); contentSale.classList.add('hidden'); });
                tabSale.addEventListener('click', () => { tabSale.classList.add('text-green-600', 'border-green-600'); tabSale.classList.remove('text-gray-400'); tabYield.classList.remove('text-green-600', 'border-green-600'); tabYield.classList.add('text-gray-400'); contentSale.classList.remove('hidden'); contentYield.classList.add('hidden'); });
            }
        });
    }
    
    // Actions: Calc, Notify, Trash, Respond
    window.calcYield = async (id, btn) => {
        const loading = document.getElementById('loading-overlay'); if(loading) loading.classList.remove('hidden'); 
        try {
            const res = await fetch(`/api/rice-fields/${id}/calculate_yield/`, { method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'} });
            const data = await res.json();
            if(res.ok) {
                if (satelliteLayer) { layerControl.removeLayer(satelliteLayer); map.removeLayer(satelliteLayer); satelliteLayer = null; }
                if (data.satellite_image) { satelliteLayer = L.tileLayer(data.satellite_image, { attribution: 'Sentinel-2', opacity: 0.8, zIndex: 500 }); layerControl.addOverlay(satelliteLayer, "‡∏†‡∏≤‡∏û‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå"); satelliteLayer.addTo(map); if(fieldLayers[id]) map.flyToBounds(fieldLayers[id].getBounds(), { padding: [50,50], maxZoom: 17 }); }
                let headerHtml = '', icon = 'success', btnColor = '#16a34a';
                if (data.result_type === 'building') { headerHtml = `<div class="bg-red-100 text-red-700 p-2 rounded-lg mb-3 text-sm border border-red-200">‚ö†Ô∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÄ‡∏õ‡πá‡∏ô <b>‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á</b></div>`; icon = 'error'; btnColor = '#ef4444'; } else if (data.result_type === 'road') { headerHtml = `<div class="bg-orange-100 text-orange-700 p-2 rounded-lg mb-3 text-sm border border-orange-200">üõ£Ô∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÄ‡∏õ‡πá‡∏ô <b>‡∏ñ‡∏ô‡∏ô/‡∏î‡∏¥‡∏ô‡πÇ‡∏•‡πà‡∏á</b></div>`; icon = 'warning'; btnColor = '#f97316'; } else if (data.result_type === 'water') { headerHtml = `<div class="bg-blue-100 text-blue-700 p-2 rounded-lg mb-3 text-sm border border-blue-200">üíß ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÄ‡∏õ‡πá‡∏ô <b>‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ô‡πâ‡∏≥</b></div>`; icon = 'info'; btnColor = '#3b82f6'; } else if (data.result_type === 'young_rice') { headerHtml = `<div class="bg-lime-100 text-lime-700 p-2 rounded-lg mb-3 text-sm border border-lime-200">üå± ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÄ‡∏õ‡πá‡∏ô <b>‡∏Ç‡πâ‡∏≤‡∏ß‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</b></div>`; icon = 'info'; btnColor = '#65a30d'; } else { headerHtml = `<div class="bg-green-100 text-green-700 p-2 rounded-lg mb-3 text-sm border border-green-200">üåæ <b>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</b></div>`; }
                Swal.fire({ title: '‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', html: `<div class="mt-2">${headerHtml}<div class="bg-gray-50 p-4 rounded-xl border border-gray-200 shadow-sm mb-3"><h3 class="text-3xl font-bold text-gray-800">${parseFloat(data.yield_ton).toFixed(2)} <span class="text-base text-gray-500 font-normal">‡∏ï‡∏±‡∏ô</span></h3><p class="text-sm text-gray-500">‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå</p></div><div class="grid grid-cols-2 gap-3 text-left text-sm"><div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm"><span class="text-gray-400 block text-[10px] uppercase">üí∞ ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</span><span class="font-bold text-gray-800 text-lg">${data.revenue.toLocaleString()} ‡∏ö.</span></div><div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm"><span class="text-gray-400 block text-[10px] uppercase">üåø ‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏û‡∏∑‡∏ä (NDVI)</span><span class="font-bold text-gray-800 text-lg">${data.ndvi}</span></div><div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm"><span class="text-gray-400 block text-[10px] uppercase">üìè ‡∏Ç‡∏ô‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</span><span class="font-bold text-gray-800 text-lg">${data.area} ‡πÑ‡∏£‡πà</span></div><div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm"><span class="text-gray-400 block text-[10px] uppercase">üè¢ ‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á</span><span class="font-bold text-gray-800 text-lg">${data.ndbi}</span></div></div><p class="text-[10px] text-gray-400 mt-3 text-center"><i class="fa-solid fa-satellite"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° Sentinel-2 ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p></div>`, icon: icon, confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö', confirmButtonColor: btnColor, width: '400px', allowOutsideClick: false, showCloseButton: true });
                loadFields(); 
            } else { Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: data.error }); }
        } catch(e) { Swal.fire({ icon: 'error', title: 'Error', text: '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß' }); } finally { if(loading) loading.classList.add('hidden'); }
    }

    window.openTrash = async function() {
        const modal = document.getElementById('trashModal'), content = document.getElementById('trashModalContent'), listDiv = document.getElementById('trash-list');
        modal.classList.remove('hidden'); setTimeout(() => { content.classList.remove('scale-95', 'opacity-0'); content.classList.add('scale-100', 'opacity-100'); }, 10);
        try {
            const res = await fetch('/api/rice-fields/trash/'); const data = await res.json();
            listDiv.innerHTML = ''; if(data.length === 0) { listDiv.innerHTML = `<div class="text-center py-10 text-gray-400"><i class="fa-regular fa-folder-open text-4xl mb-2 opacity-30"></i><br>‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</div>`; return; }
            data.forEach(item => { listDiv.innerHTML += `<div class="bg-gray-50 border border-gray-100 p-3 rounded-xl flex justify-between items-center group hover:bg-white hover:shadow-sm transition"><div><p class="font-bold text-gray-700 text-sm">${item.name}</p><p class="text-xs text-gray-400">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ${item.area_rai} ‡πÑ‡∏£‡πà</p></div><div class="flex gap-2"><button onclick="restoreField(${item.id})" class="w-8 h-8 rounded-full bg-green-100 text-green-600 hover:bg-green-600 hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-rotate-left"></i></button><button onclick="forceDeleteField(${item.id})" class="w-8 h-8 rounded-full bg-red-100 text-red-600 hover:bg-red-600 hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button></div></div>`; });
        } catch(e) { listDiv.innerHTML = `<p class="text-red-500 text-center text-sm">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>`; }
    }
    window.closeTrash = function() { const modal = document.getElementById('trashModal'), content = document.getElementById('trashModalContent'); content.classList.remove('scale-100', 'opacity-100'); content.classList.add('scale-95', 'opacity-0'); setTimeout(() => { modal.classList.add('hidden'); }, 200); }
    window.restoreField = async function(id) { try { const res = await fetch(`/api/rice-fields/${id}/restore/`, { method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'} }); if(res.ok) { Swal.fire({ icon: 'success', title: '‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1000, showConfirmButton: false }); openTrash(); loadFields(); } } catch(e) {} }
    
    window.forceDeleteField = async function(id) {
        const r1 = await Swal.fire({ title: '‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£?', text: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: '‡∏•‡∏ö', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' });
        if (r1.isConfirmed) { 
            const r2 = await Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢!', text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ï‡∏•‡∏≠‡∏î‡∏Å‡∏≤‡∏•‡∏ô‡∏∞", icon: 'question', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#94a3b8', confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡∏•‡∏ö!', cancelButtonText: '‡πÑ‡∏°‡πà‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß' });
            if (r2.isConfirmed) {
                try { const res = await fetch(`/api/rice-fields/${id}/force_delete/`, { method: 'DELETE', headers: {'X-CSRFToken': '{{ csrf_token }}'} }); if(res.ok) { Swal.fire({ icon: 'success', title: '‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', timer: 1500, showConfirmButton: false }); openTrash(); } } catch(e) {} 
            }
        }
    }

    window.notifySale = async (id) => { const { value: form } = await Swal.fire({ title: 'üì¢ ‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡∏≤‡∏¢', html: `<input id="q" type="number" class="swal2-input" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ï‡∏±‡∏ô)"><input id="p" type="number" class="swal2-input" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó/‡∏ï‡∏±‡∏ô)"><input id="ph" type="tel" class="swal2-input" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">`, showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', preConfirm: () => { const q = document.getElementById('q').value, p = document.getElementById('p').value, ph = document.getElementById('ph').value; if(!q || !p || !ph) Swal.showValidationMessage('‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return { rice_field: id, quantity_ton: q, price_per_ton: p, phone: ph } } }); if(form) { await fetch('/api/sales/', { method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'}, body: JSON.stringify(form) }); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success'); loadFields(); } }
    window.deleteField = async (id, name) => { const result = await Swal.fire({ title: '‡∏•‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤?', text: `‡∏•‡∏ö "${name}" ‡πÑ‡∏´‡∏°?`, icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444', confirmButtonText: '‡∏•‡∏ö' }); if (result.isConfirmed) { await fetch(`/api/rice-fields/${id}/`, { method: 'DELETE', headers: { 'X-CSRFToken': '{{ csrf_token }}' } }); loadFields(); } };
    window.respondSale = async (id, action) => { try { const res = await fetch(`/api/sales/${id}/${action}_sell/`, { method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'} }); if(res.ok) { Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', action==='approve'?'‡∏Ç‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢':'‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏•‡πâ‡∏ß', 'success'); loadFields(); } } catch(e) {} }
    window.cancelSale = async (id) => { const result = await Swal.fire({ title: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444', confirmButtonText: '‡πÉ‡∏ä‡πà' }); if(result.isConfirmed) { await fetch(`/api/sales/${id}/`, { method: 'DELETE', headers: {'X-CSRFToken': '{{ csrf_token }}'} }); loadFields(); } }
    window.closeModal = function() { const modal = document.getElementById('saleModal'), content = document.getElementById('saleModalContent'); content.classList.remove('scale-100', 'opacity-100'); content.classList.add('scale-95', 'opacity-0'); setTimeout(() => { modal.classList.add('hidden'); }, 200); }
    
    loadFields();
    setInterval(loadFields, 5000);
</script>
{% endblock %}