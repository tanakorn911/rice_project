{% extends 'base.html' %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-100px)]">
    
    <div class="lg:col-span-4 flex flex-col gap-4 h-full">
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center relative z-20">
            <div>
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <span class="bg-green-100 text-green-700 p-2 rounded-lg"><i class="fa-solid fa-list-ul"></i></span>
                    ‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                </h2>
                <p class="text-xs text-gray-400 mt-1 pl-11">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï</p>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="relative">
                    <button onclick="toggleNotif()" class="p-2 rounded-full hover:bg-gray-100 transition relative focus:outline-none">
                        <i class="fa-solid fa-bell text-gray-500 text-xl transition-colors hover:text-green-600"></i>
                        <span id="notif-badge" class="absolute top-0 right-0 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden border-2 border-white transform translate-x-1 -translate-y-1 shadow-sm">0</span>
                    </button>

                    <div id="notif-dropdown" class="hidden absolute right-0 mt-3 w-80 bg-white rounded-xl shadow-xl border border-gray-100 overflow-hidden z-50 animate-fade-in-down">
                        <div class="bg-gray-50 px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                            <span class="text-sm font-bold text-gray-700"><i class="fa-solid fa-clock-rotate-left"></i> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span>
                            <span class="text-xs text-blue-500 cursor-pointer hover:text-blue-700 hover:underline" onclick="markAllRead()">‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                        </div>
                        <div id="notif-list" class="max-h-72 overflow-y-auto custom-scrollbar bg-white">
                            <div class="p-6 text-center text-gray-400 text-sm flex flex-col items-center">
                                <i class="fa-regular fa-bell-slash text-2xl mb-2 opacity-50"></i>
                                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-right border-l pl-3 ml-2">
                    <span id="field-count" class="text-2xl font-bold text-green-600">0</span>
                    <span class="text-xs text-gray-400 block">‡πÅ‡∏õ‡∏•‡∏á</span>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 flex-grow overflow-hidden relative z-10">
            <div id="fieldList" class="absolute inset-0 p-4 space-y-3 overflow-y-auto custom-scrollbar pb-20">
                <div class="flex flex-col items-center justify-center h-full text-gray-400 space-y-3 animate-pulse">
                    <i class="fa-solid fa-circle-notch fa-spin text-3xl text-green-200"></i>
                    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                </div>
            </div>
            <div class="absolute bottom-0 left-0 w-full h-10 bg-gradient-to-t from-white to-transparent pointer-events-none"></div>
        </div>
    </div>
    
    <div class="lg:col-span-8 h-full">
        <div class="bg-white p-1 rounded-2xl shadow-lg border border-gray-100 h-full flex flex-col relative overflow-hidden group">
            
            <div id="map" class="w-full h-full rounded-xl z-0 bg-gray-100 relative">
                
                <div class="leaflet-top leaflet-left mt-[10px] ml-[10px] pointer-events-none" style="z-index: 500;">
                    <div class="bg-white/90 backdrop-blur-sm px-4 py-3 rounded-xl shadow-lg border border-gray-200 pointer-events-auto">
                        <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <i class="fa-solid fa-map-location-dot text-blue-600"></i> ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏Å‡∏©‡∏ï‡∏£
                        </h2>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-[10px] bg-green-500 text-white px-2 py-0.5 rounded-full shadow-sm flex items-center gap-1">
                                <i class="fa-solid fa-wifi text-[8px]"></i> Online
                            </span>
                            <span class="text-[10px] bg-blue-500 text-white px-2 py-0.5 rounded-full shadow-sm">
                                üìç ‡∏à.‡∏û‡∏∞‡πÄ‡∏¢‡∏≤
                            </span>
                        </div>
                    </div>
                </div>

                <div class="leaflet-bottom leaflet-left mb-[20px] ml-[10px] pointer-events-none" style="z-index: 500;">
                    <div class="bg-white/80 backdrop-blur-sm px-3 py-1 rounded-md shadow border border-gray-200 pointer-events-auto">
                        <span class="text-xs font-bold text-gray-600 font-mono">
                            <i class="fa-solid fa-magnifying-glass-plus mr-1"></i>Zoom: <span id="zoom-level-text" class="text-blue-600">11</span>
                        </span>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<div id="saleModal" class="fixed inset-0 z-[999] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm transition-opacity">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 relative transform transition-transform scale-95 opacity-0" id="saleModalContent">
        <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
        
        <div class="text-center">
            <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-4">
                <i class="fa-solid fa-handshake"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h3>
            <span class="bg-green-50 text-green-700 px-3 py-1 rounded-full text-xs font-bold mt-1 inline-block border border-green-100">‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>
            
            <div class="mt-6 space-y-4 text-left">
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <h4 class="text-xs font-bold text-blue-500 uppercase mb-2">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠ (Buyer)</h4>
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center text-blue-500 shadow-sm"><i class="fa-solid fa-industry"></i></div>
                        <div>
                            <p class="text-xs text-gray-400">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡∏™‡∏µ/‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠</p>
                            <p class="font-bold text-gray-700" id="modal-buyer-name">-</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center text-blue-500 shadow-sm"><i class="fa-solid fa-phone"></i></div>
                        <div>
                            <p class="text-xs text-gray-400">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</p>
                            <a href="#" id="modal-buyer-phone-link" class="font-bold text-gray-700 hover:text-blue-600 transition">-</a>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢</span>
                        <span class="font-bold text-gray-800" id="modal-sold-at">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</span>
                        <span class="font-bold text-gray-800"><span id="modal-qty">0</span> ‡∏ï‡∏±‡∏ô</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ï‡∏±‡∏ô</span>
                        <span class="font-bold text-gray-800"><span id="modal-price">0</span> ‡∏ö.</span>
                    </div>
                    <div class="border-t pt-2 flex justify-between items-center mt-2">
                        <span class="font-bold text-gray-700">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                        <span class="font-bold text-green-600 text-xl"><span id="modal-total">0</span> ‡∏ö.</span>
                    </div>
                </div>
            </div>
            <button onclick="closeModal()" class="mt-5 w-full bg-gray-800 hover:bg-gray-900 text-white py-2.5 rounded-xl font-bold text-sm transition shadow-lg shadow-gray-200">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
    </div>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f8fafc; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    @keyframes fadeInDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-down { animation: fadeInDown 0.2s ease-out; }

    .swal2-input, .swal2-select { 
        border: 1px solid #e2e8f0 !important; border-radius: 12px !important; 
        height: 45px !important; margin: 10px auto !important; box-shadow: none !important;
    }
    .swal2-input:focus, .swal2-select:focus { border-color: #22c55e !important; ring: 2px solid #bbf7d0 !important; }
    .swal2-popup { border-radius: 20px !important; padding: 2rem !important; font-family: 'Sarabun', sans-serif; }
    
    .swal2-close { font-size: 1.5em !important; color: #64748b !important; }
    .swal2-close:hover { color: #ef4444 !important; }

    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á Layer Control ‡∏Ç‡∏≠‡∏á Leaflet */
    .leaflet-control-layers {
        border-radius: 12px !important;
        border: 1px solid #e2e8f0 !important;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important;
        padding: 5px !important;
    }
    .leaflet-control-layers-toggle {
        width: 44px !important;
        height: 44px !important;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // ==========================================
    // 1. Setup & Globals (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà)
    // ==========================================
    
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Layer 3 ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö
    var googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
        maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: 'Google Streets'
    });
    var googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
        maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: 'Google Satellite'
    });
    var googleHybrid = L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { 
        maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: 'Google Hybrid' 
    });

    // ‡∏£‡∏ß‡∏° Layer ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Object ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ Control
    var baseMaps = {
        "‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏ô‡∏ô": googleStreets,
        "‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡∏•‡πâ‡∏ß‡∏ô": googleSat,
        "‡∏ú‡∏™‡∏° (Hybrid)": googleHybrid
    };

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Map (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Zoom ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô 11 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ã‡∏π‡∏°‡∏≠‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏≠‡∏¢)
    var map = L.map('map', { 
        center: [19.1667, 99.9000], 
        zoom: 11,  // <--- ‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å 12 ‡πÄ‡∏õ‡πá‡∏ô 11 ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠
        layers: [googleHybrid], // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ Hybrid
        zoomControl: false // ‡∏õ‡∏¥‡∏î Default Zoom ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà
    });

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Layer (‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô)
    L.control.layers(baseMaps).addTo(map);

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° Zoom (‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á)
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    // Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç Zoom
    map.on('zoomend', function() {
        document.getElementById('zoom-level-text').innerText = map.getZoom();
    });

    var drawnItems = new L.FeatureGroup().addTo(map);
    var fieldLayers = {}; 
    var satelliteLayer = null; 
    var lastStatusMap = {}; 
    
    let lastReadTime = new Date(localStorage.getItem('farmerLastRead') || 0);

    // ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏≤‡∏î (‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏° Top Right ‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ï‡πâ Layer Control ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
    map.addControl(new L.Control.Draw({
        position: 'topright',
        draw: { polygon: true, rectangle: true, marker: false, circle: false, polyline: false },
        edit: { featureGroup: drawnItems, remove: false } 
    }));

    // ‡∏õ‡∏∏‡πà‡∏° Locate Me (‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏°‡∏ã‡∏π‡∏°)
    var LocateControl = L.Control.extend({
        options: { position: 'bottomright' },
        onAdd: function (map) {
            var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
            container.innerHTML = '<a href="#" class="bg-white hover:bg-gray-50 text-blue-600 w-8 h-8 flex items-center justify-center rounded shadow-sm transition-colors" title="‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô"><i class="fa-solid fa-crosshairs"></i></a>';
            container.onclick = function(e) { e.preventDefault(); map.locate({setView: true, maxZoom: 18}); };
            return container;
        }
    });
    map.addControl(new LocateControl());

    map.on('locationfound', function(e) {
        L.popup().setLatLng(e.latlng).setContent("‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà").openOn(map);
    });

    // ==========================================
    // 2. Draw Event (Save Field)
    // ==========================================
    map.on(L.Draw.Event.CREATED, async function (e) {
        var layer = e.layer;
        var center = layer.getBounds().getCenter();
        
        if (center.lng < 99.80 || center.lng > 100.10 || center.lat < 19.00 || center.lat > 19.35) {
            Swal.fire({ icon: 'error', title: '‡∏ô‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà!', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏î‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à.‡∏û‡∏∞‡πÄ‡∏¢‡∏≤ ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', timer: 3000, showConfirmButton: false });
            return;
        }

        const { value: formValues } = await Swal.fire({
            title: 'üå± ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà',
            html: `
                <div class="text-left space-y-3">
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤</label><input id="swal-name" class="swal2-input w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà 1"></div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Ç‡πâ‡∏≤‡∏ß</label>
                        <select id="swal-variety" class="swal2-select w-full">
                            <option value="KDML105">üçö ‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥ 105</option>
                            <option value="RD6">üçô ‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß ‡∏Å‡∏Ç 6</option>
                            <option value="RD15">üçö ‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥ ‡∏Å‡∏Ç 15</option>
                            <option value="PATHUM1">üåæ ‡∏Ç‡πâ‡∏≤‡∏ß‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ 1</option>
                            <option value="OTHER">üå± ‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
                        </select>
                    </div>
                </div>
            `,
            showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', confirmButtonColor: '#16a34a',
            preConfirm: () => {
                const name = document.getElementById('swal-name').value;
                if(!name) Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤');
                return { name, variety: document.getElementById('swal-variety').value }
            }
        });

        if (formValues) {
            saveField(formValues.name, layer.toGeoJSON().geometry, formValues.variety);
        }
    });

    async function saveField(name, geom, variety) {
        try {
            const res = await fetch('/api/rice-fields/', {
                method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                body: JSON.stringify({name, geometry: geom, variety})
            });
            if(res.ok) { 
                Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1500, showConfirmButton: false });
                loadFields(); 
            } else {
                Swal.fire({ icon: 'error', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });
            }
        } catch(e) { Swal.fire({ icon: 'error', title: 'Error', text: 'Connection failed' }); }
    }

    // ==========================================
    // 3. Main Data Loop
    // ==========================================
    async function loadFields() {
        try {
            const [fieldRes, saleRes] = await Promise.all([fetch('/api/rice-fields/'), fetch('/api/sales/')]);
            const fields = await fieldRes.json();
            const sales = await saleRes.json();
            
            const saleMap = {};
            const activeRequests = [];
            const newSoldItems = [];

            sales.forEach(s => { 
                if (!saleMap[s.rice_field]) saleMap[s.rice_field] = s;
                if (s.status === 'REQUESTED') activeRequests.push(s); 
                else if (s.status === 'SOLD' && s.sold_at && new Date(s.sold_at) > lastReadTime) newSoldItems.push(s);
            });

            updateNotifications(activeRequests, newSoldItems);

            const listContainer = document.getElementById('fieldList');
            document.getElementById('field-count').innerText = fields.length;
            listContainer.innerHTML = '';
            drawnItems.clearLayers();
            fieldLayers = {};

            if (fields.length === 0) {
                listContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-gray-400 opacity-60"><i class="fa-solid fa-vector-square text-5xl mb-3"></i><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤</p></div>`;
                return;
            }

            fields.forEach(f => {
                const activeSale = saleMap[f.id];
                const status = activeSale ? activeSale.status : 'NONE';

                if (lastStatusMap[f.id] && lastStatusMap[f.id] !== status) {
                    if (status === 'REQUESTED') {
                        Swal.fire({ title: 'üîî ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà!', html: `‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏™‡∏ô‡πÉ‡∏à‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡πâ‡∏≤‡∏ß‡πÅ‡∏õ‡∏•‡∏á <b>${f.name}</b>`, icon: 'info', timer: 10000, showCloseButton: true });
                    } else if (status === 'SOLD') {
                        Swal.fire({ title: 'üéâ ‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', html: `‡πÅ‡∏õ‡∏•‡∏á <b>${f.name}</b> ‡∏Ç‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, icon: 'success', timer: 5000, showCloseButton: true });
                    }
                }
                lastStatusMap[f.id] = status;

                let borderClass = "border-l-green-500", bgHover = "hover:bg-green-50";
                let statusBadge = "", actionButtons = "";
                let polyColor = "#22c55e", dashArray = '5, 5';

                if (status === 'OPEN') {
                    borderClass = "border-l-orange-500"; bgHover = "hover:bg-orange-50"; polyColor = "#f97316"; dashArray = null;
                    statusBadge = `<span class="absolute top-2 right-10 text-[10px] bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full font-bold border border-orange-200 shadow-sm"><i class="fa-solid fa-clock"></i> ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</span>`;
                    actionButtons = `<div class="col-span-2"><button onclick="cancelSale(${activeSale.id})" class="w-full bg-red-50 hover:bg-red-100 text-red-600 text-xs font-bold py-2.5 rounded-lg border border-red-100"><i class="fa-solid fa-xmark"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button></div>`;
                
                } else if (status === 'REQUESTED') {
                    borderClass = "border-l-yellow-500"; bgHover = "hover:bg-yellow-50"; polyColor = "#eab308";
                    statusBadge = `<span class="absolute top-2 right-10 text-[10px] bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full font-bold border border-yellow-200 animate-pulse"><i class="fa-solid fa-bell"></i> ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>`;
                    const contactInfo = activeSale.buyer_contact || activeSale.buyer_phone || '-';
                    actionButtons = `
                        <div class="col-span-2 bg-yellow-50 p-3 rounded-lg border border-yellow-200 mb-2 text-xs text-gray-700">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-bold text-gray-900"><i class="fa-solid fa-user-tag"></i> ‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠: ${activeSale.buyer_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
                            </div>
                            <div class="bg-white px-2 py-1 rounded border border-yellow-100 mt-1">
                                <i class="fa-solid fa-phone text-gray-400"></i> ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: <a href="tel:${contactInfo}" class="font-bold text-blue-600 hover:underline">${contactInfo}</a>
                            </div>
                        </div>
                        <button onclick="respondSale(${activeSale.id}, 'approve')" class="flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-2.5 rounded-lg shadow-sm">‚úÖ ‡∏ï‡∏Å‡∏•‡∏á‡∏Ç‡∏≤‡∏¢</button>
                        <button onclick="respondSale(${activeSale.id}, 'reject')" class="flex items-center justify-center gap-2 bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-2.5 rounded-lg shadow-sm">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                    `;

                } else if (status === 'SOLD') {
                    borderClass = "border-l-gray-400 opacity-80"; bgHover = "hover:bg-gray-50"; polyColor = "#9ca3af"; dashArray = null;
                    statusBadge = `<span class="absolute top-2 right-10 text-[10px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full font-bold border border-gray-200"><i class="fa-solid fa-check-circle"></i> ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>`;
                    const totalPrice = (activeSale.quantity_ton * activeSale.price_per_ton).toLocaleString();
                    const buyerName = activeSale.buyer_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    const buyerPhone = activeSale.buyer_contact || activeSale.buyer_phone || '-';
                    const soldDate = new Date(activeSale.sold_at).toLocaleString('th-TH');
                    actionButtons = `
                        <div class="col-span-2">
                            <button onclick="openSaleModal('${buyerName}', '${buyerPhone}', '${soldDate}', '${activeSale.quantity_ton}', '${activeSale.price_per_ton.toLocaleString()}', '${totalPrice}')" 
                                class="w-full bg-green-50 hover:bg-green-100 text-green-700 text-xs font-bold py-2.5 rounded-lg border border-green-200 transition-colors flex items-center justify-center gap-2 shadow-sm">
                                <i class="fa-solid fa-receipt"></i> ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
                            </button>
                        </div>
                    `;
                } else {
                    let calcBtnText = f.latest_yield ? '<i class="fa-solid fa-rotate"></i> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà' : '<i class="fa-solid fa-satellite-dish"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå';
                    let canSell = f.latest_yield && f.latest_yield.yield > 0;
                    let sellBtnClass = canSell ? 'bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white' : 'bg-gray-100 text-gray-400 cursor-not-allowed';
                    
                    actionButtons = `
                        <button onclick="calcYield(${f.id}, this)" class="flex items-center justify-center gap-2 bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-2.5 rounded-lg shadow-sm">${calcBtnText}</button>
                        <button onclick="notifySale(${f.id})" class="flex items-center justify-center gap-2 ${sellBtnClass} text-xs font-bold py-2.5 rounded-lg shadow-sm" ${canSell ? '' : 'disabled'}><i class="fa-solid fa-bullhorn"></i> ‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡∏≤‡∏¢</button>
                    `;
                }

                let yieldContent = f.latest_yield ? 
                    `<div class="grid grid-cols-2 gap-4 text-center divide-x divide-green-200">
                        <div><p class="text-[10px] text-gray-500 uppercase">NDVI</p><p class="text-lg font-bold text-green-700">${parseFloat(f.latest_yield.ndvi).toFixed(3)}</p></div>
                        <div><p class="text-[10px] text-gray-500 uppercase">‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï</p><p class="text-lg font-bold text-orange-600">${parseFloat(f.latest_yield.yield).toFixed(2)} <span class="text-xs text-gray-400 font-normal">‡∏ï‡∏±‡∏ô</span></p></div>
                    </div>` : '<p class="text-xs opacity-60">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';

                const card = document.createElement('div');
                card.className = `bg-white border border-gray-100 p-4 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 relative group overflow-hidden border-l-4 ${borderClass} mb-2`;
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="pr-2 overflow-hidden cursor-pointer ${bgHover} rounded p-1 transition-colors w-full" onclick="focusField(${f.id})">
                            <h3 class="font-bold text-gray-800 text-lg truncate flex items-center gap-2">${f.name}</h3>
                            ${statusBadge}
                            <div class="flex flex-wrap items-center gap-2 mt-1">
                                <span class="text-[10px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded-md"><i class="fa-solid fa-seedling text-green-500 mr-1"></i> ${f.variety_display || f.variety}</span>
                                <span class="text-[10px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded-md"><i class="fa-solid fa-chart-area text-blue-500 mr-1"></i> ${f.area_rai} ‡πÑ‡∏£‡πà</span>
                            </div>
                        </div>
                        <button onclick="deleteField(${f.id}, '${f.name}')" class="text-gray-300 hover:text-red-500 p-1.5"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                    <div class="my-3 p-3 rounded-lg border ${f.latest_yield ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-dashed border-gray-200'} text-center">${yieldContent}</div>
                    <div class="grid grid-cols-2 gap-2 mt-2">${actionButtons}</div>
                `;
                listContainer.appendChild(card);

                if(f.boundary) {
                    try {
                        const geoJsonData = (typeof f.boundary === 'string') ? JSON.parse(f.boundary) : f.boundary;
                        const layer = L.geoJSON(geoJsonData, { style: { color: polyColor, weight: 2, fillOpacity: 0.3, dashArray: dashArray } })
                            .bindPopup(`<b>${f.name}</b><br>${f.area_rai} ‡πÑ‡∏£‡πà`).addTo(map).addTo(drawnItems);
                        fieldLayers[f.id] = layer;
                    } catch(e) {}
                }
            });
        } catch (error) { console.error(error); }
    }

    function updateNotifications(activeRequests, newSoldItems) {
        const badge = document.getElementById('notif-badge');
        const listDiv = document.getElementById('notif-list');
        const totalUnread = activeRequests.length + newSoldItems.length;

        if (totalUnread > 0) {
            badge.innerText = totalUnread > 9 ? '9+' : totalUnread;
            badge.classList.remove('hidden');
            badge.classList.add('animate-bounce');
        } else {
            badge.classList.add('hidden');
        }

        if (totalUnread === 0) {
            listDiv.innerHTML = `<div class="p-8 text-center text-gray-400 text-sm"><i class="fa-regular fa-bell-slash text-2xl mb-2 opacity-50"></i><br>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</div>`;
        } else {
            listDiv.innerHTML = '';
            activeRequests.forEach(s => {
                listDiv.innerHTML += `
                    <div class="p-3 border-b border-gray-50 bg-yellow-50 hover:bg-yellow-100 cursor-pointer transition-colors" onclick="focusField(${s.rice_field})">
                        <div class="flex items-start gap-3">
                            <div class="bg-yellow-500 text-white p-2 rounded-full h-8 w-8 flex items-center justify-center shrink-0"><i class="fa-solid fa-bell"></i></div>
                            <div>
                                <p class="text-sm font-bold text-gray-800">‡∏°‡∏µ‡∏Ñ‡∏ô‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡πâ‡∏≤‡∏ß! üîî</p>
                                <p class="text-xs text-gray-600">‡πÅ‡∏õ‡∏•‡∏á: ${s.field_name} ‚Ä¢ ${s.quantity_ton} ‡∏ï‡∏±‡∏ô</p>
                                <p class="text-[10px] text-yellow-600 mt-1 font-bold">‚ö†Ô∏è ‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì</p>
                            </div>
                        </div>
                    </div>`;
            });
            newSoldItems.forEach(s => {
                listDiv.innerHTML += `
                    <div class="p-3 border-b border-gray-50 hover:bg-green-50 cursor-pointer transition-colors" onclick="focusField(${s.rice_field})">
                        <div class="flex items-start gap-3">
                            <div class="bg-green-500 text-white p-2 rounded-full h-8 w-8 flex items-center justify-center shrink-0"><i class="fa-solid fa-check"></i></div>
                            <div>
                                <p class="text-sm font-bold text-gray-800">‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß üéâ</p>
                                <p class="text-xs text-gray-600">‡πÅ‡∏õ‡∏•‡∏á: ${s.field_name}</p>
                                <p class="text-[10px] text-gray-400 mt-1">${new Date(s.sold_at).toLocaleTimeString('th-TH')} ‡∏ô.</p>
                            </div>
                        </div>
                    </div>`;
            });
        }
    }

    window.markAllRead = function() {
        lastReadTime = new Date();
        localStorage.setItem('farmerLastRead', lastReadTime);
        loadFields(); 
        document.getElementById('notif-dropdown').classList.add('hidden');
    }
    
    window.toggleNotif = function() {
        document.getElementById('notif-dropdown').classList.toggle('hidden');
    }

    // --- Modal Functions ---
    window.openSaleModal = function(buyerName, buyerPhone, soldAt, qty, price, total) {
        document.getElementById('modal-buyer-name').innerText = buyerName;
        document.getElementById('modal-buyer-phone-link').innerText = buyerPhone;
        document.getElementById('modal-buyer-phone-link').href = `tel:${buyerPhone}`;
        document.getElementById('modal-sold-at').innerText = soldAt;
        document.getElementById('modal-qty').innerText = qty;
        document.getElementById('modal-price').innerText = price;
        document.getElementById('modal-total').innerText = total;

        const modal = document.getElementById('saleModal');
        const content = document.getElementById('saleModalContent');
        modal.classList.remove('hidden');
        setTimeout(() => { 
            content.classList.remove('scale-95', 'opacity-0'); 
            content.classList.add('scale-100', 'opacity-100'); 
        }, 10);
    }

    window.closeModal = function() {
        const modal = document.getElementById('saleModal');
        const content = document.getElementById('saleModalContent');
        content.classList.remove('scale-100', 'opacity-100');
        content.classList.add('scale-95', 'opacity-0');
        setTimeout(() => { modal.classList.add('hidden'); }, 200);
    }

    // ==========================================
    // 5. Actions (API Calls)
    // ==========================================
    window.calcYield = async (id, btn) => {
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...'; 
        btn.disabled = true;
        
        try {
            const res = await fetch(`/api/rice-fields/${id}/calculate_yield/`, { 
                method: 'POST', 
                headers: {'X-CSRFToken': '{{ csrf_token }}'} 
            });
            const data = await res.json();
            
            if(res.ok) {
                // 1. ‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° (Logic ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Layer Switcher)
                if (satelliteLayer) map.removeLayer(satelliteLayer); 
                if (data.satellite_image) {
                    satelliteLayer = L.tileLayer(data.satellite_image, {
                        attribution: 'Sentinel-2 (Real-time)',
                        opacity: 1.0 
                    }).addTo(map);
                    
                    if(fieldLayers[id]) map.flyToBounds(fieldLayers[id].getBounds(), { padding: [50,50], maxZoom: 16 });
                    
                    // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏°‡∏≤‡∏ó‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß
                    Swal.fire({
                        toast: true, position: 'top-end', icon: 'info', 
                        title: '‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î', timer: 3000, showConfirmButton: false
                    });
                }

                let headerHtml = '';
                let icon = 'success';
                let btnColor = '#16a34a';

                if (data.result_type === 'building') {
                    headerHtml = `<div class="bg-red-100 text-red-700 p-2 rounded-lg mb-3 text-sm border border-red-200">‚ö†Ô∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÄ‡∏õ‡πá‡∏ô <b>‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á</b> (NDBI: ${data.ndbi})</div>`;
                    icon = 'error';
                    btnColor = '#ef4444';
                } else if (data.result_type === 'road') {
                    headerHtml = `<div class="bg-orange-100 text-orange-700 p-2 rounded-lg mb-3 text-sm border border-orange-200">üõ£Ô∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÄ‡∏õ‡πá‡∏ô <b>‡∏ñ‡∏ô‡∏ô/‡∏î‡∏¥‡∏ô‡πÇ‡∏•‡πà‡∏á</b> (NDVI ‡∏ï‡πà‡∏≥)</div>`;
                    icon = 'warning';
                    btnColor = '#f97316';
                } else if (data.result_type === 'water') {
                    headerHtml = `<div class="bg-blue-100 text-blue-700 p-2 rounded-lg mb-3 text-sm border border-blue-200">üíß ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÄ‡∏õ‡πá‡∏ô <b>‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ô‡πâ‡∏≥</b></div>`;
                    icon = 'info';
                    btnColor = '#3b82f6';
                } else {
                    headerHtml = `<div class="bg-green-100 text-green-700 p-2 rounded-lg mb-3 text-sm border border-green-200">üåæ <b>‡∏ô‡∏≤‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</b> ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</div>`;
                }

                Swal.fire({ 
                    title: '‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå',
                    html: `
                        <div class="mt-2">
                            ${headerHtml}
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 shadow-sm mb-3">
                                <h3 class="text-3xl font-bold text-gray-800">${data.yield_ton} <span class="text-base text-gray-500 font-normal">‡∏ï‡∏±‡∏ô</span></h3>
                                <p class="text-sm text-gray-500">‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå</p>
                            </div>
                            <div class="grid grid-cols-2 gap-3 text-left text-sm">
                                <div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm">
                                    <span class="text-gray-400 block text-[10px] uppercase">üí∞ ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</span>
                                    <span class="font-bold text-gray-800 text-lg">${data.revenue.toLocaleString()} ‡∏ö.</span>
                                </div>
                                <div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm">
                                    <span class="text-gray-400 block text-[10px] uppercase">üåø ‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏û‡∏∑‡∏ä (NDVI)</span>
                                    <span class="font-bold text-gray-800 text-lg">${data.ndvi}</span>
                                </div>
                                <div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm">
                                    <span class="text-gray-400 block text-[10px] uppercase">üìè ‡∏Ç‡∏ô‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</span>
                                    <span class="font-bold text-gray-800 text-lg">${data.area} ‡πÑ‡∏£‡πà</span>
                                </div>
                                <div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm">
                                    <span class="text-gray-400 block text-[10px] uppercase">üè¢ ‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á</span>
                                    <span class="font-bold text-gray-800 text-lg">${data.ndbi}</span>
                                </div>
                            </div>
                            <p class="text-[10px] text-gray-400 mt-3 text-center">
                                <i class="fa-solid fa-satellite"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° Sentinel-2 ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                            </p>
                        </div>
                    `,
                    icon: icon, confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö', confirmButtonColor: btnColor, width: '400px'
                });

                loadFields(); 
            } else {
                Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: data.error });
            }
        } catch(e) { 
            Swal.fire({ icon: 'error', title: 'Error', text: '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß' }); 
        } finally { 
            btn.innerHTML = originalText; btn.disabled = false; 
        }
    }

    // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô toggleSatellite ‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÉ‡∏ä‡πâ Layer Control ‡πÅ‡∏ó‡∏ô‡πÅ‡∏•‡πâ‡∏ß)

    window.notifySale = async (id) => {
        const { value: form } = await Swal.fire({
            title: 'üì¢ ‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡∏≤‡∏¢‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï',
            html: `
                <input id="q" type="number" class="swal2-input" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ï‡∏±‡∏ô)">
                <input id="p" type="number" class="swal2-input" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó/‡∏ï‡∏±‡∏ô)">
                <input id="ph" type="tel" class="swal2-input" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠">
            `,
            showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
            preConfirm: () => {
                const q = document.getElementById('q').value, p = document.getElementById('p').value, ph = document.getElementById('ph').value;
                if(!q || !p || !ph) Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
                return { rice_field: id, quantity_ton: q, price_per_ton: p, phone: ph }
            }
        });
        if(form) { 
            await fetch('/api/sales/', { method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'}, body: JSON.stringify(form) });
            Swal.fire({ icon: 'success', title: '‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', timer: 2000, showConfirmButton: false });
            loadFields(); 
        }
    }

    window.respondSale = async (id, action) => {
        const url = `/api/sales/${id}/${action}_sell/`;
        Swal.fire({title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...', didOpen: () => Swal.showLoading()});
        try {
            const res = await fetch(url, { method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'} });
            if(res.ok) {
                Swal.fire({ icon: 'success', title: action==='approve'?'‡∏Ç‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢':'‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏•‡πâ‡∏ß', timer: 2000, showConfirmButton: false });
                loadFields();
            }
        } catch(e) { Swal.fire({ icon: 'error', text: 'Connection failed' }); }
    }

    window.cancelSale = async (id) => {
        const result = await Swal.fire({ title: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444', confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' });
        if(result.isConfirmed) {
            await fetch(`/api/sales/${id}/`, { method: 'DELETE', headers: {'X-CSRFToken': '{{ csrf_token }}'} });
            loadFields();
        }
    }

    window.focusField = function(id) {
        if (fieldLayers[id]) {
            map.flyToBounds(fieldLayers[id].getBounds(), { padding: [100, 100], maxZoom: 16 });
            fieldLayers[id].openPopup();
        }
        document.getElementById('notif-dropdown').classList.add('hidden');
    }

    window.deleteField = async (id, name) => {
        const result = await Swal.fire({ title: '‡∏•‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤?', html: `‡∏•‡∏ö "${name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444', confirmButtonText: '‡∏•‡∏ö' });
        if (result.isConfirmed) {
            await fetch(`/api/rice-fields/${id}/`, { method: 'DELETE', headers: { 'X-CSRFToken': '{{ csrf_token }}' } });
            Swal.fire({ icon: 'success', title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1500, showConfirmButton: false });
            loadFields();
        }
    };

    document.addEventListener('click', function(e) {
        const dd = document.getElementById('notif-dropdown');
        if (!dd.contains(e.target) && !e.target.closest('button[onclick="toggleNotif()"]')) dd.classList.add('hidden');
    });

    loadFields();
    setInterval(loadFields, 5000);
</script>
{% endblock %}