{% extends 'base.html' %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-100px)]">
    
    <div class="lg:col-span-4 flex flex-col gap-4 h-full">
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center relative z-20">
            <div>
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <span class="bg-green-100 text-green-700 p-2 rounded-lg"><i class="fa-solid fa-list-ul"></i></span>
                    ‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                </h2>
                <p class="text-xs text-gray-400 mt-1 pl-11">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï</p>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="relative">
                    <button onclick="toggleNotif()" class="p-2 rounded-full hover:bg-gray-100 transition relative focus:outline-none">
                        <i class="fa-solid fa-bell text-gray-500 text-xl transition-colors hover:text-green-600"></i>
                        <span id="notif-badge" class="absolute top-0 right-0 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden border-2 border-white transform translate-x-1 -translate-y-1 shadow-sm">0</span>
                    </button>

                    <div id="notif-dropdown" class="hidden absolute right-0 mt-3 w-80 bg-white rounded-xl shadow-xl border border-gray-100 overflow-hidden z-50 animate-fade-in-down">
                        <div class="bg-gray-50 px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                            <span class="text-sm font-bold text-gray-700"><i class="fa-solid fa-clock-rotate-left"></i> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span>
                            <span class="text-xs text-blue-500 cursor-pointer hover:text-blue-700 hover:underline" onclick="markAllRead()">‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                        </div>
                        <div id="notif-list" class="max-h-72 overflow-y-auto custom-scrollbar bg-white">
                            <div class="p-6 text-center text-gray-400 text-sm flex flex-col items-center">
                                <i class="fa-regular fa-bell-slash text-2xl mb-2 opacity-50"></i>
                                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-right border-l pl-3 ml-2">
                    <span id="field-count" class="text-2xl font-bold text-green-600">0</span>
                    <span class="text-xs text-gray-400 block">‡πÅ‡∏õ‡∏•‡∏á</span>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 flex-grow overflow-hidden relative z-10">
            <div id="fieldList" class="absolute inset-0 p-4 space-y-3 overflow-y-auto custom-scrollbar pb-20">
                <div class="flex flex-col items-center justify-center h-full text-gray-400 space-y-3 animate-pulse">
                    <i class="fa-solid fa-circle-notch fa-spin text-3xl text-green-200"></i>
                    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                </div>
            </div>
            <div class="absolute bottom-0 left-0 w-full h-10 bg-gradient-to-t from-white to-transparent pointer-events-none"></div>
        </div>
    </div>
    
    <div class="lg:col-span-8 h-full">
        <div class="bg-white p-1 rounded-2xl shadow-lg border border-gray-100 h-full flex flex-col relative overflow-hidden group">
            <div class="absolute top-4 left-14 z-[400] bg-white/95 backdrop-blur-md px-4 py-2 rounded-xl shadow-md border border-gray-200 pointer-events-none transition-opacity group-hover:opacity-100">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i class="fa-solid fa-map-location-dot text-blue-600"></i> ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏Å‡∏©‡∏ï‡∏£
                </h2>
                <div class="flex items-center gap-2 mt-1">
                    <span class="text-[10px] bg-green-500 text-white px-2 py-0.5 rounded-full shadow-sm flex items-center gap-1"><i class="fa-solid fa-wifi text-[8px]"></i> Online</span>
                    <span class="text-[10px] bg-blue-500 text-white px-2 py-0.5 rounded-full shadow-sm">üìç ‡∏à.‡∏û‡∏∞‡πÄ‡∏¢‡∏≤</span>
                </div>
            </div>
            <div id="map" class="w-full h-full rounded-xl z-0 bg-gray-100"></div>
        </div>
    </div>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f8fafc; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    @keyframes fadeInDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-down { animation: fadeInDown 0.2s ease-out; }

    .swal2-input, .swal2-select { 
        border: 1px solid #e2e8f0 !important; border-radius: 12px !important; 
        height: 45px !important; margin: 10px auto !important; box-shadow: none !important;
    }
    .swal2-input:focus, .swal2-select:focus { border-color: #22c55e !important; ring: 2px solid #bbf7d0 !important; }
    .swal2-popup { border-radius: 20px !important; padding: 2rem !important; font-family: 'Sarabun', sans-serif; }
    
    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Close ‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
    .swal2-close {
        font-size: 1.5em !important;
        color: #64748b !important;
    }
    .swal2-close:hover {
        color: #ef4444 !important;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // ==========================================
    // 1. Map Initialization
    // ==========================================
    var googleHybrid = L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: 'Google Hybrid' });
    var map = L.map('map', { center: [19.1667, 99.9000], zoom: 12, layers: [googleHybrid], zoomControl: false });

    L.control.zoom({ position: 'bottomright' }).addTo(map);

    var drawnItems = new L.FeatureGroup().addTo(map);
    var fieldLayers = {}; 
    var lastStatusMap = {}; 

    // ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏≤‡∏î
    map.addControl(new L.Control.Draw({
        position: 'topright',
        draw: { polygon: true, rectangle: true, marker: false, circle: false, polyline: false },
        edit: { featureGroup: drawnItems, remove: false } 
    }));

    // ‡∏õ‡∏∏‡πà‡∏° Locate Me
    var LocateControl = L.Control.extend({
        options: { position: 'bottomright' },
        onAdd: function (map) {
            var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
            container.innerHTML = '<a href="#" class="bg-white hover:bg-gray-50 text-blue-600 w-8 h-8 flex items-center justify-center rounded shadow-sm transition-colors"><i class="fa-solid fa-crosshairs"></i></a>';
            container.onclick = function(e) { e.preventDefault(); map.locate({setView: true, maxZoom: 18}); };
            return container;
        }
    });
    map.addControl(new LocateControl());

    map.on('locationfound', function(e) {
        L.popup().setLatLng(e.latlng).setContent("‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà").openOn(map);
    });

    // ==========================================
    // 2. Event Handlers (Drawing)
    // ==========================================
    map.on(L.Draw.Event.CREATED, async function (e) {
        var layer = e.layer;
        var center = layer.getBounds().getCenter();
        
        // Simple Geofence Check (Phayao)
        if (center.lng < 99.80 || center.lng > 100.10 || center.lat < 19.00 || center.lat > 19.35) {
            Swal.fire({ 
                icon: 'error', 
                title: '‡∏ô‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà!', 
                text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏î‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à.‡∏û‡∏∞‡πÄ‡∏¢‡∏≤ ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô',
                showCloseButton: true,
                timer: 5000,
                timerProgressBar: true 
            });
            return;
        }

        const { value: formValues } = await Swal.fire({
            title: 'üå± ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà',
            html: `
                <div class="text-left space-y-3">
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤</label><input id="swal-name" class="swal2-input w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà 1"></div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Ç‡πâ‡∏≤‡∏ß</label>
                        <select id="swal-variety" class="swal2-select w-full">
                            <option value="KDML105">üçö ‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥ 105</option>
                            <option value="RD6">üçô ‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß ‡∏Å‡∏Ç 6</option>
                            <option value="RD15">üçö ‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥ ‡∏Å‡∏Ç 15</option>
                            <option value="PATHUM1">üåæ ‡∏Ç‡πâ‡∏≤‡∏ß‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ 1</option>
                            <option value="OTHER">üå± ‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
                        </select>
                    </div>
                </div>
            `,
            showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', confirmButtonColor: '#16a34a', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            preConfirm: () => {
                const name = document.getElementById('swal-name').value;
                if(!name) Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤');
                return { name, variety: document.getElementById('swal-variety').value }
            }
        });

        if (formValues) {
            saveField(formValues.name, layer.toGeoJSON().geometry, formValues.variety);
        }
    });

    async function saveField(name, geom, variety) {
        try {
            const res = await fetch('/api/rice-fields/', {
                method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                body: JSON.stringify({name, geometry: geom, variety})
            });
            const data = await res.json();
            
            if(res.ok) { 
                Swal.fire({ 
                    icon: 'success', 
                    title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 
                    timer: 5000, 
                    timerProgressBar: true,
                    showCloseButton: true,
                    showConfirmButton: false 
                });
                loadFields(); 
            } else {
                Swal.fire({
                    icon: 'error',
                    title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: data.error || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                    showCloseButton: true
                });
            }
        } catch(e) { 
            Swal.fire({ icon: 'error', title: 'Error', text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', showCloseButton: true }); 
        }
    }

    // ==========================================
    // 3. Core Logic: Load Data
    // ==========================================
    async function loadFields() {
        try {
            const [fieldRes, saleRes] = await Promise.all([fetch('/api/rice-fields/'), fetch('/api/sales/')]);
            const fields = await fieldRes.json();
            const sales = await saleRes.json();
            
            const saleMap = {};
            const notifList = [];
            sales.forEach(s => { 
                if (!saleMap[s.rice_field]) saleMap[s.rice_field] = s;
                if (s.status === 'REQUESTED' || s.status === 'SOLD') notifList.push(s);
            });

            updateNotifications(notifList);

            const listContainer = document.getElementById('fieldList');
            document.getElementById('field-count').innerText = fields.length;
            listContainer.innerHTML = '';
            drawnItems.clearLayers();
            fieldLayers = {};

            if (fields.length === 0) {
                listContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-gray-400 opacity-60"><i class="fa-solid fa-vector-square text-5xl mb-3"></i><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤</p><p class="text-xs">‡∏ß‡∏≤‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p></div>`;
                return;
            }

            fields.forEach(f => {
                const activeSale = saleMap[f.id];
                const status = activeSale ? activeSale.status : 'NONE';

                // ‚úÖ Popup Alert Status Change (‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)
                if (lastStatusMap[f.id] && lastStatusMap[f.id] !== status) {
                    if (status === 'REQUESTED') {
                        Swal.fire({ 
                            title: '‡∏°‡∏µ‡∏Ñ‡∏ô‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠!', 
                            text: `‡πÅ‡∏õ‡∏•‡∏á "${f.name}" ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏™‡∏ô‡πÉ‡∏à`, 
                            icon: 'info',
                            timer: 10000, // 10 ‡∏ß‡∏¥
                            timerProgressBar: true,
                            showCloseButton: true
                        });
                    } else if (status === 'SOLD') {
                        Swal.fire({ 
                            title: 'üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                            html: `‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤ <b>"${f.name}"</b><br>‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 
                            icon: 'success', 
                            timer: 10000, // 10 ‡∏ß‡∏¥
                            timerProgressBar: true,
                            showCloseButton: true
                        });
                    }
                }
                lastStatusMap[f.id] = status;

                // UI Variables
                let borderClass = "border-l-green-500", bgHover = "hover:bg-green-50";
                let statusBadge = "", actionButtons = "";
                let polyColor = "#22c55e", dashArray = '5, 5';

                // --- Logic ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Status Flow) ---
                if (status === 'OPEN') {
                    // ‡∏£‡∏≠‡∏Ç‡∏≤‡∏¢
                    borderClass = "border-l-orange-500"; bgHover = "hover:bg-orange-50"; polyColor = "#f97316"; dashArray = null;
                    statusBadge = `<span class="absolute top-2 right-10 text-[10px] bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full font-bold border border-orange-200 shadow-sm"><i class="fa-solid fa-clock"></i> ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</span>`;
                    actionButtons = `<div class="col-span-2"><button onclick="cancelSale(${activeSale.id}, '${f.name}')" class="w-full bg-red-50 hover:bg-red-100 text-red-600 text-xs font-bold py-2.5 rounded-lg border border-red-100"><i class="fa-solid fa-xmark"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button></div>`;
                
                } else if (status === 'REQUESTED') {
                    // ‡∏°‡∏µ‡∏Ñ‡∏ô‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠ (‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)
                    borderClass = "border-l-yellow-500"; bgHover = "hover:bg-yellow-50"; polyColor = "#eab308";
                    statusBadge = `<span class="absolute top-2 right-10 text-[10px] bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full font-bold border border-yellow-200 animate-pulse"><i class="fa-solid fa-bell"></i> ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>`;
                    actionButtons = `
                        <div class="col-span-2 bg-yellow-50 p-2 rounded-lg border border-yellow-200 mb-2 text-xs text-gray-700">
                            <b>‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠:</b> ${activeSale.buyer_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}<br>
                            <b>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:</b> ${activeSale.buyer_contact || '-'}
                        </div>
                        <button onclick="respondSale(${activeSale.id}, 'approve')" class="flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-2.5 rounded-lg shadow-sm">‡∏Ç‡∏≤‡∏¢‡πÄ‡∏•‡∏¢</button>
                        <button onclick="respondSale(${activeSale.id}, 'reject')" class="flex items-center justify-center gap-2 bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-2.5 rounded-lg shadow-sm">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                    `;

                } else if (status === 'SOLD') {
                    // ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß
                    borderClass = "border-l-gray-400 opacity-80"; bgHover = "hover:bg-gray-50"; polyColor = "#9ca3af"; dashArray = null;
                    statusBadge = `<span class="absolute top-2 right-10 text-[10px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full font-bold border border-gray-200"><i class="fa-solid fa-check-circle"></i> ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>`;
                    actionButtons = `<div class="col-span-2 text-center text-xs text-green-600 py-2 bg-green-50 rounded-lg border border-green-100 font-bold"><i class="fa-solid fa-handshake"></i> ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</div>`;

                } else {
                    // ‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ç‡∏≤‡∏¢)
                    let calcBtnText = '<i class="fa-solid fa-satellite-dish"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå';
                    if (f.latest_yield) calcBtnText = '<i class="fa-solid fa-rotate"></i> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà';
                    
                    // ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡∏≤‡∏¢‡∏à‡∏∞‡∏Å‡∏î‡πÑ‡∏î‡πâ‡∏Å‡πá‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï (yield > 0)
                    let canSell = f.latest_yield && f.latest_yield.yield > 0;
                    let sellBtnClass = canSell ? 'bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white' : 'bg-gray-100 text-gray-400 cursor-not-allowed';
                    
                    actionButtons = `
                        <button onclick="calcYield(${f.id}, this)" class="flex items-center justify-center gap-2 bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-2.5 rounded-lg shadow-sm transition-all">${calcBtnText}</button>
                        <button onclick="notifySale(${f.id})" class="flex items-center justify-center gap-2 ${sellBtnClass} text-xs font-bold py-2.5 rounded-lg shadow-sm transition-all" ${canSell ? '' : 'disabled'}><i class="fa-solid fa-bullhorn"></i> ‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡∏≤‡∏¢</button>
                    `;
                }

                // Render Yield Info
                let yieldContent = f.latest_yield ? 
                    `<div class="grid grid-cols-2 gap-4 text-center divide-x divide-green-200">
                        <div><p class="text-[10px] text-gray-500 uppercase">NDVI</p><p class="text-lg font-bold text-green-700">${f.latest_yield.ndvi.toFixed(3)}</p></div>
                        <div><p class="text-[10px] text-gray-500 uppercase">‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï</p><p class="text-lg font-bold text-orange-600">${f.latest_yield.yield.toFixed(2)} <span class="text-xs text-gray-400 font-normal">‡∏ï‡∏±‡∏ô</span></p></div>
                    </div>` : '<p class="text-xs opacity-60">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
                let yieldClass = f.latest_yield ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-dashed border-gray-200 text-gray-400';

                // Create Card
                const card = document.createElement('div');
                card.className = `bg-white border border-gray-100 p-4 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 relative group overflow-hidden border-l-4 ${borderClass} mb-2`;
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="pr-2 overflow-hidden cursor-pointer ${bgHover} rounded p-1 transition-colors w-full" onclick="focusField(${f.id})">
                            <h3 class="font-bold text-gray-800 text-lg truncate flex items-center gap-2">${f.name}</h3>
                            ${statusBadge}
                            <div class="flex flex-wrap items-center gap-2 mt-1">
                                <span class="text-[10px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded-md"><i class="fa-solid fa-seedling text-green-500 mr-1"></i> ${f.variety_display || f.variety}</span>
                                <span class="text-[10px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded-md"><i class="fa-solid fa-chart-area text-blue-500 mr-1"></i> ${f.area_rai} ‡πÑ‡∏£‡πà</span>
                            </div>
                        </div>
                        <button onclick="deleteField(${f.id}, '${f.name}')" class="text-gray-300 hover:text-red-500 p-1.5"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                    <div class="my-3 p-3 rounded-lg border ${yieldClass} text-center transition-all">${yieldContent}</div>
                    <div class="grid grid-cols-2 gap-2 mt-2">${actionButtons}</div>
                `;
                listContainer.appendChild(card);

                // Map
                if(f.boundary) {
                    try {
                        const geoJsonData = (typeof f.boundary === 'string') ? JSON.parse(f.boundary) : f.boundary;
                        const layer = L.geoJSON(geoJsonData, {
                            style: { color: polyColor, weight: 2, fillOpacity: 0.3, dashArray: dashArray }
                        }).bindPopup(`<b>${f.name}</b><br>${f.area_rai} ‡πÑ‡∏£‡πà`).addTo(map).addTo(drawnItems);
                        fieldLayers[f.id] = layer;
                    } catch(e) {}
                }
            });
        } catch (error) { console.error(error); }
    }

    // ==========================================
    // 4. Notifications & UI Utils
    // ==========================================
    function updateNotifications(notifList) {
        const badge = document.getElementById('notif-badge');
        const listDiv = document.getElementById('notif-list');
        const unread = notifList.length;

        if (unread > 0) {
            badge.innerText = unread > 9 ? '9+' : unread;
            badge.classList.remove('hidden');
            badge.classList.add('animate-bounce');
        } else {
            badge.classList.add('hidden');
        }

        if (notifList.length === 0) {
            listDiv.innerHTML = `<div class="p-8 text-center text-gray-400 text-sm"><i class="fa-regular fa-bell-slash text-2xl mb-2 opacity-50"></i><br>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>`;
        } else {
            listDiv.innerHTML = '';
            notifList.sort((a,b) => b.id - a.id).forEach(s => {
                let msg = s.status === 'REQUESTED' ? '‡∏°‡∏µ‡∏Ñ‡∏ô‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡πâ‡∏≤‡∏ß' : '‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß';
                let icon = s.status === 'REQUESTED' ? 'fa-user-clock text-yellow-500' : 'fa-check-circle text-green-500';
                
                listDiv.innerHTML += `
                    <div class="p-3 border-b border-gray-50 hover:bg-gray-50 cursor-pointer" onclick="focusField(${s.rice_field})">
                        <div class="flex items-start gap-3">
                            <div class="bg-white p-2 rounded-full shadow-sm"><i class="fa-solid ${icon}"></i></div>
                            <div><p class="text-sm font-bold text-gray-800">${msg}</p><p class="text-xs text-gray-500">‡πÅ‡∏õ‡∏•‡∏á: ${s.field_name}</p></div>
                        </div>
                    </div>`;
            });
        }
    }

    window.toggleNotif = function() {
        document.getElementById('notif-dropdown').classList.toggle('hidden');
    }
    
    window.markAllRead = function() {
        document.getElementById('notif-badge').classList.add('hidden');
        Swal.fire({ icon: 'success', title: '‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß', toast: true, position: 'top-end', showConfirmButton: false, timer: 1000 });
    }

    // ==========================================
    // 5. Actions (Calc, Sell, Approve)
    // ==========================================
    window.calcYield = async (id, btn) => {
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>'; 
        btn.disabled = true;
        
        try {
            const res = await fetch(`/api/rice-fields/${id}/calculate_yield/`, { 
                method: 'POST', 
                headers: {'X-CSRFToken': '{{ csrf_token }}'} 
            });
            const data = await res.json();
            
            if(res.ok) {
                // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö NDVI ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 3 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                const ndviFixed = parseFloat(data.ndvi).toFixed(3);

                if (data.result_type === 'water') {
                    Swal.fire({
                        icon: 'warning',
                        title: '‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ô‡πâ‡∏≥!',
                        html: `‡∏Ñ‡πà‡∏≤ NDVI: <b>${ndviFixed}</b><br>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ô‡πâ‡∏≥ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡πÑ‡∏î‡πâ`,
                        position: 'center',
                        timer: 10000,
                        timerProgressBar: true,
                        showCloseButton: true,
                        confirmButtonColor: '#3b82f6'
                    });
                } 
                else if (data.result_type === 'road') {
                    Swal.fire({
                        icon: 'warning',
                        title: '‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏©‡∏ï‡∏£!',
                        html: `‡∏Ñ‡πà‡∏≤ NDVI: <b>${ndviFixed}</b><br>‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏ñ‡∏ô‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á`,
                        position: 'center',
                        timer: 10000,
                        timerProgressBar: true,
                        showCloseButton: true,
                        confirmButtonColor: '#f59e0b'
                    });
                } 
                else {
                    Swal.fire({ 
                        icon: 'success', 
                        title: '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 
                        html: `NDVI: <b>${ndviFixed}</b><br>‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå: <b>${data.yield_ton} ‡∏ï‡∏±‡∏ô</b><br><span class="text-xs text-gray-500">(${data.note})</span>`,
                        position: 'center',
                        timer: 10000, 
                        timerProgressBar: true,
                        showCloseButton: true,
                        showConfirmButton: false 
                    });
                }
                loadFields(); 
            } else {
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: data.error,
                    position: 'center',
                    showCloseButton: true,
                    timer: 10000,
                    timerProgressBar: true
                });
            }
        } catch(e) { 
            Swal.fire({ 
                icon: 'error', 
                title: 'Error', 
                text: '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 
                position: 'top-start',
                showCloseButton: true 
            }); 
        } finally { 
            btn.innerHTML = originalText; 
            btn.disabled = false; 
        }
    }

    window.notifySale = async (id) => {
        const { value: form } = await Swal.fire({
            title: 'üì¢ ‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡∏≤‡∏¢‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï',
            html: `
                <input id="q" type="number" class="swal2-input" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ï‡∏±‡∏ô)">
                <input id="p" type="number" class="swal2-input" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó/‡∏ï‡∏±‡∏ô)">
                <input id="ph" type="tel" class="swal2-input" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠">
            `,
            showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', confirmButtonColor: '#16a34a',
            preConfirm: () => {
                const q = document.getElementById('q').value, p = document.getElementById('p').value, ph = document.getElementById('ph').value;
                if(!q || !p || !ph) Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
                return { rice_field: id, quantity_ton: q, price_per_ton: p, phone: ph }
            }
        });
        if(form) { 
            await fetch('/api/sales/', { method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'}, body: JSON.stringify(form) });
            loadFields(); 
            Swal.fire({ 
                icon: 'success', 
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 
                text: '‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 
                timer: 5000, 
                timerProgressBar: true,
                showCloseButton: true,
                showConfirmButton: false
            });
        }
    }

    window.respondSale = async (id, action) => {
        const url = `/api/sales/${id}/${action}_sell/`;
        Swal.fire({title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...', didOpen: () => Swal.showLoading()});
        try {
            const res = await fetch(url, { method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'} });
            if(res.ok) {
                Swal.fire({
                    icon: 'success', 
                    title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 
                    text: action==='approve'?'‡∏Ç‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢':'‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏•‡πâ‡∏ß',
                    timer: 5000,
                    timerProgressBar: true,
                    showCloseButton: true,
                    showConfirmButton: false
                });
                loadFields();
            }
        } catch(e) { Swal.fire({ icon: 'error', title: 'Error', text: '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', showCloseButton: true }); }
    }

    window.cancelSale = async (id) => {
        if(confirm('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ç‡∏≤‡∏¢?')) {
            await fetch(`/api/sales/${id}/`, { method: 'DELETE', headers: {'X-CSRFToken': '{{ csrf_token }}'} });
            loadFields();
        }
    }

    window.focusField = function(id) {
        if (fieldLayers[id]) {
            map.flyToBounds(fieldLayers[id].getBounds(), { padding: [100, 100], maxZoom: 16 });
            fieldLayers[id].openPopup();
        }
    }

    window.deleteField = async (id, name) => {
        const result = await Swal.fire({
            title: '‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
            html: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤<br><b>"${name}"</b> ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '‡∏•‡∏ö',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#94a3b8',
            reverseButtons: true,
            showCloseButton: true
        });

        if (result.isConfirmed) {
            try {
                await fetch(`/api/rice-fields/${id}/`, {
                    method: 'DELETE',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                });

                Swal.fire({
                    icon: 'success',
                    title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                    timer: 3000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });

                loadFields();
            } catch (e) {
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ',
                    showCloseButton: true
                });
            }
        }
    };

    // Close Dropdown
    document.addEventListener('click', function(e) {
        const dd = document.getElementById('notif-dropdown');
        if (!dd.contains(e.target) && !e.target.closest('button[onclick="toggleNotif()"]')) dd.classList.add('hidden');
    });

    loadFields();
    setInterval(loadFields, 5000);
</script>
{% endblock %}