{% extends 'base.html' %}

{% block content %}
<div class="h-[calc(100vh-80px)] flex flex-col lg:grid lg:grid-cols-12 lg:gap-6 relative">
    
    <div id="view-overview" class="flex-grow lg:col-span-5 flex flex-col gap-4 h-full overflow-hidden transition-all duration-300">
        
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 shrink-0 flex justify-between items-center">
            <div>
                <h1 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i class="fa-solid fa-building-columns text-purple-600"></i> ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≤‡∏ß (Govt)
                </h1>
                <p class="text-xs text-gray-500 mt-1">Command Center ‡∏à.‡∏û‡∏∞‡πÄ‡∏¢‡∏≤</p>
            </div>
            <div class="flex gap-2">
                <span class="text-[10px] text-gray-400 self-center hidden sm:inline">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î <span id="lastUpdate" class="font-mono text-gray-800 font-bold">-</span></span>
                <button onclick="forceUpdate()" class="bg-gray-100 hover:bg-gray-200 text-gray-600 w-8 h-8 rounded-full flex items-center justify-center transition shadow-sm" title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä"><i class="fa-solid fa-rotate"></i></button>
            </div>
        </div>
        
        <div class="flex-grow overflow-y-auto custom-scrollbar pb-20 lg:pb-0 space-y-4 p-1">
            
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-purple-600 text-white p-3 rounded-xl shadow relative overflow-hidden">
                    <p class="text-[10px] text-purple-200 uppercase font-bold">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ï‡∏•‡∏≤‡∏î‡∏£‡∏ß‡∏°</p>
                    <h3 class="text-xl font-bold mt-1" id="kpi-revenue">0</h3>
                    <span class="text-[10px] opacity-80">‡∏ö‡∏≤‡∏ó</span>
                </div>
                <div class="bg-white p-3 rounded-xl shadow-sm border border-blue-100">
                    <p class="text-[10px] text-gray-400 uppercase font-bold">‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏£‡∏ß‡∏°</p>
                    <h3 class="text-xl font-bold text-blue-600 mt-1" id="kpi-supply">0</h3>
                    <span class="text-[10px] text-gray-400">‡∏ï‡∏±‡∏ô</span>
                </div>
                <div class="bg-white p-3 rounded-xl shadow-sm border border-green-100">
                    <p class="text-[10px] text-gray-400 uppercase font-bold">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</p>
                    <h3 class="text-xl font-bold text-green-600 mt-1" id="kpi-price">0</h3>
                    <span class="text-[10px] text-gray-400">‡∏ö‡∏≤‡∏ó/‡∏ï‡∏±‡∏ô</span>
                </div>
                <div class="bg-white p-3 rounded-xl shadow-sm border border-orange-100">
                    <p class="text-[10px] text-gray-400 uppercase font-bold">‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</p>
                    <h3 class="text-xl font-bold text-orange-600 mt-1" id="kpi-farmers">0</h3>
                    <span class="text-[10px] text-gray-400">‡∏£‡∏≤‡∏¢</span>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <h4 class="text-xs font-bold text-gray-600 mb-2">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h4>
                <div class="h-[150px] relative"><canvas id="monthlyChart"></canvas></div>
            </div>
            
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <h4 class="text-xs font-bold text-gray-600 mb-2">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Ç‡πâ‡∏≤‡∏ß</h4>
                <div class="flex items-center gap-4">
                    <div class="h-[120px] w-[120px] relative"><canvas id="varietyChart"></canvas></div>
                    <div id="variety-legend" class="flex-1 text-[10px] space-y-1"></div>
                </div>
            </div>

            <div class="hidden lg:block bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="flex border-b border-gray-100">
                    <button onclick="switchDesktopTable('sales')" id="tab-sales" class="flex-1 py-3 text-xs font-bold text-blue-600 border-b-2 border-blue-600 bg-blue-50/50 transition-colors">
                        <i class="fa-solid fa-list mr-1"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢
                    </button>
                    <button onclick="switchDesktopTable('risk')" id="tab-risk" class="flex-1 py-3 text-xs font-bold text-gray-400 hover:text-red-500 hover:bg-red-50 transition-colors">
                        <i class="fa-solid fa-triangle-exclamation mr-1"></i> ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á (<span id="risk-count">0</span>)
                    </button>
                </div>

                <div class="bg-gray-50 px-4 py-2 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="font-bold text-gray-700 text-xs" id="table-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                    <button onclick="exportCSV()" class="text-[10px] text-blue-600 hover:underline"><i class="fa-solid fa-download"></i> CSV</button>
                </div>

                <div class="overflow-x-auto max-h-[300px] custom-scrollbar">
                    <table class="w-full text-xs text-left whitespace-nowrap">
                        <thead class="bg-white text-gray-500 border-b sticky top-0 shadow-sm z-10" id="table-head">
                            </thead>
                        <tbody id="desktopTableBody" class="divide-y divide-gray-50 text-gray-700"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="view-map" class="hidden lg:block lg:col-span-7 h-full bg-white rounded-2xl shadow-lg border border-gray-100 relative overflow-hidden group">
        <div id="map" class="w-full h-full z-0 bg-slate-100"></div>
        
        <div class="absolute bottom-6 left-4 z-[500] bg-white/95 backdrop-blur px-3 py-2 rounded-lg shadow-md border border-gray-200 pointer-events-none">
            <span class="text-[10px] font-bold text-gray-500 block mb-1">‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå</span>
            <div class="space-y-1 text-[10px]">
                <div class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-green-500"></span> ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</div>
                <div class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-yellow-400"></span> ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
                <div class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-orange-500"></span> ‡∏£‡∏≠‡∏Ç‡∏≤‡∏¢</div>
                <div class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á (NDVI ‡∏ï‡πà‡∏≥)</div>
            </div>
        </div>
    </div>

    <div id="view-list" class="hidden h-full flex-col bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden lg:hidden">
        <div class="p-3 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
            <h3 class="font-bold text-gray-700 text-sm">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á</h3>
            <button onclick="forceUpdate()" class="text-xs text-blue-600"><i class="fa-solid fa-rotate"></i></button>
        </div>
        <div class="flex p-2 gap-2 bg-gray-50">
            <button onclick="switchMobileList('sales')" class="flex-1 py-1.5 rounded text-xs font-bold bg-white shadow-sm text-blue-600 border border-blue-100">‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</button>
            <button onclick="switchMobileList('risk')" class="flex-1 py-1.5 rounded text-xs font-bold text-gray-500 hover:bg-white hover:text-red-500 transition">‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á</button>
        </div>
        <div id="mobileListBody" class="flex-grow overflow-auto custom-scrollbar p-3 space-y-3 pb-20 bg-slate-50">
            <div class="text-center py-10 text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-[1002] lg:hidden flex justify-around items-center h-16 pb-safe">
        <button onclick="switchTab('overview')" id="btn-tab-overview" class="flex flex-col items-center justify-center w-1/3 h-full text-purple-600 border-t-2 border-purple-600 bg-purple-50/50 transition-all">
            <i class="fa-solid fa-chart-pie text-xl mb-1"></i><span class="text-[10px] font-bold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
        </button>
        <button onclick="switchTab('map')" id="btn-tab-map" class="flex flex-col items-center justify-center w-1/3 h-full text-gray-400 border-t-2 border-transparent transition-all">
            <i class="fa-solid fa-map-location-dot text-xl mb-1"></i><span class="text-[10px] font-bold">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</span>
        </button>
        <button onclick="switchTab('list')" id="btn-tab-list" class="flex flex-col items-center justify-center w-1/3 h-full text-gray-400 border-t-2 border-transparent transition-all">
            <i class="fa-solid fa-list-ul text-xl mb-1"></i><span class="text-[10px] font-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        </button>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // === 1. UI Logic ===
    let currentTableMode = 'sales'; // 'sales' or 'risk'

    function switchTab(tab) {
        const views = { overview: 'view-overview', map: 'view-map', list: 'view-list' };
        Object.keys(views).forEach(k => {
            const el = document.getElementById(views[k]);
            if(k === tab) el.classList.remove('hidden'); else el.classList.add('hidden');
        });

        // Update Mobile Bottom Bar
        const btns = { overview: 'btn-tab-overview', map: 'btn-tab-map', list: 'btn-tab-list' };
        Object.keys(btns).forEach(k => {
            const btn = document.getElementById(btns[k]);
            if(k === tab) btn.className = "flex flex-col items-center justify-center w-1/3 h-full text-purple-600 border-t-2 border-purple-600 bg-purple-50/50 transition-all";
            else btn.className = "flex flex-col items-center justify-center w-1/3 h-full text-gray-400 border-t-2 border-transparent transition-all";
        });

        if (window.innerWidth >= 1024) { 
            document.getElementById('view-overview').classList.remove('hidden');
            document.getElementById('view-map').classList.remove('hidden');
            document.getElementById('view-list').classList.add('hidden'); 
        } 
        
        if (tab === 'map') setTimeout(() => { map.invalidateSize(); }, 300);
    }

    function switchDesktopTable(mode) {
        currentTableMode = mode;
        const btnSales = document.getElementById('tab-sales');
        const btnRisk = document.getElementById('tab-risk');
        
        if(mode === 'sales') {
            btnSales.className = "flex-1 py-3 text-xs font-bold text-blue-600 border-b-2 border-blue-600 bg-blue-50/50 transition-colors";
            btnRisk.className = "flex-1 py-3 text-xs font-bold text-gray-400 hover:text-red-500 hover:bg-red-50 transition-colors";
        } else {
            btnSales.className = "flex-1 py-3 text-xs font-bold text-gray-400 hover:text-blue-600 hover:bg-blue-50 transition-colors";
            btnRisk.className = "flex-1 py-3 text-xs font-bold text-red-600 border-b-2 border-red-600 bg-red-50/50 transition-colors";
        }
        renderTables();
    }

    function switchMobileList(mode) {
        currentTableMode = mode;
        renderTables();
    }

    // === 2. Map Init ===
    const map = L.map('map', { center: [19.1667, 99.9000], zoom: 10, zoomControl: false });
    var googleHybrid = L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{maxZoom:20,subdomains:['mt0','mt1','mt2','mt3']});
    var googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{maxZoom:20,subdomains:['mt0','mt1','mt2','mt3']});
    googleHybrid.addTo(map);
    L.control.layers({ "‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°": googleHybrid, "‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏ô‡∏ô": googleStreets }).addTo(map);
    L.control.zoom({position:'bottomright'}).addTo(map);
    const fieldLayer = L.featureGroup().addTo(map);
    let layersMap = {};

    // === 3. Charts Init ===
    const chartConfig = (type, color) => ({
        type: type, 
        data: { labels: [], datasets: [{ data: [], backgroundColor: color, borderRadius: 3 }] }, 
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { font: { size: 9 } } }, x: { ticks: { font: { size: 9 } } } } }
    });
    const monthlyChart = new Chart(document.getElementById('monthlyChart'), chartConfig('bar', '#3b82f6'));
    const varietyChart = new Chart(document.getElementById('varietyChart'), {
        type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444'], borderWidth: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } }
    });

    // === 4. Data Logic ===
    let globalSales = [];
    let globalRiskFields = [];

    async function updateData() {
        try {
            const [fieldsRes, salesRes] = await Promise.all([fetch('/api/rice-fields/'), fetch('/api/sales/')]);
            if(!fieldsRes.ok || !salesRes.ok) { console.error("API Error"); return; }

            const fields = await fieldsRes.json();
            const sales = await salesRes.json();
            globalSales = sales;
            globalRiskFields = [];

            // --- Stats Logic ---
            let totalRevenue = 0, totalVolume = 0;
            let farmerSet = new Set();
            let varietyCount = {};
            let monthlyVol = new Array(12).fill(0);
            let prices = [];

            sales.forEach(s => {
                const qty = parseFloat(s.quantity_ton) || 0;
                const price = parseFloat(s.price_per_ton) || 0;
                if (s.status === 'SOLD') {
                    totalRevenue += (qty * price);
                    totalVolume += qty;
                    farmerSet.add(s.farmer_name);
                    prices.push(price);
                }
                monthlyVol[new Date(s.created_at).getMonth()] += qty;
                varietyCount[s.variety_display] = (varietyCount[s.variety_display] || 0) + qty;
            });

            const avgPrice = prices.length > 0 ? (prices.reduce((a,b)=>a+b,0)/prices.length) : 0;

            // UI Update
            document.getElementById('kpi-revenue').innerText = totalRevenue.toLocaleString(undefined, {maximumFractionDigits:0});
            document.getElementById('kpi-supply').innerText = totalVolume.toLocaleString();
            document.getElementById('kpi-price').innerText = avgPrice.toLocaleString(undefined, {maximumFractionDigits:0});
            document.getElementById('kpi-farmers').innerText = farmerSet.size;

            // Charts
            monthlyChart.data.labels = ["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];
            monthlyChart.data.datasets[0].data = monthlyVol; monthlyChart.update();
            varietyChart.data.labels = Object.keys(varietyCount); varietyChart.data.datasets[0].data = Object.values(varietyCount); varietyChart.update();
            
            let legHTML=''; Object.entries(varietyCount).forEach(([k,v],i)=>{ 
                legHTML+=`<div class="flex justify-between text-[10px]"><span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full" style="background:${['#3b82f6','#10b981','#f59e0b','#ef4444'][i%4]}"></span>${k}</span><b>${v.toLocaleString()}</b></div>`; 
            });
            document.getElementById('variety-legend').innerHTML = legHTML;

            // --- Map & Risk Logic ---
            fieldLayer.clearLayers(); layersMap = {};
            const salesMap={}; sales.forEach(s=>{ if(!salesMap[s.rice_field] || new Date(salesMap[s.rice_field].created_at)<new Date(s.created_at)) salesMap[s.rice_field]=s; });

            fields.forEach(f => {
                if(f.boundary) {
                    try {
                        const geo = JSON.parse(f.boundary);
                        const sale = salesMap[f.id];
                        
                        // Risk Check (NDVI)
                        let ndvi = f.latest_yield ? parseFloat(f.latest_yield.ndvi) : (Math.random()*0.8); // Demo fallback
                        if (ndvi < 0.35) {
                            f.ndvi = ndvi; 
                            globalRiskFields.push(f);
                        }

                        let col='#cbd5e1', op=0.3, weight=1, popupHeader=`<div class="bg-gray-100 px-3 py-1.5 border-b text-[10px] font-bold text-gray-500">‡∏ß‡πà‡∏≤‡∏á</div>`;
                        let popupBody = `<div class="p-3 text-center"><b class="text-sm text-gray-800">${f.name}</b><br><span class="text-xs text-gray-500">${f.area_rai} ‡πÑ‡∏£‡πà</span></div>`;

                        if (ndvi < 0.35) {
                            col='#ef4444'; weight=2; op=0.5;
                            popupHeader=`<div class="bg-red-500 px-3 py-1.5 text-white text-[10px] font-bold uppercase"><i class="fa-solid fa-triangle-exclamation"></i> ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á (NDVI: ${ndvi.toFixed(2)})</div>`;
                        }

                        if(sale) {
                            const priceVal = parseFloat(sale.price_per_ton).toLocaleString();
                            const totalVal = (parseFloat(sale.quantity_ton) * parseFloat(sale.price_per_ton)).toLocaleString();
                            
                            if(sale.status==='SOLD') { col='#22c55e'; op=0.6; weight=2; popupHeader=`<div class="bg-green-500 px-3 py-1.5 text-white text-[10px] font-bold uppercase"><i class="fa-solid fa-check"></i> ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</div>`; }
                            else if(sale.status==='REQUESTED') { col='#eab308'; op=0.8; weight=2; popupHeader=`<div class="bg-yellow-400 px-3 py-1.5 text-yellow-900 text-[10px] font-bold uppercase"><i class="fa-solid fa-clock"></i> ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>`; }
                            else { col='#f97316'; weight=2; popupHeader=`<div class="bg-orange-500 px-3 py-1.5 text-white text-[10px] font-bold uppercase"><i class="fa-solid fa-bullhorn"></i> ‡∏£‡∏≠‡∏Ç‡∏≤‡∏¢</div>`; }
                            
                            popupBody = `
                                <div class="p-3 text-xs space-y-2 bg-white">
                                    <div class="flex justify-between border-b pb-1"><span>‡πÅ‡∏õ‡∏•‡∏á:</span> <b>${f.name}</b></div>
                                    <div class="grid grid-cols-2 gap-2 text-[10px]">
                                        <div><span class="text-gray-400">‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</span><br><b>${sale.farmer_name}</b></div>
                                        <div class="text-right"><span class="text-gray-400">‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠</span><br><b class="text-blue-600">${sale.buyer_name||'-'}</b></div>
                                    </div>
                                    <div class="bg-gray-50 p-2 rounded">
                                        <div class="flex justify-between"><span>‡∏£‡∏≤‡∏Ñ‡∏≤:</span> <b>${priceVal} ‡∏ö.</b></div>
                                        <div class="flex justify-between text-green-600 font-bold border-t mt-1 pt-1"><span>‡∏£‡∏ß‡∏°:</span> <span>${totalVal} ‡∏ö.</span></div>
                                    </div>
                                    <button onclick="showDetail(${sale.id})" class="w-full bg-blue-600 text-white py-1 rounded shadow-sm hover:bg-blue-700 transition mt-1">‡∏î‡∏π‡∏ö‡∏¥‡∏•</button>
                                </div>`;
                        }
                        const popupHtml = `<div class="font-sans min-w-[200px] overflow-hidden rounded-lg shadow-none">${popupHeader}${popupBody}</div>`;
                        const layer = L.geoJSON(geo, {style:{color:col, weight:weight, fillOpacity:op}}).bindPopup(popupHtml).addTo(fieldLayer);
                        layersMap[f.id] = layer;
                    } catch(e){}
                }
            });

            document.getElementById('risk-count').innerText = globalRiskFields.length;
            renderTables(); // Update Table View
            document.getElementById('lastUpdate').innerText = new Date().toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'});

        } catch(e) { console.error("Error:", e); }
    }

    // === Render Tables (Switchable) ===
    function renderTables() {
        const dTable = document.getElementById('desktopTableBody');
        const dHead = document.getElementById('table-head');
        const mList = document.getElementById('mobileListBody');
        dTable.innerHTML = ''; mList.innerHTML = '';

        if (currentTableMode === 'sales') {
            // --- SALES MODE ---
            dHead.innerHTML = `<tr><th class="py-2 px-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="py-2 px-3">‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</th><th class="py-2 px-3 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤</th><th class="py-2 px-3 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr>`;
            
            const sorted = globalSales.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at)).slice(0,30);
            if(sorted.length===0) { dTable.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; return; }

            sorted.forEach(s => {
                const date = new Date(s.created_at).toLocaleDateString('th-TH', {day:'numeric', month:'short'});
                const price = parseFloat(s.price_per_ton).toLocaleString();
                let st = { txt:'‡∏£‡∏≠‡∏Ç‡∏≤‡∏¢', col:'text-orange-500', bg:'bg-orange-50' };
                if(s.status==='SOLD') st = { txt:'‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', col:'text-green-600', bg:'bg-green-50' };
                else if(s.status==='REQUESTED') st = { txt:'‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', col:'text-yellow-600', bg:'bg-yellow-50' };

                dTable.innerHTML += `<tr class="hover:bg-gray-50 border-b cursor-pointer" onclick="focusField(${s.rice_field})"><td class="py-2 px-3 text-gray-500">${date}</td><td class="py-2 px-3 truncate max-w-[100px]">${s.farmer_name}</td><td class="py-2 px-3 text-right font-mono">${price}</td><td class="py-2 px-3 text-center"><span class="${st.col} font-bold text-[10px]">${st.txt}</span></td></tr>`;
                
                mList.innerHTML += `<div class="bg-white border rounded-xl p-3 shadow-sm mb-2" onclick="showDetail(${s.id})"><div class="flex justify-between mb-1"><span class="text-[10px] text-gray-400">${date}</span><span class="${st.bg} ${st.col} px-2 rounded text-[10px] font-bold">${st.txt}</span></div><div class="flex justify-between"><b>${s.farmer_name}</b><b>${price} ‡∏ö.</b></div></div>`;
            });

        } else {
            // --- RISK MODE ---
            dHead.innerHTML = `<tr><th class="py-2 px-3">‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤</th><th class="py-2 px-3 text-center">‡∏Ñ‡πà‡∏≤ NDVI</th><th class="py-2 px-3 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="py-2 px-3 text-center">‡∏û‡∏¥‡∏Å‡∏±‡∏î</th></tr>`;
            
            if(globalRiskFields.length===0) { dTable.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-green-500"><i class="fa-solid fa-check-circle"></i> ‡∏õ‡∏Å‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</td></tr>`; return; }

            globalRiskFields.forEach(f => {
                dTable.innerHTML += `<tr class="hover:bg-red-50 border-b cursor-pointer" onclick="focusField(${f.id})"><td class="py-2 px-3 font-bold text-gray-700">${f.name}</td><td class="py-2 px-3 text-center font-mono text-red-600 font-bold">${f.ndvi.toFixed(2)}</td><td class="py-2 px-3 text-center"><span class="bg-red-100 text-red-600 px-2 py-0.5 rounded text-[10px]">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</span></td><td class="py-2 px-3 text-center text-blue-500"><i class="fa-solid fa-map-location-dot"></i></td></tr>`;
                
                mList.innerHTML += `<div class="bg-white border border-red-200 rounded-xl p-3 shadow-sm mb-2 relative overflow-hidden" onclick="focusField(${f.id})"><div class="absolute left-0 top-0 h-full w-1 bg-red-500"></div><div class="flex justify-between items-center"><div><h4 class="font-bold text-gray-800">${f.name}</h4><p class="text-xs text-red-500">NDVI: ${f.ndvi.toFixed(2)}</p></div><button class="bg-red-50 text-red-600 px-3 py-1 rounded text-xs">‡∏î‡∏π‡∏û‡∏¥‡∏Å‡∏±‡∏î</button></div></div>`;
            });
        }
    }

    // Modal
    window.showDetail = function(saleId) {
        const s = globalSales.find(item => item.id === saleId);
        if(!s) return;
        Swal.fire({
            html: `<div class="text-left font-sans"><h3 class="text-lg font-bold text-center mb-4 text-gray-800">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h3><div class="bg-gray-50 p-3 rounded-lg text-sm space-y-2 border border-gray-100"><div class="flex justify-between"><span>‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢:</span> <b>${s.farmer_name}</b></div><div class="flex justify-between"><span>‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠:</span> <b class="text-blue-600">${s.buyer_name||'-'}</b></div><hr class="border-dashed"><div class="flex justify-between"><span>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</span> <b>${s.variety_display}</b></div><div class="flex justify-between"><span>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì:</span> <b>${s.quantity_ton} ‡∏ï‡∏±‡∏ô</b></div><div class="flex justify-between"><span>‡∏£‡∏≤‡∏Ñ‡∏≤:</span> <b>${parseFloat(s.price_per_ton).toLocaleString()} ‡∏ö.</b></div><div class="border-t pt-2 mt-2 flex justify-between text-green-600 font-bold text-lg"><span>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</span> <span>${(s.quantity_ton*s.price_per_ton).toLocaleString()} ‡∏ö.</span></div></div></div>`,
            showCancelButton: true, confirmButtonText: 'üìç ‡∏î‡∏π‡∏û‡∏¥‡∏Å‡∏±‡∏î', confirmButtonColor: '#3b82f6', cancelButtonText: '‡∏õ‡∏¥‡∏î'
        }).then((r) => { if(r.isConfirmed) focusField(s.rice_field); });
    }

    window.focusField = function(id) {
        if(window.innerWidth < 1024) switchTab('map');
        const layer = layersMap[id];
        if(layer) {
            map.invalidateSize();
            setTimeout(() => { map.flyToBounds(layer.getBounds(), {padding:[50,50], maxZoom:16, duration:1.5}); setTimeout(()=>layer.openPopup(), 1500); }, 100);
        } else { Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î', '', 'info'); }
    }

    window.exportCSV = function() {
        let csv = "\uFEFF‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£,‡∏£‡∏≤‡∏Ñ‡∏≤,‡∏£‡∏ß‡∏°,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞\n";
        globalSales.forEach(s => { csv += `"${s.created_at}","${s.farmer_name}",${s.price_per_ton},${s.quantity_ton*s.price_per_ton},${s.status}\n`; });
        const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], {type:'text/csv;charset=utf-8;'}));
        link.download = `report.csv`; link.click();
    }

    window.forceUpdate = function() { Swal.fire({title:'‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', didOpen:()=>{Swal.showLoading()}}); updateData().then(()=>Swal.close()); }
    updateData(); setInterval(updateData, 60000);
</script>
<style>
    .leaflet-popup-content-wrapper { padding: 0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .leaflet-popup-content { margin: 0; width: 220px !important; }
    .leaflet-container a.leaflet-popup-close-button { color: #fff; top: 4px; right: 4px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
</style>
{% endblock %}