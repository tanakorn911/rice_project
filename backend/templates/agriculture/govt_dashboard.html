{% extends 'base.html' %}

{% block content %}
<div class="space-y-6 pb-10">
    <div class="flex flex-col md:flex-row justify-between items-center bg-white p-5 rounded-xl shadow-sm border border-gray-100">
        <div>
            <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fa-solid fa-building-columns text-blue-600"></i> ศูนย์ปฏิบัติการข้อมูลข้าว (War Room)
            </h1>
            <p class="text-sm text-gray-500 mt-1">ติดตามสถานการณ์เศรษฐกิจและการซื้อขายข้าว จ.พะเยา</p>
        </div>
        <div class="flex items-center gap-3">
            <span class="text-xs text-gray-400 hidden sm:block">ข้อมูลล่าสุด: <span id="lastUpdate" class="font-mono text-gray-800 font-bold">-</span></span>
            <button onclick="updateData()" class="bg-blue-50 text-blue-600 hover:bg-blue-100 w-10 h-10 rounded-full flex items-center justify-center shadow-sm transition"><i class="fa-solid fa-rotate"></i></button>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-5">
        <div class="bg-gradient-to-r from-emerald-500 to-teal-500 rounded-xl p-5 text-white shadow-lg relative overflow-hidden group">
            <p class="text-emerald-100 text-xs uppercase font-bold tracking-wider">มูลค่าการซื้อขายจริง (Sold)</p>
            <h3 class="text-3xl font-bold mt-2"><span id="stat-sold-value">0</span> <span class="text-base font-normal">บาท</span></h3>
            <i class="fa-solid fa-sack-dollar absolute -bottom-4 -right-4 text-7xl text-white opacity-20 group-hover:scale-110 transition-transform"></i>
        </div>
        <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100 relative overflow-hidden group hover:border-orange-300 transition-colors">
            <p class="text-gray-500 text-xs uppercase font-bold tracking-wider">มูลค่ารอการขาย (Pending)</p>
            <h3 class="text-2xl font-bold text-orange-500 mt-2"><span id="stat-pending-value">0</span> <span class="text-sm text-gray-400">บาท</span></h3>
            <div class="absolute top-4 right-4 bg-orange-50 p-2 rounded-lg text-orange-500"><i class="fa-solid fa-clock"></i></div>
        </div>
        <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100 relative overflow-hidden group hover:border-blue-300 transition-colors">
            <p class="text-gray-500 text-xs uppercase font-bold tracking-wider">ปริมาณผลผลิตรวม</p>
            <h3 class="text-2xl font-bold text-blue-600 mt-2"><span id="stat-yield">0</span> <span class="text-sm text-gray-400">ตัน</span></h3>
            <div class="absolute top-4 right-4 bg-blue-50 p-2 rounded-lg text-blue-500"><i class="fa-solid fa-wheat-awn"></i></div>
        </div>
        <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100 relative overflow-hidden group hover:border-purple-300 transition-colors">
            <p class="text-gray-500 text-xs uppercase font-bold tracking-wider">พื้นที่เพาะปลูก</p>
            <h3 class="text-2xl font-bold text-gray-800 mt-2"><span id="stat-area">0</span> <span class="text-sm text-gray-400">ไร่</span></h3>
            <div class="absolute top-4 right-4 bg-purple-50 p-2 rounded-lg text-purple-500"><i class="fa-solid fa-map"></i></div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-auto lg:h-[420px]">
        <div class="lg:col-span-2 bg-white p-1 rounded-xl shadow-sm border border-gray-100 relative h-[400px] lg:h-full">
            <div id="map" class="w-full h-full rounded-lg bg-gray-100"></div>
            <div class="absolute top-3 left-14 bg-white/90 backdrop-blur px-3 py-2 rounded-lg shadow-sm text-xs z-[400]">
                <div class="flex items-center gap-2 mb-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> ซื้อขายแล้ว</div>
                <div class="flex items-center gap-2 mb-1"><span class="w-2 h-2 rounded-full bg-orange-500"></span> รอขาย</div>
                <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-400 opacity-50"></span> แปลงนาทั่วไป</div>
            </div>
        </div>

        <div class="lg:col-span-1 flex flex-col gap-4 h-full">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex-1 flex flex-col">
                <h4 class="text-xs font-bold text-gray-500 uppercase mb-2"><i class="fa-solid fa-chart-bar text-blue-500 mr-1"></i> ปริมาณแยกตามพันธุ์ข้าว (ตัน)</h4>
                <div class="relative flex-grow w-full h-full">
                    <canvas id="varietyChart"></canvas>
                </div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex-1 flex flex-col">
                <h4 class="text-xs font-bold text-gray-500 uppercase mb-2"><i class="fa-solid fa-arrow-trend-up text-green-500 mr-1"></i> แนวโน้มราคาเฉลี่ย (บาท/ตัน)</h4>
                <div class="relative flex-grow w-full h-full">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
            <h3 class="font-bold text-gray-800 text-sm flex items-center gap-2">
                <i class="fa-solid fa-table-list text-gray-500"></i> บันทึกการซื้อขาย (Transaction Log)
            </h3>
            <button onclick="exportCSV()" class="text-xs bg-white border hover:bg-gray-50 text-gray-600 px-3 py-1.5 rounded shadow-sm font-medium"><i class="fa-solid fa-download"></i> CSV</button>
        </div>
        <div class="overflow-x-auto custom-scrollbar">
            <table class="w-full text-sm text-left whitespace-nowrap">
                <thead class="bg-white text-gray-500 border-b text-xs uppercase tracking-wider">
                    <tr>
                        <th class="py-3 px-6">วันที่</th>
                        <th class="py-3 px-6">เกษตรกร</th>
                        <th class="py-3 px-6">พันธุ์ข้าว</th>
                        <th class="py-3 px-6 text-right">ปริมาณ (ตัน)</th>
                        <th class="py-3 px-6 text-right">ราคา/ตัน</th>
                        <th class="py-3 px-6 text-right">ยอดรวม</th>
                        <th class="py-3 px-6 text-center">สถานะ</th>
                        <th class="py-3 px-6 text-center">ผู้รับซื้อ (Miller)</th>
                    </tr>
                </thead>
                <tbody id="marketTableBody" class="divide-y divide-gray-50 text-gray-700">
                    <tr><td colspan="8" class="text-center py-8 text-gray-400">กำลังโหลด...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="buyerModal" class="fixed inset-0 z-[999] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 relative transform transition-all scale-100">
        <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
        <div class="text-center">
            <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-4">
                <i class="fa-solid fa-industry"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-1" id="modal-buyer-name">-</h3>
            <span class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-xs font-bold">โรงสี / ผู้รับซื้อ</span>
            
            <div class="mt-6 space-y-3 text-left bg-gray-50 p-4 rounded-xl">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center text-gray-500 shadow-sm"><i class="fa-solid fa-phone"></i></div>
                    <div>
                        <p class="text-xs text-gray-400">เบอร์โทรศัพท์</p>
                        <p class="font-bold text-gray-700" id="modal-buyer-phone">-</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center text-gray-500 shadow-sm"><i class="fa-solid fa-clock"></i></div>
                    <div>
                        <p class="text-xs text-gray-400">เวลาที่ทำรายการ</p>
                        <p class="font-bold text-gray-700" id="modal-sold-at">-</p>
                    </div>
                </div>
            </div>
            <button onclick="closeModal()" class="mt-5 w-full bg-gray-800 hover:bg-gray-900 text-white py-2 rounded-xl font-bold transition">ปิดหน้าต่าง</button>
        </div>
    </div>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f8fafc; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // --- 1. Init Map ---
    const map = L.map('map', { center: [19.1667, 99.9000], zoom: 11, zoomControl: false });
    L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3']}).addTo(map);
    L.control.zoom({ position: 'bottomright' }).addTo(map);
    const fieldLayer = L.featureGroup().addTo(map);

    // --- 2. Init Charts (New Design) ---
    const vCtx = document.getElementById('varietyChart').getContext('2d');
    const pCtx = document.getElementById('priceChart').getContext('2d');

    const vChart = new Chart(vCtx, {
        type: 'bar', // เปลี่ยนเป็น Bar Chart แนวนอน
        data: { labels: [], datasets: [{ label: 'ปริมาณ (ตัน)', data: [], backgroundColor: '#3b82f6', borderRadius: 4 }] },
        options: {
            indexAxis: 'y', // แนวนอน
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { grid: { display: false } }, y: { grid: { display: false } } }
        }
    });

    const pChart = new Chart(pCtx, {
        type: 'line', // เปลี่ยนเป็น Line Chart
        data: { labels: [], datasets: [{ label: 'ราคาเฉลี่ย', data: [], borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.4 }] },
        options: {
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: false }, x: { grid: { display: false } } }
        }
    });

    // --- 3. Data Logic ---
    let globalSales = [];

    async function updateData() {
        try {
            const [statsRes, fieldsRes, salesRes] = await Promise.all([
                fetch('/api/stats/'), fetch('/api/rice-fields/'), fetch('/api/sales/')
            ]);
            const stats = await statsRes.json();
            const fields = await fieldsRes.json();
            const sales = await salesRes.json();
            globalSales = sales;

            // 3.1 Calculate Stats
            let soldVal = 0, pendingVal = 0;
            const salesMap = {};
            const varietyData = {}; 
            const priceData = []; 

            sales.forEach(s => {
                const total = s.quantity_ton * s.price_per_ton;
                // เก็บรายการล่าสุดสำหรับ Map
                if (!salesMap[s.rice_field] || new Date(salesMap[s.rice_field].created_at) < new Date(s.created_at)) salesMap[s.rice_field] = s;
                
                if (s.status === 'CLOSED') soldVal += total; else pendingVal += total;

                // Data for Bar Chart (Aggregated Variety)
                if (!varietyData[s.variety_display]) varietyData[s.variety_display] = 0;
                varietyData[s.variety_display] += s.quantity_ton;

                // Data for Line Chart (Simplified: just push all points)
                priceData.push({ date: new Date(s.created_at), price: s.price_per_ton });
            });

            animateValue("stat-sold-value", soldVal);
            animateValue("stat-pending-value", pendingVal);
            animateValue("stat-yield", stats.total_yield);
            animateValue("stat-area", stats.total_area);

            // 3.2 Update Charts
            // Bar Chart
            vChart.data.labels = Object.keys(varietyData);
            vChart.data.datasets[0].data = Object.values(varietyData);
            vChart.update();

            // Line Chart (Sort by date)
            priceData.sort((a,b) => a.date - b.date);
            // Limit to last 10 points for cleanliness
            const limitedPriceData = priceData.slice(-10);
            pChart.data.labels = limitedPriceData.map(d => d.date.toLocaleDateString('th-TH', {day:'numeric', month:'short'}));
            pChart.data.datasets[0].data = limitedPriceData.map(d => d.price);
            pChart.update();

            // 3.3 Update Table
            const tableBody = document.getElementById('marketTableBody');
            if (sales.length === 0) tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-10 text-gray-400">ไม่มีข้อมูล</td></tr>`;
            else {
                tableBody.innerHTML = '';
                sales.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
                
                sales.forEach(s => {
                    const date = new Date(s.created_at).toLocaleDateString('th-TH', {day:'2-digit', month:'2-digit', year:'2-digit'});
                    const isSold = s.status === 'CLOSED';
                    
                    // ปุ่มดูข้อมูลผู้ซื้อ (เฉพาะรายการที่ขายแล้ว)
                    let buyerCell = '<span class="text-gray-300">-</span>';
                    if (isSold && s.buyer_name) {
                        // ส่งข้อมูลใส่ฟังก์ชัน openBuyerModal
                        buyerCell = `<button onclick="openBuyerModal('${s.buyer_name}', '${s.buyer_phone || 'ไม่ระบุ'}', '${s.sold_at}')" class="text-xs bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-1 rounded-full font-bold transition flex items-center justify-center mx-auto gap-1"><i class="fa-solid fa-user-tag"></i> ${s.buyer_name}</button>`;
                    } else if (isSold) {
                        buyerCell = '<span class="text-xs text-gray-400">ไม่ระบุ</span>';
                    }

                    const statusBadge = isSold 
                        ? `<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium bg-green-100 text-green-800">ขายแล้ว</span>`
                        : `<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium bg-orange-100 text-orange-800">รอขาย</span>`;

                    tableBody.innerHTML += `
                        <tr class="hover:bg-gray-50 border-b border-gray-50 transition">
                            <td class="py-3 px-6 text-gray-500 text-xs">${date}</td>
                            <td class="py-3 px-6 font-medium text-gray-800">${s.farmer_name}</td>
                            <td class="py-3 px-6 text-gray-600 text-xs">${s.variety_display}</td>
                            <td class="py-3 px-6 text-right font-medium">${s.quantity_ton}</td>
                            <td class="py-3 px-6 text-right text-gray-500 text-xs">${s.price_per_ton.toLocaleString()}</td>
                            <td class="py-3 px-6 text-right font-bold ${isSold ? 'text-green-600' : 'text-gray-400'}">${(s.quantity_ton * s.price_per_ton).toLocaleString()}</td>
                            <td class="py-3 px-6 text-center">${statusBadge}</td>
                            <td class="py-3 px-6 text-center">${buyerCell}</td>
                        </tr>
                    `;
                });
            }

            // 3.4 Update Map
            fieldLayer.clearLayers();
            fields.forEach(f => {
                if(f.boundary) {
                    try {
                        const geoJson = typeof f.boundary === 'string' ? JSON.parse(f.boundary) : f.boundary;
                        const sale = salesMap[f.id];
                        let color = '#94a3b8';
                        if (sale) color = (sale.status === 'CLOSED' ? '#22c55e' : '#f97316');
                        L.geoJSON(geoJson, { style: { color: color, weight: sale?2:1, fillOpacity: sale?0.6:0.3 } })
                         .bindPopup(`<b>${f.name}</b><br>${f.area_rai} ไร่`).addTo(fieldLayer);
                    } catch(e){}
                }
            });
            document.getElementById('lastUpdate').innerText = new Date().toLocaleTimeString('th-TH');

        } catch(e) { console.error(e); }
    }

    // --- 4. Modal Functions ---
    window.openBuyerModal = function(name, phone, soldTime) {
        document.getElementById('modal-buyer-name').innerText = name;
        document.getElementById('modal-buyer-phone').innerText = phone;
        
        const dateStr = soldTime ? new Date(soldTime).toLocaleString('th-TH') : '-';
        document.getElementById('modal-sold-at').innerText = dateStr;
        
        const modal = document.getElementById('buyerModal');
        modal.classList.remove('hidden');
        setTimeout(() => { modal.firstElementChild.classList.remove('scale-95', 'opacity-0'); }, 10);
    }

    window.closeModal = function() {
        const modal = document.getElementById('buyerModal');
        modal.firstElementChild.classList.add('scale-95', 'opacity-0');
        setTimeout(() => { modal.classList.add('hidden'); }, 200);
    }

    // Animation Utils
    function animateValue(id, end) {
        const obj = document.getElementById(id);
        const start = parseFloat(obj.innerText.replace(/,/g, '')) || 0;
        if(start === end) return;
        let current = start; const step = (end - start) / 20;
        const timer = setInterval(() => {
            current += step;
            if ((step > 0 && current >= end) || (step < 0 && current <= end)) { current = end; clearInterval(timer); }
            obj.innerText = current.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
        }, 30);
    }

    // Export CSV
    window.exportCSV = function() {
        if(!globalSales.length) return Swal.fire('ไม่มีข้อมูล');
        let csv = "\uFEFFวันที่,เกษตรกร,แปลง,พันธุ์,ปริมาณ,ราคา,ยอดรวม,สถานะ,ผู้รับซื้อ\n";
        globalSales.forEach(s => {
            const date = new Date(s.created_at).toLocaleDateString('th-TH');
            csv += `"${date}","${s.farmer_name}","${s.field_name}","${s.variety_display}",${s.quantity_ton},${s.price_per_ton},${s.quantity_ton*s.price_per_ton},"${s.status}","${s.buyer_name || '-'}"\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `rice_report_${new Date().toISOString().slice(0,10)}.csv`;
        link.click();
    }

    updateData();
    setInterval(updateData, 15000);
</script>
{% endblock %}