{% extends 'base.html' %}

{% block content %}
<div class="space-y-6 pb-10">
    <div class="flex flex-col md:flex-row justify-between items-center bg-white p-5 rounded-xl shadow-sm border border-gray-100">
        <div>
            <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fa-solid fa-building-columns text-blue-600"></i> ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≤‡∏ß (War Room)
            </h1>
            <p class="text-sm text-gray-500 mt-1">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏Ç‡πâ‡∏≤‡∏ß ‡∏à.‡∏û‡∏∞‡πÄ‡∏¢‡∏≤</p>
        </div>
        <div class="flex items-center gap-3">
            <span class="text-xs text-gray-400 hidden sm:block">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="lastUpdate" class="font-mono text-gray-800 font-bold">-</span></span>
            <button onclick="updateData()" class="bg-blue-50 text-blue-600 hover:bg-blue-100 w-10 h-10 rounded-full flex items-center justify-center shadow-sm transition"><i class="fa-solid fa-rotate"></i></button>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-5">
        <div class="bg-gradient-to-r from-emerald-500 to-teal-600 rounded-xl p-5 text-white shadow-lg relative overflow-hidden group">
            <p class="text-emerald-100 text-xs uppercase font-bold tracking-wider">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á (Sold)</p>
            <h3 class="text-3xl font-bold mt-2"><span id="stat-sold-value">0.00</span> <span class="text-base font-normal">‡∏ö‡∏≤‡∏ó</span></h3>
            <i class="fa-solid fa-hand-holding-dollar absolute -bottom-4 -right-4 text-7xl text-white opacity-20 group-hover:scale-110 transition-transform"></i>
        </div>
        
        <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100 relative overflow-hidden group hover:border-orange-300 transition-colors">
            <p class="text-gray-500 text-xs uppercase font-bold tracking-wider">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (Pending)</p>
            <h3 class="text-2xl font-bold text-orange-500 mt-2"><span id="stat-pending-value">0.00</span> <span class="text-sm text-gray-400">‡∏ö‡∏≤‡∏ó</span></h3>
            <div class="absolute top-4 right-4 bg-orange-50 p-2 rounded-lg text-orange-500"><i class="fa-solid fa-clock"></i></div>
        </div>
        
        <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100 relative overflow-hidden group hover:border-blue-300 transition-colors">
            <p class="text-gray-500 text-xs uppercase font-bold tracking-wider">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏£‡∏ß‡∏°</p>
            <h3 class="text-2xl font-bold text-blue-600 mt-2"><span id="stat-yield">0.00</span> <span class="text-sm text-gray-400">‡∏ï‡∏±‡∏ô</span></h3>
            <div class="absolute top-4 right-4 bg-blue-50 p-2 rounded-lg text-blue-500"><i class="fa-solid fa-wheat-awn"></i></div>
        </div>
        
        <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100 relative overflow-hidden group hover:border-purple-300 transition-colors">
            <p class="text-gray-500 text-xs uppercase font-bold tracking-wider">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏≤‡∏∞‡∏õ‡∏•‡∏π‡∏Å</p>
            <h3 class="text-2xl font-bold text-gray-800 mt-2"><span id="stat-area">0.00</span> <span class="text-sm text-gray-400">‡πÑ‡∏£‡πà</span></h3>
            <div class="absolute top-4 right-4 bg-purple-50 p-2 rounded-lg text-purple-500"><i class="fa-solid fa-map"></i></div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
        <div class="lg:col-span-2 bg-white p-1 rounded-xl shadow-sm border border-gray-100 relative h-[260px] sm:h-[400px] lg:h-[530px] group">
            <div id="map" class="w-full h-full rounded-lg bg-gray-100 z-0"></div>
            <div class="absolute top-3 left-14 bg-white/95 backdrop-blur px-4 py-2 rounded-lg shadow-md text-xs z-[400] border border-gray-200 hidden sm:block">
                <h4 class="font-bold text-gray-700 mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤</h4>
                <div class="flex items-center gap-2 mb-1"><span class="w-3 h-3 rounded-full bg-green-500 border border-green-600"></span> ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
                <div class="flex items-center gap-2 mb-1"><span class="w-3 h-3 rounded-full bg-yellow-400 border border-yellow-500"></span> ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏°‡∏µ‡∏Ñ‡∏ô‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠)</div>
                <div class="flex items-center gap-2 mb-1"><span class="w-3 h-3 rounded-full bg-orange-500 border border-orange-600"></span> ‡∏£‡∏≠‡∏Ç‡∏≤‡∏¢</div>
                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-slate-300 border border-slate-400"></span> ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</div>
            </div>
        </div>

        <div class="lg:col-span-1 flex flex-col gap-4 h-full">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                <h4 class="text-xs font-bold text-gray-500 uppercase mb-2 flex items-center gap-2">
                    <i class="fa-solid fa-chart-pie text-blue-500"></i> ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Ç‡πâ‡∏≤‡∏ß (‡∏ï‡∏±‡∏ô)
                </h4>
                <div class="relative w-full h-[180px] sm:h-[200px]">
                    <canvas id="varietyChart"></canvas>
                </div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                <h4 class="text-xs font-bold text-gray-500 uppercase mb-2 flex items-center gap-2">
                    <i class="fa-solid fa-arrow-trend-up text-emerald-500"></i> ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ö‡∏≤‡∏ó/‡∏ï‡∏±‡∏ô)
                </h4>
                <div class="relative w-full h-[180px] sm:h-[200px]">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
            <h3 class="font-bold text-gray-800 text-sm flex items-center gap-2">
                <i class="fa-solid fa-table-list text-gray-500"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î üìç)
            </h3>
            <button onclick="exportCSV()" class="text-xs bg-white border hover:bg-gray-50 text-gray-600 px-3 py-1.5 rounded shadow-sm font-medium transition">
                <i class="fa-solid fa-download"></i> CSV
            </button>
        </div>
        <div class="overflow-x-auto custom-scrollbar max-h-[320px] sm:max-h-[400px] lg:max-h-none">
            <table class="w-full text-sm text-left whitespace-nowrap">
                <thead class="bg-white text-gray-500 border-b text-xs uppercase tracking-wider sticky top-0 z-10 shadow-sm">
                    <tr>
                        <th class="py-3 px-6">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                        <th class="py-3 px-6">‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</th>
                        <th class="py-3 px-6">‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Ç‡πâ‡∏≤‡∏ß</th>
                        <th class="py-3 px-6 text-right">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì (‡∏ï‡∏±‡∏ô)</th>
                        <th class="py-3 px-6 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ï‡∏±‡∏ô</th>
                        <th class="py-3 px-6 text-right">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
                        <th class="py-3 px-6 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        <th class="py-3 px-6 text-center">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</th>
                    </tr>
                </thead>
                <tbody id="marketTableBody" class="divide-y divide-gray-50 text-gray-700">
                    <tr><td colspan="8" class="text-center py-8 text-gray-400"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f8fafc; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    #marketTableBody tr { cursor: pointer; transition: background-color 0.2s; }
    
    /* Popup Style Override */
    .leaflet-popup-content-wrapper { border-radius: 12px; overflow: hidden; padding: 0; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    .leaflet-popup-content { margin: 0; width: 280px !important; }
    .leaflet-container a.leaflet-popup-close-button { color: #fff; top: 8px; right: 8px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }

    .leaflet-popup-content {
    max-height: 60vh;
    overflow-y: auto;
    }

    @media (max-width: 640px) {
        .leaflet-popup-content {
            width: 90vw !important;
            max-height: 65vh;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // --- 1. Init Map ---
    const map = L.map('map', { center: [19.1667, 99.9000], zoom: 13, zoomControl: false });
    L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3']}).addTo(map);
    L.control.zoom({ position: 'bottomright' }).addTo(map);
    const fieldLayer = L.featureGroup().addTo(map);

    let layersMap = {}; 

    window.addEventListener('resize', () => { setTimeout(() => map.invalidateSize(), 300); });

    // --- 2. Init Charts ---
    const vCtx = document.getElementById('varietyChart').getContext('2d');
    const pCtx = document.getElementById('priceChart').getContext('2d');

    const vChart = new Chart(vCtx, {
        type: 'doughnut', 
        data: { labels: [], datasets: [{ data: [], backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'], borderWidth: 0 }] },
        options: { maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } }, cutout: '70%' }
    });

    const pChart = new Chart(pCtx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: '‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢', data: [], borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.4, pointRadius: 2 }] },
        options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: false, grid: { borderDash: [2, 2] } }, x: { grid: { display: false }, ticks: { font: { size: 10 } } } } }
    });

    // --- 3. Data Logic ---
    let globalSales = [];

    async function updateData() {
        try {
            const [statsRes, fieldsRes, salesRes] = await Promise.all([
                fetch('/api/stats/'), fetch('/api/rice-fields/'), fetch('/api/sales/')
            ]);
            const stats = await statsRes.json();
            const fields = await fieldsRes.json();
            const sales = await salesRes.json();
            globalSales = sales;

            // 3.1 Calculate Stats & Maps
            let soldVal = 0, pendingVal = 0;
            const salesMap = {}; 
            const varietyData = {}; 
            const priceData = []; 

            sales.forEach(s => {
                const total = s.quantity_ton * s.price_per_ton;
                
                // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á
                if (!salesMap[s.rice_field] || new Date(salesMap[s.rice_field].created_at) < new Date(s.created_at)) {
                    salesMap[s.rice_field] = s;
                }
                
                if (s.status === 'SOLD') soldVal += total;
                else if (s.status === 'OPEN' || s.status === 'REQUESTED') pendingVal += total;

                if (!varietyData[s.variety_display]) varietyData[s.variety_display] = 0;
                varietyData[s.variety_display] += s.quantity_ton;

                priceData.push({ date: new Date(s.created_at), price: s.price_per_ton });
            });

            animateValue("stat-sold-value", soldVal, 2);       // 0 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡πÄ‡∏á‡∏¥‡∏ô‡∏ö‡∏≤‡∏ó)
            animateValue("stat-pending-value", pendingVal, 2); // 0 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡πÄ‡∏á‡∏¥‡∏ô‡∏ö‡∏≤‡∏ó)
            animateValue("stat-yield", stats.total_yield, 2);  // ‚úÖ 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï)
            animateValue("stat-area", stats.total_area, 2);

            // 3.2 Update Charts
            vChart.data.labels = Object.keys(varietyData);
            vChart.data.datasets[0].data = Object.values(varietyData);
            vChart.update();

            priceData.sort((a,b) => a.date - b.date);
            const limitedPriceData = priceData.slice(-10); 
            pChart.data.labels = limitedPriceData.map(d => d.date.toLocaleDateString('th-TH', {day:'numeric', month:'short'}));
            pChart.data.datasets[0].data = limitedPriceData.map(d => d.price);
            pChart.update();

            // 3.3 Update Table
            const tableBody = document.getElementById('marketTableBody');
            if (sales.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-10 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</td></tr>`;
            } else {
                tableBody.innerHTML = '';
                sales.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
                
                sales.forEach(s => {
                    const date = new Date(s.created_at).toLocaleDateString('th-TH', {day:'2-digit', month:'2-digit', year:'2-digit'});
                    const total = (s.quantity_ton * s.price_per_ton).toLocaleString();
                    
                    let statusBadge = '';
                    let buyerText = '<span class="text-gray-300">-</span>';
                    let amountClass = 'text-gray-400';

                    if (s.status === 'SOLD') {
                        statusBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-800"><i class="fa-solid fa-check mr-1"></i> ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>`;
                        amountClass = 'text-green-600';
                        buyerText = `<span class="text-blue-600 font-bold text-xs"><i class="fa-solid fa-industry"></i> ${s.buyer_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>`;
                    } else if (s.status === 'REQUESTED') {
                        statusBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-yellow-100 text-yellow-800 animate-pulse"><i class="fa-solid fa-clock mr-1"></i> ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>`;
                        buyerText = `<span class="text-xs text-yellow-600">‡∏£‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</span>`;
                    } else {
                        statusBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium bg-orange-100 text-orange-800">‡∏£‡∏≠‡∏Ç‡∏≤‡∏¢</span>`;
                    }

                    tableBody.innerHTML += `
                        <tr class="hover:bg-blue-50 border-b border-gray-50 transition active:bg-blue-100" onclick="focusField(${s.rice_field})">
                            <td class="py-3 px-6 text-gray-500 text-xs">${date}</td>
                            <td class="py-3 px-6 font-medium text-gray-800 flex items-center gap-1"><i class="fa-solid fa-user-circle text-gray-400"></i> ${s.farmer_name}</td>
                            <td class="py-3 px-6 text-gray-600 text-xs">${s.variety_display}</td>
                            <td class="py-3 px-6 text-right font-medium">${s.quantity_ton}</td>
                            <td class="py-3 px-6 text-right text-gray-500 text-xs">${s.price_per_ton.toLocaleString()}</td>
                            <td class="py-3 px-6 text-right font-bold ${amountClass}">${total}</td>
                            <td class="py-3 px-6 text-center">${statusBadge}</td>
                            <td class="py-3 px-6 text-center">${buyerText}</td>
                        </tr>
                    `;
                });
            }

            // 3.4 Update Map & Detailed Popups
            fieldLayer.clearLayers();
            layersMap = {}; 
            fields.forEach(f => {
                if(f.boundary) {
                    try {
                        const geoJson = typeof f.boundary === 'string' ? JSON.parse(f.boundary) : f.boundary;
                        const sale = salesMap[f.id];
                        
                        let color = '#cbd5e1'; // ‡πÄ‡∏ó‡∏≤ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
                        let opacity = 0.3;
                        let weight = 1;
                        let popupContent = `
                            <div class="text-center p-3">
                                <b class="text-sm text-gray-800">${f.name}</b><br>
                                <span class="text-xs text-gray-500">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ${f.area_rai} ‡πÑ‡∏£‡πà</span>
                                <div class="mt-2 text-xs bg-gray-100 rounded px-2 py-1 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢</div>
                            </div>
                        `;

                        if (sale) {
                            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Popup ‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Full Detail)
                            const totalPrice = (sale.quantity_ton * sale.price_per_ton).toLocaleString();
                            const buyerInfo = sale.status === 'SOLD' 
                                ? `<div class="mt-2 pt-2 border-t border-gray-100">
                                     <p class="text-[10px] text-gray-400 uppercase">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠ (Buyer)</p>
                                     <p class="font-bold text-blue-600 text-xs"><i class="fa-solid fa-industry"></i> ${sale.buyer_name || '-'}</p>
                                     <p class="text-xs text-gray-500"><i class="fa-solid fa-phone text-[10px]"></i> ${sale.buyer_phone || '-'}</p>
                                   </div>` 
                                : '';

                            let statusColor = 'bg-orange-100 text-orange-700';
                            let statusText = '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢';
                            
                            if (sale.status === 'SOLD') {
                                color = '#22c55e'; opacity = 0.6; weight = 2;
                                statusColor = 'bg-green-500 text-white'; statusText = '‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß';
                            } else if (sale.status === 'REQUESTED') {
                                color = '#eab308'; opacity = 0.8; weight = 2;
                                statusColor = 'bg-yellow-400 text-yellow-900'; statusText = '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
                            } else {
                                color = '#f97316'; opacity = 0.5; weight = 2;
                            }

                            popupContent = `
                                <div class="font-sans">
                                    <div class="${statusColor} py-1.5 px-3 text-xs font-bold text-center uppercase tracking-wide">
                                        ${statusText}
                                    </div>
                                    <div class="p-4 space-y-2">
                                        <div>
                                            <h3 class="font-bold text-gray-800 text-sm flex items-center gap-1">
                                                <i class="fa-solid fa-location-dot text-red-500"></i> ${f.name}
                                            </h3>
                                            <p class="text-xs text-gray-500">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: <b>${f.area_rai}</b> ‡πÑ‡∏£‡πà</p>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-2 text-xs bg-gray-50 p-2 rounded-lg border border-gray-100">
                                            <div>
                                                <span class="text-gray-400">‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Ç‡πâ‡∏≤‡∏ß</span><br>
                                                <span class="font-semibold text-gray-700">${sale.variety_display}</span>
                                            </div>
                                            <div class="text-right">
                                                <span class="text-gray-400">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</span><br>
                                                <span class="font-semibold text-gray-700">${sale.quantity_ton} ‡∏ï‡∏±‡∏ô</span>
                                            </div>
                                            <div>
                                                <span class="text-gray-400">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ï‡∏±‡∏ô</span><br>
                                                <span class="font-semibold text-gray-700">${sale.price_per_ton.toLocaleString()}</span>
                                            </div>
                                            <div class="text-right">
                                                <span class="text-gray-400">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô</span><br>
                                                <span class="font-bold text-green-600">${totalPrice} ‡∏ö.</span>
                                            </div>
                                        </div>

                                        <div class="flex items-center gap-2 text-xs text-gray-600">
                                            <div class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center"><i class="fa-solid fa-user"></i></div>
                                            <div>
                                                <p class="font-bold text-gray-800">${sale.farmer_name}</p>
                                                <p class="text-[10px] text-gray-400">‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</p>
                                            </div>
                                        </div>

                                        ${buyerInfo}
                                    </div>
                                </div>
                            `;
                        }

                        const layer = L.geoJSON(geoJson, { style: { color: color, weight: weight, fillOpacity: opacity } })
                          .bindPopup(popupContent);
                        
                        layer.addTo(fieldLayer);
                        layersMap[f.id] = layer;
                    } catch(e){}
                }
            });
            document.getElementById('lastUpdate').innerText = new Date().toLocaleTimeString('th-TH');

        } catch(e) { console.error("Update Error:", e); }
    }

    // --- 4. Focus Map Function ---
    window.focusField = function(fieldId) {
        const layer = layersMap[fieldId];
        if (layer) {
            // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏´‡∏≤
            map.flyToBounds(layer.getBounds(), { padding: [50, 50], maxZoom: 17, duration: 1 });
            layer.openPopup();
            
            // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏õ‡∏´‡∏≤‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
            const mapEl = document.getElementById('map');
            mapEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Highlight
            const originalStyle = layer.options.style;
            layer.setStyle({ color: '#3b82f6', weight: 4, fillOpacity: 0.8 });
            setTimeout(() => { layer.setStyle(originalStyle); }, 2500);
        } else {
            Swal.fire({ title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î', text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß', icon: 'warning', timer: 2000, showConfirmButton: false });
        }
    }

    function animateValue(id, end, decimals = 0) { 
        const obj = document.getElementById(id);
        if(!obj) return;
        
        // ‡∏•‡∏ö comma ‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô float ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô error
        const start = parseFloat(obj.innerText.replace(/,/g, '')) || 0;
        if(start === end) return;
        
        let current = start; 
        const range = end - start;
        const step = range / 20;
        
        const timer = setInterval(() => {
            current += step;
            if ((step > 0 && current >= end) || (step < 0 && current <= end)) { 
                current = end; 
                clearInterval(timer); 
            }
            // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ decimals ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤
            obj.innerText = current.toLocaleString(undefined, {
                minimumFractionDigits: decimals, 
                maximumFractionDigits: decimals
            });
        }, 20);
    }

    window.exportCSV = function() {
        if(!globalSales.length) return Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '', 'info');
        let csv = "\uFEFF‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£,‡πÅ‡∏õ‡∏•‡∏á,‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå,‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì(‡∏ï‡∏±‡∏ô),‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ï‡∏±‡∏ô,‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞,‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠\n";
        globalSales.forEach(s => {
            const date = new Date(s.created_at).toLocaleDateString('th-TH');
            const statusText = s.status === 'SOLD' ? '‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : (s.status === 'REQUESTED' ? '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : '‡∏£‡∏≠‡∏Ç‡∏≤‡∏¢');
            const buyer = s.buyer_name || '-';
            csv += `"${date}","${s.farmer_name}","${s.field_name}","${s.variety_display}",${s.quantity_ton},${s.price_per_ton},${s.quantity_ton*s.price_per_ton},"${statusText}","${buyer}"\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `rice_report_${new Date().toISOString().slice(0,10)}.csv`;
        link.click();
    }

    function safeInvalidateMap() {
    setTimeout(() => {
        map.invalidateSize();
    }, 400);
}

    window.addEventListener('load', () => { setTimeout(() => { map.invalidateSize(); }, 300); });
    updateData();

    setInterval(updateData, 10000); 
</script>
{% endblock %}