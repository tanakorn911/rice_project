{% extends 'base.html' %}

{% block content %}
<div class="h-[calc(100vh-80px)] flex flex-col lg:grid lg:grid-cols-12 lg:gap-6 relative">
    
    <!-- Left Panel: Analytics Overview -->
    <div id="view-overview" class="flex-grow lg:col-span-5 flex flex-col gap-4 h-full overflow-hidden transition-all duration-300">
        
        <!-- Header Card (‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•) -->
        <div class="bg-gradient-to-r from-green-600 to-emerald-600 p-4 rounded-2xl shadow-lg text-white shrink-0">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-lg font-bold flex items-center gap-2"> 
                        <i class="fa-solid fa-building-columns"></i> 
                        ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≤‡∏ß
                    </h1>
                    <p class="text-[10px] opacity-90 mt-1">
                        <i class="fa-solid fa-map-marker-alt"></i> 
                        ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏û‡∏∞‡πÄ‡∏¢‡∏≤ - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï
                    </p>
                    <p class="text-[9px] opacity-75 mt-1 flex items-center gap-2">
                        <i class="fa-solid fa-clock animate-pulse"></i> 
                        ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: <span id="last-update" class="font-mono">-</span>
                    </p>
                </div>
                <div class="flex gap-2 flex-col sm:flex-row">
                    <!-- Filter -->
                    <select id="filter-variety" onchange="applyFilter()" 
                        class="bg-white/20 backdrop-blur border border-white/30 text-white text-[10px] rounded-lg px-2 py-1.5 focus:ring-2 focus:ring-white/50 outline-none">
                        <option value="all" class="text-gray-800">‡∏ó‡∏∏‡∏Å‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</option>
                        <option value="KDML105" class="text-gray-800">üçö ‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥ 105</option>
                        <option value="RD6" class="text-gray-800">üçô ‡∏Å‡∏Ç 6</option>
                        <option value="RD15" class="text-gray-800">üåæ ‡∏Å‡∏Ç 15</option>
                        <option value="PATHUM1" class="text-gray-800">üåø ‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ</option>
                    </select>
                    
                    <!-- Export Button (Desktop) -->
                    <button onclick="exportData()" 
                        class="hidden sm:flex bg-white/20 backdrop-blur text-white hover:bg-white/30 px-3 py-1.5 rounded-lg items-center justify-center gap-1 shadow-sm transition-all text-[10px] font-semibold"
                        aria-label="‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
                        <i class="fa-solid fa-download"></i>
                        <span class="hidden md:inline">Export</span>
                    </button>
                    
                    <!-- Refresh Button -->
                    <button onclick="forceUpdate()" id="btn-refresh"
                        class="bg-white/20 backdrop-blur text-white hover:bg-white/30 w-8 h-8 rounded-full flex items-center justify-center shadow-sm transition-all"
                        aria-label="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
                        <i class="fa-solid fa-rotate" id="refresh-icon"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Scrollable Content -->
        <div class="flex-grow overflow-y-auto custom-scrollbar pb-20 lg:pb-0 space-y-4 p-1">
            
            <!-- KPI Cards Grid (‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö) -->
            <div class="grid grid-cols-3 gap-2">
                <!-- Total Revenue KPI -->
                <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-2.5 rounded-xl shadow-sm hover:shadow-md transition-shadow text-white">
                    <div class="flex items-center justify-between mb-1">
                        <p class="text-[9px] uppercase font-bold opacity-90">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°</p>
                        <i class="fa-solid fa-coins text-xs opacity-80"></i>
                    </div>
                    <p class="text-lg font-bold" id="kpi-revenue">0</p>
                    <p class="text-[8px] opacity-75">‡∏•‡πâ‡∏≤‡∏ô‡∏ö‡∏≤‡∏ó</p>
                </div>

                <!-- Supply KPI -->
                <div class="bg-white p-2.5 rounded-xl border border-blue-100 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between mb-1">
                        <p class="text-[9px] text-gray-500 uppercase font-bold">‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏£‡∏ß‡∏°</p>
                        <i class="fa-solid fa-wheat-awn text-blue-500 text-xs"></i>
                    </div>
                    <p class="text-lg font-bold text-blue-600" id="kpi-supply">0</p>
                    <p class="text-[8px] text-gray-400">‡∏ï‡∏±‡∏ô</p>
                </div>

                <!-- Demand KPI -->
                <div class="bg-white p-2.5 rounded-xl border border-green-100 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between mb-1">
                        <p class="text-[9px] text-gray-500 uppercase font-bold">‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
                        <i class="fa-solid fa-check-circle text-green-500 text-xs"></i>
                    </div>
                    <p class="text-lg font-bold text-green-600" id="kpi-demand">0</p>
                    <p class="text-[8px] text-gray-400">‡∏ï‡∏±‡∏ô</p>
                </div>

                <!-- Pending Sales KPI -->
                <div class="bg-white p-2.5 rounded-xl border border-orange-100 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between mb-1">
                        <p class="text-[9px] text-gray-500 uppercase font-bold">‡∏£‡∏≠‡∏Ç‡∏≤‡∏¢</p>
                        <i class="fa-solid fa-clock text-orange-500 text-xs"></i>
                    </div>
                    <p class="text-lg font-bold text-orange-500" id="kpi-pending">0</p>
                    <p class="text-[8px] text-gray-400">‡∏ï‡∏±‡∏ô</p>
                </div>

                <!-- Farmers KPI -->
                <div class="bg-white p-2.5 rounded-xl border border-purple-100 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between mb-1">
                        <p class="text-[9px] text-gray-500 uppercase font-bold">‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</p>
                        <i class="fa-solid fa-users text-purple-500 text-xs"></i>
                    </div>
                    <p class="text-lg font-bold text-gray-700" id="kpi-farmers">0</p>
                    <p class="text-[8px] text-gray-400">‡∏£‡∏≤‡∏¢</p>
                </div>

                <!-- Area KPI -->
                <div class="bg-white p-2.5 rounded-xl border border-indigo-100 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between mb-1">
                        <p class="text-[9px] text-gray-500 uppercase font-bold">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</p>
                        <i class="fa-solid fa-map text-indigo-500 text-xs"></i>
                    </div>
                    <p class="text-lg font-bold text-gray-700" id="kpi-area">0</p>
                    <p class="text-[8px] text-gray-400">‡πÑ‡∏£‡πà</p>
                </div>
            </div>

            <!-- Sales Status Overview (‡πÉ‡∏´‡∏°‡πà) -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-xs font-bold text-gray-700 flex items-center gap-2">
                        <i class="fa-solid fa-chart-simple text-purple-500"></i> 
                        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
                    </h4>
                </div>
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div class="bg-green-50 p-3 rounded-lg border border-green-100">
                        <p class="text-2xl font-bold text-green-600" id="stat-sold">0</p>
                        <p class="text-[10px] text-gray-500 mt-1">‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
                    </div>
                    <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-100">
                        <p class="text-2xl font-bold text-yellow-600" id="stat-requested">0</p>
                        <p class="text-[10px] text-gray-500 mt-1">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
                    </div>
                    <div class="bg-orange-50 p-3 rounded-lg border border-orange-100">
                        <p class="text-2xl font-bold text-orange-600" id="stat-open">0</p>
                        <p class="text-[10px] text-gray-500 mt-1">‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢</p>
                    </div>
                </div>
            </div>

            <!-- Monthly Yield Chart (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å Balance Chart) -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-xs font-bold text-gray-700 flex items-center gap-2">
                        <i class="fa-solid fa-chart-column text-blue-500"></i> 
                        ‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                    </h4>
                    <span class="text-[9px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full font-semibold">
                        ‡∏õ‡∏µ {{ current_year }}
                    </span>
                </div>
                <div class="h-[180px] relative">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>

            <!-- Variety Distribution (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà Health Chart) -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-xs font-bold text-gray-700 flex items-center gap-2">
                        <i class="fa-solid fa-seedling text-green-500"></i> 
                        ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Ç‡πâ‡∏≤‡∏ß
                    </h4>
                    <button onclick="showVarietyInfo()" class="text-[9px] text-gray-400 hover:text-blue-600">
                        <i class="fa-solid fa-circle-info"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                    </button>
                </div>
                <div class="flex items-center gap-4">
                    <div class="h-[140px] w-[140px] relative flex-shrink-0">
                        <canvas id="varietyChart"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <div class="text-center">
                                <p class="text-xs text-gray-400">‡∏£‡∏ß‡∏°</p>
                                <p class="text-lg font-bold text-gray-700" id="total-yield">0</p>
                                <p class="text-[8px] text-gray-400">‡∏ï‡∏±‡∏ô</p>
                            </div>
                        </div>
                    </div>
                    <div id="variety-legend" class="flex-1 space-y-1.5 text-[10px]">
                        <!-- Legend will be generated by JS -->
                    </div>
                </div>
            </div>

            <!-- Price Trend Chart (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á) -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-xs font-bold text-gray-700 flex items-center gap-2">
                        <i class="fa-solid fa-arrow-trend-up text-emerald-500"></i> 
                        ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏•‡∏≤‡∏î
                    </h4>
                    <div class="text-right">
                        <p class="text-[9px] text-gray-400">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</p>
                        <p class="text-[11px] font-bold text-emerald-600" id="avg-price">0 ‡∏ö./‡∏ï‡∏±‡∏ô</p>
                    </div>
                </div>
                <div class="h-[150px] relative">
                    <canvas id="priceTrendChart"></canvas>
                </div>
                <div class="flex justify-between text-[8px] text-gray-400 mt-2">
                    <span><i class="fa-solid fa-arrow-up text-green-500"></i> ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: <span id="max-price">0</span> ‡∏ö.</span>
                    <span><i class="fa-solid fa-arrow-down text-red-500"></i> ‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î: <span id="min-price">0</span> ‡∏ö.</span>
                </div>
            </div>

            <!-- NDVI Health Analysis -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-xs font-bold text-gray-700 flex items-center gap-2">
                        <i class="fa-solid fa-heart-pulse text-red-500"></i> 
                        ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏û‡∏∑‡∏ä (NDVI)
                    </h4>
                    <button onclick="showNDVIInfo()" class="text-[9px] text-gray-400 hover:text-blue-600">
                        <i class="fa-solid fa-circle-info"></i> ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
                    </button>
                </div>
                <div class="space-y-2 text-[10px]">
                    <div class="flex justify-between items-center p-2 rounded bg-green-50 hover:bg-green-100 transition-colors">
                        <span class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-green-500"></span> 
                            <span class="font-medium">‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏î‡∏µ (> 0.5)</span>
                        </span>
                        <span class="font-bold text-green-700">
                            <span id="txt-healthy">0</span> ‡πÅ‡∏õ‡∏•‡∏á
                        </span>
                    </div>
                    <div class="flex justify-between items-center p-2 rounded bg-yellow-50 hover:bg-yellow-100 transition-colors">
                        <span class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-yellow-400"></span> 
                            <span class="font-medium">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (0.3-0.5)</span>
                        </span>
                        <span class="font-bold text-yellow-700">
                            <span id="txt-moderate">0</span> ‡πÅ‡∏õ‡∏•‡∏á
                        </span>
                    </div>
                    <div class="flex justify-between items-center p-2 rounded bg-red-50 hover:bg-red-100 transition-colors cursor-pointer"
                         onclick="switchTab('list')">
                        <span class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></span> 
                            <span class="font-medium">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (< 0.3)</span>
                        </span>
                        <span class="font-bold text-red-700 flex items-center gap-1">
                            <span id="txt-risk">0</span> ‡πÅ‡∏õ‡∏•‡∏á
                            <i class="fa-solid fa-chevron-right text-[8px]"></i>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Top Farmers (‡πÉ‡∏´‡∏°‡πà) -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-xs font-bold text-gray-700 flex items-center gap-2">
                        <i class="fa-solid fa-trophy text-yellow-500"></i> 
                        ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢‡∏°‡∏≤‡∏Å‡∏™‡∏∏‡∏î
                    </h4>
                </div>
                <div id="top-farmers" class="space-y-2">
                    <!-- Will be populated by JS -->
                </div>
            </div>

        </div>
    </div>

    <!-- Right Panel: Interactive Map -->
    <div id="view-map" class="hidden lg:block lg:col-span-7 h-full bg-white rounded-2xl shadow-lg border border-gray-100 relative overflow-hidden group">
        <div id="map" class="w-full h-full z-0 bg-slate-100"></div>
        
        <!-- Map Legend -->
        <div class="absolute top-4 right-4 z-[500] bg-white/95 backdrop-blur px-3 py-2 rounded-lg shadow-lg border border-gray-200">
            <span class="text-[10px] font-bold text-gray-700 block mb-2">‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</span>
            <div class="space-y-1.5 text-[10px]">
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-green-500 shadow-sm"></span> 
                    <span class="text-gray-600">‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-yellow-400 shadow-sm"></span> 
                    <span class="text-gray-600">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-orange-500 shadow-sm"></span> 
                    <span class="text-gray-600">‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-red-500 animate-pulse shadow-sm"></span> 
                    <span class="text-red-600 font-semibold">NDVI ‡∏ï‡πà‡∏≥</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-gray-400 shadow-sm"></span> 
                    <span class="text-gray-600">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                </div>
            </div>
        </div>

        <!-- Map Controls -->
        <div class="absolute bottom-4 left-4 z-[500] flex gap-2">
            <button onclick="map.setView([19.1667, 99.9000], 10)" 
                class="bg-white/95 backdrop-blur px-3 py-2 rounded-lg shadow-md hover:bg-white transition-colors text-xs font-semibold text-gray-700"
                aria-label="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà">
                <i class="fa-solid fa-location-crosshairs"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
            </button>
            <button onclick="toggleHeatmap()" 
                class="bg-white/95 backdrop-blur px-3 py-2 rounded-lg shadow-md hover:bg-white transition-colors text-xs font-semibold text-gray-700"
                aria-label="Heatmap">
                <i class="fa-solid fa-fire"></i> 
                <span class="hidden md:inline">Heatmap</span>
            </button>
        </div>
    </div>

    <!-- Mobile View: Watchlist Table -->
    <div id="view-list" class="hidden h-full flex-col bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden lg:hidden">
        <!-- Header -->
        <div class="p-3 border-b border-gray-100 bg-gradient-to-r from-red-50 to-orange-50 flex justify-between items-center">
            <h3 class="font-bold text-red-700 text-sm flex items-center gap-2">
                <i class="fa-solid fa-triangle-exclamation animate-pulse"></i> 
                ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á
            </h3>
            <span class="text-[10px] bg-white text-red-600 px-2 py-1 rounded-full border border-red-200 font-bold shadow-sm" 
                  id="risk-count">
                0 ‡πÅ‡∏õ‡∏•‡∏á
            </span>
        </div>

        <!-- Info Banner -->
        <div class="bg-blue-50 px-3 py-2 text-[10px] text-blue-700 border-b border-blue-100">
            <i class="fa-solid fa-info-circle"></i> 
            ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ NDVI ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 0.3 ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©
        </div>
        
        <!-- Table -->
        <div class="flex-grow overflow-auto custom-scrollbar pb-20">
            <table class="w-full text-sm text-left whitespace-nowrap">
                <thead class="bg-gray-50 text-gray-600 border-b text-[10px] uppercase sticky top-0 z-10 shadow-sm">
                    <tr>
                        <th class="py-3 px-4 font-bold">‡πÅ‡∏õ‡∏•‡∏á</th>
                        <th class="py-3 px-4 text-center font-bold">NDVI</th>
                        <th class="py-3 px-4 text-center font-bold">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</th>
                        <th class="py-3 px-4 text-center font-bold">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</th>
                    </tr>
                </thead>
                <tbody id="riskTableBody" class="divide-y divide-gray-100 text-gray-700 text-xs">
                    <tr>
                        <td colspan="4" class="text-center py-12 text-gray-400">
                            <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                            <p class="text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Mobile Bottom Navigation -->
    <div class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-[1002] lg:hidden flex justify-around items-center h-16 pb-safe">
        <button onclick="switchTab('overview')" id="btn-tab-overview" 
            class="flex flex-col items-center justify-center w-1/3 h-full text-green-600 border-t-2 border-green-600 bg-green-50/50 transition-all"
            aria-label="‡πÅ‡∏ó‡πá‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå">
            <i class="fa-solid fa-chart-pie text-xl mb-1"></i>
            <span class="text-[10px] font-bold">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</span>
        </button>
        <button onclick="switchTab('map')" id="btn-tab-map" 
            class="flex flex-col items-center justify-center w-1/3 h-full text-gray-400 border-t-2 border-transparent transition-all"
            aria-label="‡πÅ‡∏ó‡πá‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà">
            <i class="fa-solid fa-map-location-dot text-xl mb-1"></i>
            <span class="text-[10px] font-bold">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</span>
        </button>
        <button onclick="switchTab('list')" id="btn-tab-list" 
            class="flex flex-col items-center justify-center w-1/3 h-full text-gray-400 border-t-2 border-transparent transition-all relative"
            aria-label="‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á">
            <span class="absolute top-1 right-6 bg-red-500 text-white text-[8px] font-bold px-1.5 py-0.5 rounded-full" 
                id="risk-badge" style="display:none;">0</span>
            <i class="fa-solid fa-triangle-exclamation text-xl mb-1"></i>
            <span class="text-[10px] font-bold">‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á</span>
        </button>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // ==================== CONSTANTS ====================
    const NDVI_THRESHOLDS = { GOOD: 0.5, MODERATE: 0.3, RISK: 0.3 };
    const UPDATE_INTERVAL = 30000;
    const PRICE_ESTIMATE = 12000; // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£ ‡∏ö‡∏≤‡∏ó/‡∏ï‡∏±‡∏ô

    // ==================== GLOBAL STATE ====================
    let globalFields = [];
    let globalSales = [];
    let currentFilter = 'all';
    let updateTimer = null;
    let isUpdating = false;
    let heatmapLayer = null;

    // ==================== MAP INITIALIZATION ====================
    const map = L.map('map', { 
        center: [19.1667, 99.9000], 
        zoom: 10, 
        zoomControl: false 
    });

    const googleHybrid = L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
        maxZoom: 20,
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
    }).addTo(map);

    L.control.zoom({ position: 'bottomright' }).addTo(map);
    const fieldLayer = L.featureGroup().addTo(map);
    let layersMap = {};

    // ==================== CHARTS ====================
    
    // Monthly Yield Chart (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà Balance Chart)
    const monthlyChart = new Chart(document.getElementById('monthlyChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'],
            datasets: [{
                label: '‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï (‡∏ï‡∏±‡∏ô)',
                data: Array(12).fill(0),
                backgroundColor: '#3b82f6',
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { font: { size: 9 }, color: '#6b7280' },
                    grid: { color: '#f3f4f6' }
                },
                x: {
                    ticks: { font: { size: 9 }, color: '#6b7280' },
                    grid: { display: false }
                }
            }
        }
    });

    // Variety Distribution Chart
    const varietyChart = new Chart(document.getElementById('varietyChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: { legend: { display: false } }
        }
    });

    // Price Trend Chart
    const priceTrendChart = new Chart(document.getElementById('priceTrendChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: '‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó/‡∏ï‡∏±‡∏ô)',
                data: [],
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                fill: true,
                tension: 0.4,
                borderWidth: 2,
                pointRadius: 3,
                pointBackgroundColor: '#10b981'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    beginAtZero: false,
                    ticks: { font: { size: 9 }, color: '#6b7280' }
                },
                x: {
                    ticks: { font: { size: 8 }, color: '#6b7280', maxRotation: 45 }
                }
            }
        }
    });

    // ==================== DATA PROCESSING ====================
    
    async function updateData() {
        if (isUpdating) return;
        isUpdating = true;

        try {
            const [fieldsRes, salesRes] = await Promise.all([
                fetch('/api/rice-fields/'),
                fetch('/api/sales/')
            ]);

            globalFields = await fieldsRes.json();
            globalSales = await salesRes.json();

            processData();
            updateTimestamp();

        } catch (error) {
            console.error('Update error:', error);
        } finally {
            isUpdating = false;
        }
    }

    function processData() {
        const filteredFields = currentFilter === 'all' 
            ? globalFields 
            : globalFields.filter(f => f.variety === currentFilter);
        
        const filteredSales = currentFilter === 'all'
            ? globalSales
            : globalSales.filter(s => s.variety === currentFilter);

        let analytics = {
            totalRevenue: 0,
            totalYield: 0,
            soldYield: 0,
            pendingYield: 0,
            totalArea: 0,
            farmers: new Set(),
            health: { good: 0, moderate: 0, risk: 0 },
            riskFields: [],
            priceData: [],
            monthlyYield: Array(12).fill(0),
            varietyData: {},
            salesStatus: { sold: 0, requested: 0, open: 0 },
            topFarmers: {}
        };

        // Process Fields
        filteredFields.forEach(field => {
            const area = parseFloat(field.area_rai || 0);
            const yieldVal = field.latest_yield ? parseFloat(field.latest_yield.yield || 0) : 0;
            const ndvi = field.latest_yield ? parseFloat(field.latest_yield.ndvi || 0) : 0;

            analytics.totalArea += area;
            analytics.totalYield += yieldVal;

            // NDVI Health
            if (ndvi > NDVI_THRESHOLDS.GOOD) analytics.health.good++;
            else if (ndvi >= NDVI_THRESHOLDS.MODERATE) analytics.health.moderate++;
            else {
                analytics.health.risk++;
                analytics.riskFields.push({ ...field, ndvi });
            }
        });

        // Process Sales
        filteredSales.forEach(sale => {
            const qty = parseFloat(sale.quantity_ton || 0);
            const price = parseFloat(sale.price_per_ton || 0);
            const farmer = sale.farmer_name;

            analytics.farmers.add(farmer);

            // Sales Status
            if (sale.status === 'SOLD') {
                analytics.soldYield += qty;
                analytics.totalRevenue += (qty * price);
                analytics.salesStatus.sold++;
                
                if (price > 0) {
                    analytics.priceData.push({ date: new Date(sale.created_at), price });
                }

                // Monthly data
                const month = new Date(sale.created_at).getMonth();
                analytics.monthlyYield[month] += qty;

                // Top Farmers
                analytics.topFarmers[farmer] = (analytics.topFarmers[farmer] || 0) + qty;
            } else if (sale.status === 'REQUESTED') {
                analytics.salesStatus.requested++;
                analytics.pendingYield += qty;
            } else {
                analytics.salesStatus.open++;
                analytics.pendingYield += qty;
            }

            // Variety Distribution
            const variety = sale.variety_display || sale.variety;
            analytics.varietyData[variety] = (analytics.varietyData[variety] || 0) + qty;
        });

        updateKPIs(analytics);
        updateCharts(analytics);
        updateMap(filteredFields, filteredSales);
        updateWatchlist(analytics.riskFields);
        updateTopFarmers(analytics.topFarmers);
    }

    function updateKPIs(analytics) {
        // Revenue (in millions)
        document.getElementById('kpi-revenue').innerText = 
            (analytics.totalRevenue / 1000000).toFixed(2);
        
        document.getElementById('kpi-supply').innerText = analytics.totalYield.toFixed(1);
        document.getElementById('kpi-demand').innerText = analytics.soldYield.toFixed(1);
        document.getElementById('kpi-pending').innerText = analytics.pendingYield.toFixed(1);
        document.getElementById('kpi-farmers').innerText = analytics.farmers.size;
        document.getElementById('kpi-area').innerText = analytics.totalArea.toFixed(0);

        // Sales Status
        document.getElementById('stat-sold').innerText = analytics.salesStatus.sold;
        document.getElementById('stat-requested').innerText = analytics.salesStatus.requested;
        document.getElementById('stat-open').innerText = analytics.salesStatus.open;

        // Health
        document.getElementById('txt-healthy').innerText = analytics.health.good;
        document.getElementById('txt-moderate').innerText = analytics.health.moderate;
        document.getElementById('txt-risk').innerText = analytics.health.risk;

        // Risk Badge
        const riskBadge = document.getElementById('risk-badge');
        if (analytics.health.risk > 0) {
            riskBadge.innerText = analytics.health.risk;
            riskBadge.style.display = 'block';
        } else {
            riskBadge.style.display = 'none';
        }
    }

    function updateCharts(analytics) {
        // Monthly Yield
        monthlyChart.data.datasets[0].data = analytics.monthlyYield;
        monthlyChart.update('none');

        // Variety Distribution
        const sortedVarieties = Object.entries(analytics.varietyData)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);

        varietyChart.data.labels = sortedVarieties.map(([k]) => k);
        varietyChart.data.datasets[0].data = sortedVarieties.map(([, v]) => v);
        varietyChart.update('none');

        document.getElementById('total-yield').innerText = analytics.totalYield.toFixed(1);

        // Legend
        const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
        document.getElementById('variety-legend').innerHTML = sortedVarieties.map(([k, v], i) => `
            <div class="flex justify-between items-center p-1.5 rounded hover:bg-gray-50">
                <span class="flex items-center gap-1.5">
                    <span class="w-3 h-3 rounded-full" style="background:${colors[i]}"></span>
                    <span class="text-gray-700">${k}</span>
                </span>
                <span class="font-bold text-gray-800">${v.toFixed(1)}</span>
            </div>
        `).join('');

        // Price Trend
        analytics.priceData.sort((a, b) => a.date - b.date);
        const recentPrices = analytics.priceData.slice(-15);

        if (recentPrices.length > 0) {
            priceTrendChart.data.labels = recentPrices.map(p => 
                p.date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' })
            );
            priceTrendChart.data.datasets[0].data = recentPrices.map(p => p.price);
            priceTrendChart.update('none');

            const prices = recentPrices.map(p => p.price);
            const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;
            const maxPrice = Math.max(...prices);
            const minPrice = Math.min(...prices);

            document.getElementById('avg-price').innerText = avgPrice.toFixed(0) + ' ‡∏ö./‡∏ï‡∏±‡∏ô';
            document.getElementById('max-price').innerText = maxPrice.toLocaleString();
            document.getElementById('min-price').innerText = minPrice.toLocaleString();
        }
    }

    function updateTopFarmers(farmers) {
        const sorted = Object.entries(farmers)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);

        document.getElementById('top-farmers').innerHTML = sorted.map(([name, qty], i) => `
            <div class="flex items-center justify-between p-2 rounded ${i === 0 ? 'bg-yellow-50 border border-yellow-100' : 'bg-gray-50'}">
                <div class="flex items-center gap-2">
                    <span class="flex items-center justify-center w-6 h-6 rounded-full ${
                        i === 0 ? 'bg-yellow-500 text-white' : 
                        i === 1 ? 'bg-gray-400 text-white' : 
                        i === 2 ? 'bg-orange-600 text-white' : 'bg-gray-200 text-gray-600'
                    } text-xs font-bold">
                        ${i + 1}
                    </span>
                    <span class="font-medium text-gray-700">${name}</span>
                </div>
                <span class="font-bold text-blue-600">${qty.toFixed(1)} ‡∏ï‡∏±‡∏ô</span>
            </div>
        `).join('');
    }

    // ==================== MAP FUNCTIONS ====================
    
    function updateMap(fields, sales) {
        fieldLayer.clearLayers();
        layersMap = {};

        const salesMap = {};
        sales.forEach(s => {
            if (!salesMap[s.rice_field] || new Date(salesMap[s.rice_field].created_at) < new Date(s.created_at)) {
                salesMap[s.rice_field] = s;
            }
        });

        fields.forEach(field => {
            if (!field.boundary) return;

            try {
                const geo = JSON.parse(field.boundary);
                const ndvi = field.latest_yield ? parseFloat(field.latest_yield.ndvi || 0) : 0;
                const sale = salesMap[field.id];

                let color, fillOpacity, weight;
                
                // Priority: NDVI Risk > Sale Status
                if (ndvi < NDVI_THRESHOLDS.RISK) {
                    color = '#ef4444';
                    fillOpacity = 0.6;
                    weight = 2;
                } else if (sale && sale.status === 'SOLD') {
                    color = '#22c55e';
                    fillOpacity = 0.5;
                    weight = 1;
                } else if (sale && sale.status === 'REQUESTED') {
                    color = '#fbbf24';
                    fillOpacity = 0.6;
                    weight = 2;
                } else if (sale && sale.status === 'OPEN') {
                    color = '#f59e0b';
                    fillOpacity = 0.5;
                    weight = 1;
                } else {
                    color = '#94a3b8';
                    fillOpacity = 0.3;
                    weight = 1;
                }

                const layer = L.geoJSON(geo, {
                    style: { color, weight, fillOpacity }
                }).bindPopup(`
                    <div class="p-3 min-w-[180px]">
                        <h4 class="font-bold text-gray-800 mb-2">${field.name}</h4>
                        <div class="space-y-1 text-xs">
                            <div class="flex justify-between">
                                <span class="text-gray-500">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà:</span>
                                <span class="font-semibold">${field.area_rai} ‡πÑ‡∏£‡πà</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">NDVI:</span>
                                <span class="font-semibold ${
                                    ndvi > NDVI_THRESHOLDS.GOOD ? 'text-green-600' : 
                                    ndvi >= NDVI_THRESHOLDS.MODERATE ? 'text-yellow-600' : 
                                    'text-red-600'
                                }">${ndvi.toFixed(2)}</span>
                            </div>
                            ${sale ? `
                                <hr class="my-1">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
                                    <span class="font-semibold">${
                                        sale.status === 'SOLD' ? '‚úÖ ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : 
                                        sale.status === 'REQUESTED' ? '‚è≥ ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : 
                                        'üîî ‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢'
                                    }</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).addTo(fieldLayer);

                layersMap[field.id] = layer;

            } catch (e) {
                console.warn('Failed to parse boundary:', e);
            }
        });
    }

    // ==================== UTILITY FUNCTIONS ====================
    
    function switchTab(tab) {
        const views = { overview: 'view-overview', map: 'view-map', list: 'view-list' };
        const btns = { overview: 'btn-tab-overview', map: 'btn-tab-map', list: 'btn-tab-list' };
        
        const isMobile = window.innerWidth < 1024;

        if (isMobile) {
            Object.keys(views).forEach(k => {
                document.getElementById(views[k]).classList.toggle('hidden', k !== tab);
            });

            Object.keys(btns).forEach(k => {
                const btn = document.getElementById(btns[k]);
                if (k === tab) {
                    btn.className = "flex flex-col items-center justify-center w-1/3 h-full text-green-600 border-t-2 border-green-600 bg-green-50/50 transition-all relative";
                } else {
                    btn.className = "flex flex-col items-center justify-center w-1/3 h-full text-gray-400 border-t-2 border-transparent transition-all";
                }
            });
        } else {
            // Desktop: Always show overview and map
            document.getElementById('view-overview').classList.remove('hidden');
            document.getElementById('view-map').classList.remove('hidden');
            document.getElementById('view-list').classList.add('hidden');
        }

        if (tab === 'map') {
            setTimeout(() => map.invalidateSize(), 100);
        }
    }

    function applyFilter() {
        currentFilter = document.getElementById('filter-variety').value;
        processData();
    }

    function forceUpdate() {
        if (isUpdating) return;
        document.getElementById('refresh-icon').classList.add('fa-spin');
        updateData().finally(() => {
            document.getElementById('refresh-icon').classList.remove('fa-spin');
        });
    }

    function updateTimestamp() {
        document.getElementById('last-update').innerText = new Date().toLocaleTimeString('th-TH', {
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    window.focusField = function(fieldId) {
        if (window.innerWidth < 1024) switchTab('map');
        const layer = layersMap[fieldId];
        if (layer) {
            map.invalidateSize();
            setTimeout(() => {
                map.flyToBounds(layer.getBounds(), { padding: [50, 50], maxZoom: 16, duration: 1.5 });
                setTimeout(() => layer.openPopup(), 1600);
            }, 100);
        }
    }

    function updateWatchlist(riskFields) {
        const tbody = document.getElementById('riskTableBody');
        document.getElementById('risk-count').innerText = `${riskFields.length} ‡πÅ‡∏õ‡∏•‡∏á`;

        if (riskFields.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center py-12">
                        <i class="fa-solid fa-check-circle text-4xl text-green-500 mb-2"></i>
                        <p class="text-sm font-semibold text-green-600">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</p>
                    </td>
                </tr>`;
        } else {
            tbody.innerHTML = riskFields.map(f => `
                <tr class="hover:bg-red-50 cursor-pointer" onclick="focusField(${f.id})">
                    <td class="py-3 px-4">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-location-dot text-red-500"></i>
                            <span class="font-medium">${f.name}</span>
                        </div>
                    </td>
                    <td class="py-3 px-4 text-center font-mono font-bold text-red-600">${f.ndvi.toFixed(2)}</td>
                    <td class="py-3 px-4 text-center">${f.area_rai} ‡πÑ‡∏£‡πà</td>
                    <td class="py-3 px-4 text-center">
                        <button class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded-full text-xs font-semibold">
                            <i class="fa-solid fa-map-location-dot"></i> ‡∏î‡∏π‡∏û‡∏¥‡∏Å‡∏±‡∏î
                        </button>
                    </td>
                </tr>
            `).join('');
        }
    }

    function showNDVIInfo() {
        Swal.fire({
            title: '‡∏Ñ‡πà‡∏≤ NDVI ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?',
            html: `
                <div class="text-left text-sm space-y-2">
                    <p><strong>NDVI (Normalized Difference Vegetation Index)</strong> ‡∏Ñ‡∏∑‡∏≠‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏û‡∏∑‡∏ä</p>
                    <hr>
                    <div class="space-y-1">
                        <p class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-green-500"></span>
                            <strong>NDVI > 0.5:</strong> ‡∏û‡∏∑‡∏ä‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏î‡∏µ
                        </p>
                        <p class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-yellow-400"></span>
                            <strong>NDVI 0.3-0.5:</strong> ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á
                        </p>
                        <p class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-red-500"></span>
                            <strong>NDVI < 0.3:</strong> ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á
                        </p>
                    </div>
                </div>
            `,
            icon: 'info',
            confirmButtonColor: '#3b82f6'
        });
    }

    function showVarietyInfo() {
        Swal.fire({
            title: '‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏Ç‡πâ‡∏≤‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö',
            html: `
                <div class="text-left text-sm space-y-2">
                    <p>üçö <strong>‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥ 105:</strong> ‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á</p>
                    <p>üçô <strong>‡∏Å‡∏Ç 6:</strong> ‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏î‡∏µ</p>
                    <p>üåæ <strong>‡∏Å‡∏Ç 15:</strong> ‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏≠‡∏°‡∏°‡∏∞‡∏•‡∏¥ ‡∏Å‡∏Ç 15</p>
                    <p>üåø <strong>‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ:</strong> ‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</p>
                </div>
            `,
            icon: 'info',
            confirmButtonColor: '#3b82f6'
        });
    }

    function exportData() {
        const csv = "\uFEFF" + 
            "‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå,‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï(‡∏ï‡∏±‡∏ô),‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß(‡∏ï‡∏±‡∏ô),‡∏£‡∏≠‡∏Ç‡∏≤‡∏¢(‡∏ï‡∏±‡∏ô),‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£(‡∏£‡∏≤‡∏¢)\n" +
            Object.entries(analytics.varietyData || {}).map(([v, qty]) => 
                `"${v}",${qty},0,0,0`
            ).join('\n');

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `government_report_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();

        Swal.fire({
            icon: 'success',
            title: '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
            timer: 1500,
            showConfirmButton: false
        });
    }

    function toggleHeatmap() {
        Swal.fire({
            icon: 'info',
            title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤',
            text: '‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå Heatmap ‡∏à‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ'
        });
    }

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', function() {
        updateData();
        updateTimer = setInterval(updateData, UPDATE_INTERVAL);

        if (window.innerWidth >= 1024) {
            document.getElementById('view-overview').classList.remove('hidden');
            document.getElementById('view-map').classList.remove('hidden');
            setTimeout(() => map.invalidateSize(), 300);
        }
    });

    window.addEventListener('resize', () => {
        setTimeout(() => {
            map.invalidateSize();
            if (window.innerWidth >= 1024) {
                document.getElementById('view-overview').classList.remove('hidden');
                document.getElementById('view-map').classList.remove('hidden');
                document.getElementById('view-list').classList.add('hidden');
            }
        }, 250);
    });

    window.addEventListener('beforeunload', () => {
        if (updateTimer) clearInterval(updateTimer);
    });

</script>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    .leaflet-popup-content-wrapper { padding: 0; border-radius: 8px; }
    .leaflet-popup-content { margin: 0; }
    
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .fa-spin { animation: spin 1s linear infinite; }
    
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    
    .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
</style>
{% endblock %}